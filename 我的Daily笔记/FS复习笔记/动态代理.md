## ç»“æ„å‹æ¨¡å¼

### âš¡ğŸŸ ä»£ç†

> éœ€è¦å¢åŠ é¢å¤–çš„å†…å®¹,æŠŠé¢å¤–å†…å®¹æ”¾åœ¨ä»£ç†é‡Œ.æ¯”å¦‚"å¼€å¯äº‹åŠ¡" "æäº¤äº‹åŠ¡" "æ“ä½œæ—¥å¿—"

![image-20230907085827998](.\assets\image-20230907085827998.png)

ä»£ç†æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥å…è®¸æˆ‘ä»¬ç”Ÿæˆå¯¹è±¡çš„æ›¿ä»£å“ã€‚ä»£ç†æ§åˆ¶ç€å¯¹äºåŸå¯¹è±¡çš„è®¿é—®ï¼ŒåŒæ—¶ä¹Ÿå…è®¸åœ¨åŸå¯¹è±¡çš„æ–¹æ³•ä¹‹å‰ååšä¸€äº›å¤„ç†ï¼Œä¾¿å¯ä»¥å®ç°åœ¨åŸæ–¹æ³•æ‰§è¡Œå‰åéƒ½ä¼šæ‰§è¡ŒæŸæ®µä»£ç é€»è¾‘çš„åŠŸèƒ½ã€‚è¿™ä¸ªä¹Ÿæ˜¯**é¢å‘åˆ‡é¢ç¼–ç¨‹**çš„æŒ‡å¯¼æ€æƒ³ã€‚
ä»£ç†æ¨¡å¼åœ¨æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ç”¨å¤„è¿˜æ˜¯ç›¸å½“å¹¿æ³›çš„ï¼Œæ¯”å¦‚**æµ·å¤–è´­ç½‘ç«™**å°±æ˜¯ä¸€ä¸ªä»£ç†ã€‚æµ·å¤–è´­ç½‘ç«™è´Ÿè´£ä»£ç†ç”¨æˆ·åˆ°å›½å¤–çš„ç”µå•†ç½‘ç«™å»ä¸‹å•è´­ä¹°å•†å“ï¼Œä¹Ÿå¯ä»¥åœ¨å•†å“é€è¾¾åˆ°æµ·å¤–è´­ç½‘ç«™æ—¶ï¼Œå†æ‰§è¡Œè¿›ä¸€æ­¥åŠ å›ºæ“ä½œï¼Œå†æ¬¡è½¬é€ç»™ç”¨æˆ·ã€‚
ä»£ç†æ¨¡å¼åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„åº”ç”¨åœºæ™¯ä¹Ÿéå¸¸å¸¸è§ã€‚åœ¨å®¢æˆ·ç«¯ä»¥åŠå®¢æˆ·ç«¯è®¿é—®çš„ç›®æ ‡ç±»å¯¹è±¡ä¸­é—´ï¼Œé¢å¤–å†å¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹ä»£ç†ç±»å¯¹è±¡ã€‚å¦‚æœç›´æ¥è®¿é—®ç›®æ ‡ç±»å¯¹è±¡ï¼Œå°±æ˜¯æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ï¼›å¦‚æœå®¢æˆ·ç«¯è®¿é—®çš„æ˜¯ä»£ç†ç±»å¯¹è±¡ï¼Œé‚£ä¹ˆä¸ä»…å¯ä»¥è®¿é—®å¯¹åº”çš„æ–¹æ³•ï¼Œè¿˜ä¼šåœ¨æ–¹æ³•çš„æ‰§è¡Œå‰åæ‰§è¡Œå¯¹åº”çš„**å‰ç½®ã€åç½®é€šçŸ¥**ã€‚

![image-20230907085851936](.\assets\image-20230907085851936.png)

#### é™æ€ä»£ç†

```java
public interface UserService {
    void insert();
}
```

```java
public class UserServiceImpl implements UserService {
    @Override
    public void insert() {
        System.out.println("ç›®æ ‡ç±»æ‰§è¡Œäº†insertæ–¹æ³•");
    }
}
```

```java
public class UserServiceProxy implements UserService {

    UserService target;

    public UserServiceProxy(UserService target) {
        //æ³¨å…¥å§”æ‰˜ç±»å¯¹è±¡
        this.target = target;
    }

    @Override
    public void insert() {
        System.out.println("ä»£ç†ä¹‹å‰æ‰“å°ä¸€ä¸ªæ—¥å¿—");
        target.insert();
        System.out.println("ä»£ç†ä¹‹åæ‰“å°ä¸€ä¸ªæ—¥å¿—");
    }
}
```

```java
@Test
    public void test1(){
        UserServiceProxy proxy = new UserServiceProxy(new UserServiceImpl());
        proxy.insert();
    }
```

æ³¨æ„å›é¡¾é™æ€ä»£ç†çš„ä¼˜åŒ–è¿‡ç¨‹

![Day12-ä»£ç†æ¢³ç†](.\assets\Day12-ä»£ç†æ¢³ç†.jpg)

ä»£ç†æ¨¡å¼æœ€å¤§çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥ä¸æ›´æ”¹ç›®æ ‡ç±»ä»£ç çš„å‰æä¸‹ï¼Œæ‰©å±•ç›®æ ‡ç±»ä»£ç çš„åŠŸèƒ½ã€‚

é™æ€ä»£ç†æœ€å¤§çš„ç¼ºç‚¹åœ¨äºä»£ç è¾ƒä¸ºå†—ä½™ï¼Œæ¯ä»£ç†ä¸€ä¸ªç±»ï¼Œä¾¿è¦æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªä»£ç†ç±»ï¼›ä»£ç†å¯¹è±¡å’Œç›®æ ‡ç±»å¯¹è±¡å‡å®ç°äº†æ¥å£ï¼Œå¦‚æœæ¥å£å‘ç”Ÿäº†ä¿®æ”¹ï¼Œä¸ä»…ç›®æ ‡ç±»éœ€è¦æ›´æ”¹ï¼Œä»£ç†ç±»ä¹Ÿéœ€è¦åŒæ­¥å‘ç”Ÿä¿®æ”¹ï¼Œç»´æŠ¤æˆæœ¬å˜é«˜äº†å¾ˆå¤šã€‚



#### JDKåŠ¨æ€ä»£ç†

![image-20230908093348453](.\assets\image-20230908093348453.png)

ä»£ç†ç±»å®ç°å’Œå§”æ‰˜ç±»ç›¸åŒçš„æ¥å£ã€‚
å§”æ‰˜ç±»å’Œä»£ç†ç±»æ˜¯å…„å¼Ÿå…³ç³»ã€‚ä½¿ç”¨ç›¸åŒçš„æ¥å£æ¥æ¥æ”¶ã€‚

> é™æ€ä»£ç†ï¼Œé¡¾åæ€ä¹‰ï¼Œä¾¿æ˜¯åœ¨ç¼–è¯‘æ—¶ï¼Œå°±å·²ç»å®é™…å­˜åœ¨äº†è¯¥`class`æ–‡ä»¶ï¼›è€ŒåŠ¨æ€ä»£ç†ï¼Œåœ¨ç¼–è¯‘æ—¶æœŸï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨è¯¥`class`æ–‡ä»¶ï¼Œè€Œæ˜¯ç¨‹åºåœ¨è¿è¡Œé˜¶æ®µåŠ¨æ€ç”Ÿæˆäº†å­—èŠ‚ç ã€‚
> `JDK`åŠ¨æ€ä»£ç†ï¼Œå³`JDK`ç»™æˆ‘ä»¬æä¾›çš„åŠ¨æ€ç”Ÿæˆä»£ç†ç±»çš„æ–¹å¼ï¼Œæ— éœ€å¼•å…¥ç¬¬ä¸‰æ–¹`jar`åŒ…ã€‚ä½†æ˜¯ä½¿ç”¨`JDK`åŠ¨æ€ä»£ç†æœ‰ä¸€ä¸ª**å…ˆå†³æ¡ä»¶**ï¼Œé‚£å°±æ˜¯ç›®æ ‡ç±»å¯¹è±¡å¿…é¡»å®ç°äº†æŸä¸ªæ¥å£ï¼›å¦‚æœç›®æ ‡ç±»å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œåˆ™`JDK`åŠ¨æ€ä»£ç†æ— æ³•ä½¿ç”¨ã€‚

å¦‚æœä½¿ç”¨`JDK`æä¾›çš„åŠ¨æ€ä»£ç†ï¼Œé‚£ä¹ˆéœ€è¦å€ŸåŠ©å¦‚ä¸‹å‡ ä¸ªç±»

- `java.lang.reflect.Proxy`

  | API                                                          | å‚æ•°                                                         | è¿”å›å€¼                                                       |
  | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | public `static`  Object `newProxyInstance`(ClassLoader loader, Class<?>[] interfaces, InvocationHandler h) | `loader`è¡¨ç¤ºç›®æ ‡ç±»ä½¿ç”¨çš„ç±»åŠ è½½å™¨ï¼›`interfaces`è¡¨ç¤ºç›®æ ‡ç±»æ‰€å®ç°çš„æ¥å£ç±»å‹ï¼›`h`è¡¨ç¤ºå¤„ç†å™¨ï¼Œç”¨æ¥è§„å®šä»£ç†çš„å†…éƒ¨ç»†èŠ‚ | è¿”å›ä¸€ä¸ªå®ç°æŒ‡å®šæ¥å£çš„ä»£ç†ç±»å®ä¾‹å¯¹è±¡ï¼›ä»£ç†ç±»å¯¹è±¡å’Œç›®æ ‡ç±»å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£ç±»å‹ |

- `java.lang.reflect.InvocationHandler`

  | API                                                          | å‚æ•°                                                         | è¿”å›å€¼                             |
  | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------------------- |
  | public Object invoke(Object proxy, Method method, Object[] args) | `proxy`è¡¨ç¤ºJDKå¸®åŠ©å¼€å‘è€…ç”Ÿæˆçš„ä»£ç†ç±»å¯¹è±¡ï¼Œè¿™ä¸ªå‚æ•°ä¸€èˆ¬ä¸ç”¨ç†ä¼šï¼›`method`è¡¨ç¤ºçš„æ˜¯ç›®æ ‡ç±»ä¸­çš„æ–¹æ³•ï¼›`args`è¡¨ç¤ºæ‰§è¡Œç›®æ ‡ç±»æ–¹æ³•æ—¶ä¼ é€’çš„å‚æ•°ï¼›ä¸‰ä¸ªå‚æ•°åˆåœ¨ä¸€èµ·è¡¨ç¤ºçš„å«ä¹‰è¡¨ç¤ºä»£ç†ç±»å¦‚ä½•æ¥ä»£ç†ã€å¢å¼ºç›®æ ‡ç±»é‡Œé¢çš„æ–¹æ³• | ä»£ç†ç±»æ‰§è¡Œå®Œå¯¹åº”çš„æ–¹æ³•æ—¶å®ƒçš„è¿”å›å€¼ |

```java
public class ProxyFactory {

    Object target;

    public ProxyFactory(Object target) {
        this.target = target;
    }

    public Object newProxyInstance(){
        return Proxy.newProxyInstance(target.getClass().getClassLoader(),
                target.getClass().getInterfaces(),
                new InvocationHandler() {
                    
                    //ä»£ç†ç±»å¦‚ä½•ä»£ç†
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        System.out.println("ä»£ç†ä¹‹å‰ç­¾è®¢åˆçº¦");
                        Object invoke = method.invoke(target, args);
                        System.out.println("ä»£ç†å®Œæ¯•è½¬è´¦ç¡®è®¤");
                        return invoke;
                    }
                });
    }
}
```

```java
@Test
    public void test2(){
        UserService userService = new UserServiceImpl();
        //å¯¹å“ªä¸ªç›®æ ‡ç±»è¿›è¡Œä»£ç†ï¼Œæˆ‘ä»¬å¯¹UserServiceImplè¿›è¡Œä»£ç†
        //ç”Ÿæˆä»£ç†ç±»å¯¹è±¡
        UserService userServiceProxy = Proxy.newProxyInstance(target.getClass().getClassLoader(),
                target.getClass().getInterfaces(),
                new InvocationHandler() {
                    
                    //ä»£ç†ç±»å¦‚ä½•ä»£ç†
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        System.out.println("ä»£ç†ä¹‹å‰ç­¾è®¢åˆçº¦");
                        Object invoke = method.invoke(userService, args);
                        System.out.println("ä»£ç†å®Œæ¯•è½¬è´¦ç¡®è®¤");
                        return invoke;
                    }
                });
        //ä»£ç†ç±»å¯¹è±¡æ‰§è¡Œinsertæ–¹æ³•ï¼Œä»€ä¹ˆé€»è¾‘å‘¢ï¼Ÿä¸»è¦æ˜¯invokeé‡Œé¢çš„ä»£ç é€»è¾‘
        userServiceProxy.insert();
    }
```



åˆ©ç”¨çº¿ä¸Šç›‘æµ‹å·¥å…·ä»¥åŠåç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ä»£ç†ç±»å¯¹è±¡æºç 

```java
public final class $Proxy0
extends Proxy
implements UserService {
    private static Method m1;
    private static Method m3;
    private static Method m2;
    private static Method m0;

    public $Proxy0(InvocationHandler invocationHandler) {
        super(invocationHandler);
    }

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));
            m3 = Class.forName("com.cskaoyan.pattern.proxy.UserService").getMethod("insert", new Class[0]);
            m2 = Class.forName("java.lang.Object").getMethod("toString", new Class[0]);
            m0 = Class.forName("java.lang.Object").getMethod("hashCode", new Class[0]);
            return;
        }
        catch (NoSuchMethodException noSuchMethodException) {
            throw new NoSuchMethodError(noSuchMethodException.getMessage());
        }
        catch (ClassNotFoundException classNotFoundException) {
            throw new NoClassDefFoundError(classNotFoundException.getMessage());
        }
    }

    public final boolean equals(Object object) {
        try {
            return (Boolean)this.h.invoke(this, m1, new Object[]{object});
        }
        catch (Error | RuntimeException throwable) {
            throw throwable;
        }
        catch (Throwable throwable) {
            throw new UndeclaredThrowableException(throwable);
        }
    }

    public final String toString() {
        try {
            return (String)this.h.invoke(this, m2, null);
        }
        catch (Error | RuntimeException throwable) {
            throw throwable;
        }
        catch (Throwable throwable) {
            throw new UndeclaredThrowableException(throwable);
        }
    }

    public final int hashCode() {
        try {
            return (Integer)this.h.invoke(this, m0, null);
        }
        catch (Error | RuntimeException throwable) {
            throw throwable;
        }
        catch (Throwable throwable) {
            throw new UndeclaredThrowableException(throwable);
        }
    }
	//ä¸»è¦å…³æ³¨insertæ–¹æ³•
    public final void insert() {
        try {
            this.h.invoke(this, m3, null);
            return;
        }
        catch (Error | RuntimeException throwable) {
            throw throwable;
        }
        catch (Throwable throwable) {
            throw new UndeclaredThrowableException(throwable);
        }
    }
}
```

#### CGlibåŠ¨æ€ä»£ç†

å§”æ‰˜ç±»æ˜¯ä»£ç†ç±»çš„çˆ¶ç±»ï¼Œä¹Ÿå¯ä»¥è®©ä»£ç†ç±»å’Œå§”æ‰˜ç±»çš„â€œå¤–è§‚ä¸€è‡´â€ã€‚

![image-20230908093640850](.\assets\image-20230908093640850.png)

`Cglib`(`Code Generation Library`)æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ï¼Œé«˜æ€§èƒ½ï¼Œé«˜è´¨é‡çš„`Code`ç”Ÿæˆç±»åº“ï¼Œå®ƒå¯ä»¥åœ¨**è¿è¡ŒæœŸ**æ‰©å±•`Java`ç±»ä¸å®ç°`Java`æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥å€ŸåŠ©äº`Cglib`æ¥å¸®åŠ©æˆ‘ä»¬åŠ¨æ€åœ°ç”Ÿæˆä»£ç†ç±»å¯¹è±¡ã€‚`Cglib`å¯ä»¥å¼¥è¡¥`JDK`åŠ¨æ€ä»£ç†çš„ä¸è¶³ï¼Œ`JDK`è¦æ±‚ç›®æ ‡ç±»å¿…é¡»å®ç°äº†æŸä¸ªæ¥å£ï¼Œæ‰å¯ä»¥æ‰§è¡Œä»£ç†åŠŸèƒ½ï¼›è€Œ`Cglib`å¯¹æ­¤æ— ä»»ä½•è¦æ±‚ï¼Œ**ä¸»è¦åŸå› åœ¨äº`Cglib`æ‰©å±•çš„ä»£ç†ç±»ä¼šç»§æ‰¿è‡ªç›®æ ‡ç±»**ã€‚**æ‰€ä»¥è¿™ä¹Ÿè¦æ±‚æˆ‘ä»¬çš„ç›®æ ‡ç±»ä¸èƒ½æ˜¯`final`ä¿®é¥°**ã€‚

ä½¿ç”¨`Cglib`æ¶‰åŠåˆ°çš„ç›¸å…³ç±»å¦‚ä¸‹

- `net.sf.cglib.proxy.Enhancer`

  | API                                  | å‚æ•°                                                         | è¿”å›å€¼/è¯´æ˜                                                  |
  | ------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | enhancer.`setSuperclass(superClass)` | çˆ¶ç±»çš„å­—èŠ‚ç å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ç±»                         | æ— è¿”å›å€¼;Cglibäº§ç”Ÿçš„ä»£ç†ç±»ä¼šç»§æ‰¿ç›®æ ‡ç±»ï¼Œæ‰€ä»¥æ­¤å¤„è®¾ç½®çš„çˆ¶ç±»ä¹Ÿå°±æ˜¯ç›®æ ‡ç±» |
  | enhancer.`setCallBack(callback)`     | è®¾ç½®ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä»£ç†ç±»å¯¹è±¡å¦‚ä½•ä»£ç†ç›®æ ‡å¯¹è±¡éœ€è¦åœ¨å›è°ƒå‡½æ•°ä¸­åˆ¶å®šç­–ç•¥ | CallBackæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒMethodInterceptoræ˜¯ä¸€ä¸ªå­æ¥å£ã€‚æˆ‘ä»¬é€‰ç”¨è¯¥ç±»æ¥è®¾ç½®å›è°ƒç­–ç•¥ |
  | enhancer.`create()`                  | -                                                            | ç”Ÿæˆä»£ç†ç±»å¯¹è±¡                                               |

- `net.sf.cglib.proxy.MethodInterceptor`

  | API                                                          | å‚æ•°                                                         | è¿”å›å€¼/è¯´æ˜                                    |
  | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------------------------------- |
  | public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) | ç¬¬ä¸€ä¸ªå‚æ•°objä¸ºä»£ç†ç±»å¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°ä¸ºç›®æ ‡ç±»å¯¹åº”ä¸­å¯¹åº”çš„æ–¹æ³•ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºç›®æ ‡ç±»å¯¹è±¡ä¸­å¯¹åº”çš„æ–¹æ³•æ‰§è¡Œæ—¶ä¼ é€’çš„å‚æ•°ï¼›ç¬¬å››ä¸ªå‚æ•°æ˜¯ä»£ç†ç±»å¯¹è±¡ä¸­çš„å¯¹åº”æ–¹æ³• | è¿”å›å€¼ä¸€èˆ¬ä¾¿å°†ä»£ç†ç±»å¯¹è±¡å¯¹åº”æ–¹æ³•çš„æ‰§è¡Œç»“æœè¿”å› |



ä½¿ç”¨Cglibéœ€è¦å¯¼åŒ…

```xml
<dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib</artifactId>
    <version>3.3.0</version>
</dependency>
```

åˆ›å»ºä¸€ä¸ªç›®æ ‡ç±»ï¼Œåœ¨è¿™é‡Œä¸ºäº†ä½“ç°Cglibçš„æ•ˆæœï¼Œç›®æ ‡ç±»æ²¡æœ‰å®ç°ä»»ä½•æ¥å£

```java
public class UserServiceImpl {

    public String getName(){
        System.out.println("ç›®æ ‡æ–¹æ³•æ‰§è¡Œ");
        return "zhangsan";
    }
}
```

ç¼–å†™æµ‹è¯•ä»£ç 

```java
public class ProxyTest {

    public static void main(String[] args) {
        UserServiceImpl userService = new UserServiceImpl();

        UserServiceImpl userServiceProxy = Enhancer.create(UserServiceImpl.class,new InvocationHandler() {

            //ä»£ç†ç±»å¦‚ä½•ä»£ç†
            @Override
            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                System.out.println("ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰");
                Object invoke = method.invoke(userService, args);
                System.out.println("ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å");
                return invoke;
            }
        });
        String name = userServiceProxy.getName();
        System.out.println(name);
    }
}
```

åŠ¨æ€ä»£ç†å’Œæ³¨è§£ç»“åˆã€‚

