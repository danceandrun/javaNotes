[TOC]

# å‰è¨€

## å­¦ä¹ ç›®æ ‡

1. ç†è§£AOPçš„è®¾è®¡æ€æƒ³
2. æŒæ¡åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼ˆ`execution`ã€`@annotation`ã€`@target`ï¼‰
3. æŒæ¡å‡ ç§é€šçŸ¥çš„æ‰§è¡Œæ—¶é—´
4. ç†Ÿæ‚‰AspectJçš„ä½¿ç”¨ğŸŒŸğŸŒŸğŸŒŸ

## å‰ç½®çŸ¥è¯†å‡†å¤‡

- `IOC`å’Œ`DI`
- Springç”Ÿå‘½å‘¨æœŸçš„`BeanPostProcessor`
- åŠ¨æ€ä»£ç†

> åŠ¨æ€ä»£ç†
>
> å§”æ‰˜ç±»å¯¹è±¡ï¼š åŠŸèƒ½ä¸å¤Ÿéœ€è¦å¢å¼ºï¼Œæˆ–è€…æœ‰å¤ªå¤šæ–¹æ³•æ˜¯é€šç”¨çš„éœ€è¦ç®€åŒ–
>
> é€šè¿‡JDKåŠ¨æ€ä»£ç†ï¼ŒCGlibåŠ¨æ€ä»£ç†å®ç°åŠ¨æ€ä»£ç†
>
> ä»£ç†å¯¹è±¡ï¼šä¸¤ç§æ–¹å¼å’Œå§”æ‰˜ç±»å¯¹è±¡çš„å…³ç³»ï¼Œå¤šäº†é¢å¤–çš„ä¸œè¥¿ï¼Œæ˜¯`InvocationHandler`ä¸­çš„`invoke`æ–¹æ³•

## æˆ‘çš„AOPåº”ç”¨ç¬”è®°

+ äº‹åŠ¡ç®¡ç†
+ å•†å“é¡µè¯¦æƒ…ä¼˜åŒ–æ—¶ï¼ŒAOPå¢å¼ºï¼Œåœ¨å‘æ•°æ®åº“ä¸­å–æ•°æ®å‰æŸ¥è¯¢Redisï¼Œå–æ•°æ®ä¹‹åæ”¾å…¥Redisä¸­



#  ä»‹ç»AOP

`Aspect Oriented Programming`

åœ¨è½¯ä»¶ä¸šï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæ˜¯æŒ‡é€šè¿‡**é¢„ç¼–è¯‘**æ–¹å¼å’Œè¿è¡ŒæœŸ**åŠ¨æ€ä»£ç†**å®ç°ç¨‹åºåŠŸèƒ½çš„**ç»Ÿä¸€ç»´æŠ¤**çš„ä¸€ç§æŠ€æœ¯ã€‚

`AOP`æ˜¯`OOP`ï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰çš„å»¶ç»­ï¼Œæ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿæ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ã€‚

> `AOP`ä¸­çš„å¯¹è±¡å˜æˆäº†ä»£ç†å¯¹è±¡

åˆ©ç”¨`AOP`å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œ**éš”ç¦»**ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„**è€¦åˆåº¦é™ä½**ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚ 

## AOPå’ŒOOP

OOP é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæ˜¯Object Oriented Programmingçš„ç®€ç§°

OOPï¼šé€šè¿‡ç»§æ‰¿æ¥å¢å¼º

AOPï¼šé€šè¿‡åˆ‡é¢æ¥å¢å¼º

AOPå…³å¿ƒä¸¤ç‚¹ï¼š

1. å®¹å™¨ä¸­å“ªäº›ç»„ä»¶åšäº†å¢å¼ºï¼Ÿ
2. åšäº†ä»€ä¹ˆæ ·çš„å¢å¼ºï¼Ÿ

## AOPç‰¹ç‚¹

AOPé‡‡å–**æ¨ªå‘æŠ½å–**æœºåˆ¶ï¼Œå–ä»£äº†ä¼ ç»Ÿ**çºµå‘ç»§æ‰¿**ä½“ç³»é‡å¤æ€§ä»£ç ã€‚

Spring AOPä½¿ç”¨çº¯Javaå®ç°ï¼Œ**ä¸éœ€è¦ä¸“é—¨çš„ç¼–è¯‘è¿‡ç¨‹å’Œç±»åŠ è½½å™¨**ï¼Œåœ¨è¿è¡ŒæœŸé€šè¿‡ä»£ç†æ–¹å¼å‘ç›®æ ‡ç±»ï¼ˆå§”æ‰˜ç±»ï¼‰**ç»‡å…¥**å¢å¼ºä»£ç ã€‚ï¼ˆå°†ç›®æ ‡ç±»å˜æˆä»£ç†ç±»ï¼‰

> é€šè¿‡çºµå‘ç»§æ‰¿æ¥å¢å¼ºï¼Œæœ‰ä¸€ä¸ªæœ€è¿‘å­¦ä¹ çš„ä¾‹å­æ˜¯ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œé€šè¿‡ç»§æ‰¿ä¸‰ä¸ªæ¥å£åˆ†åˆ«è·å¾—ä»–ä»¬çš„`set`æ–¹æ³•ï¼Œç»§æ‰¿`BeanNameAware`å¯ä»¥ä½¿ç”¨`setBeanName(String)`ï¼Œç»§æ‰¿`BeanFactoryAware`å¯ä»¥ä½¿ç”¨`setBeanFactory(BeanFactory)`ï¼Œç»§æ‰¿`ApplicationAware`å¯ä»¥ä½¿ç”¨`setApplicationContext(ApplicationContext)`ã€‚

## åº”ç”¨åœºæ™¯

äº‹åŠ¡ç®¡ç†ã€æ€§èƒ½ç›‘è§†ã€å®‰å…¨æ£€æŸ¥ã€ç¼“å­˜ ã€æ—¥å¿—ç­‰ è¿™äº›åœºæ™¯é€šå¸¸æ˜¯å¤šæ¬¡åå¤å‡ºç°è€Œåˆç›¸å¯¹æ¥è¯´æ¯”è¾ƒç¹ççš„éƒ¨åˆ†

æƒ³è±¡ä¸€ä¸‹å¦‚æœæ¯ä¸ªç»„ä»¶éƒ½å•ç‹¬å»å®ç°è¿™äº›ç³»ç»ŸåŠŸèƒ½ï¼Ÿ

æ”¹å˜è¿™äº›å…³æ³¨ç‚¹çš„é€»è¾‘ï¼Œä¿®æ”¹å„ä¸ªæ¨¡å—å½“ä¸­çš„å®ç°ï¼Œæ–¹æ³•çš„è°ƒç”¨å°±ä¼šé‡å¤å‡ºç°åœ¨å„ä¸ªæ¨¡å—ä¸­ï¼Œç»„ä»¶ä¼šå› ä¸ºé‚£äº›ä¸è‡ªèº«æ ¸å¿ƒä¸šåŠ¡æ— å…³çš„ä»£ç è€Œå˜å¾—æ··ä¹±ã€‚

## AOPç¼–ç¨‹æœ¯è¯­

- `Target`  ç›®æ ‡ç±» ï¼ˆéœ€è¦è¢«ä»£ç†çš„ç±»ï¼Œå§”æ‰˜ç±»ï¼‰
- `Proxy` ä»£ç†ç±» ï¼ˆåŠ¨æ€ä»£ç†ç”Ÿæˆçš„ï¼‰ 
- `JoinPoint` è¿æ¥ç‚¹ æŒ‡è¢«ä»£ç†å¯¹è±¡é‡Œé‚£äº›å¯èƒ½ä¼šè¢«å¢å¼ºçš„ç‚¹ ï¼ˆæ–¹æ³•ï¼‰ å¦‚æ‰€æœ‰æ–¹æ³•ï¼ˆå€™é€‰çš„å¯èƒ½è¢«å¢å¼ºçš„å€™é€‰ç‚¹ï¼‰ 
-   ğŸ·ï¸<font color="red">`PointCut` åˆ‡å…¥ç‚¹  å·²ç»è¢«å¢å¼ºçš„è¿æ¥ç‚¹ã€‚</font> (â­  ä½œç”¨æ˜¯æŒ‘é€‰å‡ºå¢å¼ºèŒƒå›´ï¼Œéœ€è¦å¢å¼ºå“ªäº›ç±»ã€‚æ³¨æ„ï¼šæœ€å¤§æŒ‘é€‰èŒƒå›´æ˜¯å®¹å™¨ä¸­çš„ç»„ä»¶) 
- ğŸ·ï¸ <font color="red">`Advice`Â  é€šçŸ¥(å…·ä½“çš„å¢å¼ºçš„ä»£ç )ã€‚ä»£ç†å¯¹è±¡æ‰§è¡Œåˆ°Joinpointæ‰€åšçš„äº‹æƒ…ã€‚ </font>ï¼ˆ â­ é€šçŸ¥ç”¨æ¥æŒ‡å¯¼åšä»€ä¹ˆæ ·çš„å¢å¼ºï¼Œç±»ä¼¼äº`InvocationHandler`çš„`invoke`ï¼‰
- <font color="red">`Aspect`Â  åˆ‡é¢ æ˜¯åˆ‡å…¥ç‚¹å’Œé€šçŸ¥çš„ç»“åˆ ï¼ˆåˆ‡é¢æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é¢ â†’ ä¸€ä¸ªåˆ‡å…¥ç‚¹å’Œä¸€ä¸ªé€šçŸ¥ç»„æˆä¸€ä¸ªç‰¹æ®Šçš„é¢ï¼‰</font>( ğŸ·ï¸åˆ‡é¢å°±æ˜¯å¢å¼ºçš„å®Œæ•´æè¿°ï¼Œåˆ‡å…¥ç‚¹æ˜¯å¯¹è°å¢å¼ºï¼Œé€šçŸ¥æ˜¯æŒ‡å¯¼åšä»€ä¹ˆå¢å¼º)
- `weaver `ç»‡å…¥ æ˜¯æŒ‡æŠŠ`advice`åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹

  - ```java
    Object proxy = Enhancer.create(bean.getClass(),invocationHandler);
    ```


# AOPå®ç°

**AOPé‡‡ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥å®ç°çš„ï¼Œä½¿ç”¨çš„æ˜¯JDKåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†ã€‚**

 ğŸ·ï¸å¦‚æœæœ‰å®ç°æ¥å£çš„è¯ï¼Œä½¿ç”¨çš„æ˜¯JDKåŠ¨æ€ä»£ç†ï¼›å¦‚æœæ²¡æœ‰å®ç°æ¥å£çš„è¯ï¼Œä½¿ç”¨çš„CglibåŠ¨æ€ä»£ç†ã€‚

> é—®ï¼šAOPæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
>
> ç­”ï¼šåŠ¨æ€ä»£ç†ã€‚å¦‚æœæ˜¯æ¥å£å®ç°çš„å°±æ˜¯JDKåŠ¨æ€ä»£ç†ï¼Œå¦åˆ™æ˜¯CGLiBåŠ¨æ€ä»£ç†ã€‚

## AOPå®æˆ˜

- åŠ¨æ€ä»£ç†
- SpringAOP
- AspectJ

## SpringAOP

> Springå®˜æ–¹æä¾›

åœ¨å®¹å™¨ä¸­æ³¨å†Œ3ä¸ªç»„ä»¶ï¼š<font color="red">å§”æ‰˜ç±»ç»„ä»¶ã€é€šçŸ¥ç»„ä»¶ã€ä»£ç†ç»„ä»¶ï¼ˆProxyFactoryBeanï¼‰</font>

ä½¿ç”¨æ³¨è§£æ³¨å†Œå§”æ‰˜ç±»ç»„ä»¶å’Œé€šçŸ¥ç»„ä»¶

```java
//å§”æ‰˜ç±»ç»„ä»¶
@Service
public class UserServiceImpl implements UserService{
    @Override
    public void sayHello() {
        System.out.println("hello xiaowu");
    }
}
```

```java
//é€šçŸ¥ç»„ä»¶
@Component
public class CustomAdvice implements MethodInterceptor {
    @Override
    public Object invoke(MethodInvocation methodInvocation) throws Throwable {
        System.out.println("å¼€å¯äº‹åŠ¡");
        //æ‰§è¡Œå§”æ‰˜ç±»çš„ä»£ç 
        Object proceed = methodInvocation.proceed();
        //é¢å¤–å»åšå¢å¼ºçš„ä¸šåŠ¡
        System.out.println("æäº¤äº‹åŠ¡");
        return proceed;
    }
}
```

é€šè¿‡ä»£ç†ç»„ä»¶æ³¨å†Œä»£ç†ç»„ä»¶

```xml
<bean id="userServiceProxy" class="org.springframework.aop.framework.ProxyFactoryBean">
    <!--å§”æ‰˜ç±»çš„ç»„ä»¶æ˜¯è°-->
    <property name="target" ref="userServiceImpl"/>
    <!--é€šçŸ¥ç»„ä»¶æ˜¯è°-->
    <property name="interceptorNames" value="customAdvice"/>
</bean>
```

å•å…ƒæµ‹è¯•è¦ä»å®¹å™¨ä¸­æŒ‡å®šä»£ç†ç»„ä»¶å–å‡º

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration("classpath:application.xml")
public class MyTest {

    @Autowired
    @Qualifier("userServiceProxy")
    UserService userService;

    @Test
    public void mytest1(){
        userService.sayHello();
    }
}
```

# <font color="red">ğŸŒŸAspectJ</font>

> Springå»ºè®®ä½¿ç”¨çš„ï¼Œä½¿ç”¨æ­¥éª¤ï¼š
>
> 1. å¼•å…¥ä¾èµ–
>
> 2. æ‰“å¼€AspectJçš„æ³¨è§£å¼€å…³ï¼Œæ‰èƒ½ä½¿ç”¨æ³¨è§£çš„æ–¹å¼ä½¿ç”¨AspectJï¼ˆæä¾›ä¿¡æ¯ï¼‰ã€‚åœ¨é…ç½®ç±»ä¸Šå¢åŠ æ³¨è§£`@EnableApectJAutoProxy`
>
> 3. å®šä¹‰åˆ‡é¢ç»„ä»¶ï¼Œåˆ‡é¢ç±»ï¼Œç”¨äºå®¹çº³åˆ‡å…¥ç‚¹å’Œé€šçŸ¥ã€‚åŠ ä¸Šæ³¨è§£`@Aspect`ï¼ˆ`@Aspect`ä¸èƒ½æ³¨å†Œç»„ä»¶ï¼Œè¦åŠ ä¸Š`@Component`ï¼‰
>
> 4. åˆ‡å…¥ç‚¹æ–¹æ³•ï¼šåˆ‡å…¥ç‚¹é€šè¿‡æ–¹æ³•å®šä¹‰
>
>    1. åˆ‡å…¥ç‚¹å¯¹åº”çš„æ–¹æ³•åªæœ‰æ–¹æ³•åæ˜¯æœ‰ç”¨çš„ï¼Œæ–¹æ³•åä½œä¸ºåˆ‡å…¥ç‚¹çš„`id`
>
>    2. `@Pointcut`æ³¨è§£åœ¨å…¶valueå±æ€§é‡Œå†™**åˆ‡å…¥ç‚¹è¡¨è¾¾å¼**ï¼Œç¬¦åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„å®¹å™¨ä¸­çš„ç»„ä»¶çš„æ–¹æ³•ï¼Œä¼šè¢«åˆ’å®šåˆ°åˆ‡å…¥ç‚¹çš„å¢å¼ºèŒƒå›´
>
>       > åªæœ‰åˆ‡å…¥ç‚¹å’Œé€šçŸ¥ç»“åˆæ‰å¯ä»¥è¢«å¢å¼ºã€‚
>
> 5. é€šçŸ¥æ–¹æ³•ï¼šé€šçŸ¥ä¹Ÿè¦é€šè¿‡æ–¹æ³•å®šä¹‰

## å¼•å…¥ä¾èµ–

å¼•å…¥`Aspectjweaver` ä¾èµ–

```xml
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.9.6</version>
</dependency>
```

ç‰ˆæœ¬é€‰æ‹©1.9.6ä¹‹åçš„ç‰ˆæœ¬ï¼Œè€ç‰ˆæœ¬å¯¹æ³¨è§£æ”¯æŒä¼šæœ‰é—®é¢˜ã€‚
## åˆ‡å…¥ç‚¹è¡¨è¾¾å¼

åˆ‡å…¥ç‚¹ç”¨æ¥åœˆå®šå¢å¼ºèŒƒå›´ï¼ŒæŒ‡å®šå“ªä¸€äº›ç»„ä»¶çš„å“ªä¸€äº›æ–¹æ³•ã€‚

å¸¸ç”¨çš„ä¸‰ç§åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š`execution`,`@annotation`,`@target`

###  `execution`  â€œå¤§ç‚®â€

> `execution()` `â€œ()â€`ä¸­å†™å®Œæ•´çš„æ–¹æ³•è¡¨è¾¾
>
> è¯­æ³•ï¼š`execution(è®¿é—®ä¿®é¥°ç¬¦ è¿”å›å€¼ åŒ…å.ç±»å.æ–¹æ³•å(å‚æ•°åˆ—è¡¨))`

- èƒ½å¦çœç•¥

- èƒ½å¦é€šé…

- ç‰¹æ®Šç”¨æ³•

**ä¿®é¥°ç¬¦**ï¼šå¯ä»¥çœç•¥ï¼Œçœç•¥ä»£è¡¨ä»»æ„ä¿®é¥°ç¬¦

**è¿”å›å€¼**ï¼šä¸èƒ½çœç•¥ï¼Œå¯ä»¥ç”¨`*`ä½œä¸ºé€šé…ç¬¦ã€‚JavaBeanè¦å†™å…¨ç±»åï¼ˆåŸºæœ¬ç±»å‹ï¼Œjava.langåŒ…ä¸‹çš„ä¸€äº›ç±»å¯ä»¥ç›´æ¥å†™ç®€å•ç±»åã€‚ï¼‰

**åŒ…åã€ç±»åã€æ–¹æ³•å**ï¼šä½¿ç”¨`..`éƒ¨åˆ†çœç•¥ï¼Œå¤´å’Œå°¾ä¸èƒ½çœç•¥ï¼Œä¸­é—´çš„ä»»æ„ä¸€éƒ¨åˆ†éƒ½å¯ä»¥çœç•¥ï¼›å¯ä»¥ä½¿ç”¨`*`ä½œä¸ºé€šé…ç¬¦

**å½¢å‚**ï¼šå¯ä»¥ä½¿ç”¨`..`æˆ–`*` æ¥è¿›è¡Œé€šé…ï¼Œ<font color=red>`..`ä»£è¡¨ä»»æ„æ•°é‡ä»»æ„ç±»å‹çš„å‚æ•°ï¼Œ`*`ä»£è¡¨ä»»æ„ç±»å‹çš„å‚æ•°</font>

```java
@Pointcut("execution(public void com.cskaoyan.service.UserServiceImpl.sayHello(String))")
public void mypointcut1(){}
```

### `@annotation` â€œç‹™å‡»æªâ€

å†™ä¸Šè‡ªå®šä¹‰æ³¨è§£çš„å…¨ç±»å

ä½œç”¨ï¼šæ³¨è§£ç”¨æ¥æ ‡è®°æ–¹æ³•ã€‚å†™åœ¨å®¹å™¨ä¸­çš„ç»„ä»¶çš„å“ªä¸€ä¸ªæ–¹æ³•ä¸Šï¼Œå“ªä¸€ä¸ªæ–¹æ³•å°±è¢«åˆ’å®šåˆ°åˆ‡å…¥ç‚¹èŒƒå›´ã€‚

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface CountTime {
}
```

```java
@Pointcut("@annotation(com.cskaoyan.CountTime)")
public void mypointcut2(){}
```

### `@target` â€œå†²é”‹æªâ€

å†™ä¸Šè‡ªå®šä¹‰æ³¨è§£çš„å…¨ç±»å

æ³¨è§£ç”¨æ¥æ ‡è®°ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶çš„æ–¹æ³•ä¼šè¢«åˆ’å®šåˆ°åˆ‡å…¥ç‚¹èŒƒå›´ã€‚

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.Type)
public @interface CountTimeAllMethod {
}
```

```java
@Pointcut("@annotation(com.cskaoyan.CountTimeAllMethod)")
public void mypointcut3(){}
```

## Aspectåˆ‡é¢

åœ¨åˆ‡é¢ç±»ä¸­é…ç½®åˆ‡é¢ç»„ä»¶å’Œé€šçŸ¥æ–¹æ³•

AspectJçš„æ³¨è§£å®ç°ï¼Œé¦–å…ˆè¦æ ‡è®°å‰é¢å¼€å…³

ç„¶ååœ¨åˆ‡é¢ç±»ä¸­ä½¿ç”¨AspectJç›¸å…³çš„æ³¨è§£ï¼Œè¡¨è¾¾åˆ‡é¢ã€åˆ‡å…¥ç‚¹ã€é€šçŸ¥

![image-20230927215952682](.\assets\image-20230927215952682.png)

â­ é€šçŸ¥æ³¨è§£çš„`value`å±æ€§ç”¨æ¥æŒ‡æ˜åˆ‡å…¥ç‚¹ï¼Œä¸¤ç§æ–¹å¼ï¼š

1. ç›´æ¥å¼•ç”¨å‰é¢çš„åˆ‡å…¥ç‚¹id
2. ç›´æ¥å†™åˆ‡å…¥ç‚¹è¡¨è¾¾å¼

`@After`ï¼šç›¸å½“äº`finally`ä»£ç å—ï¼Œä¸€å®šä¼šæ‰§è¡Œåˆ°ã€‚

`@Around`ï¼šç¯ç»•ï¼Œæ‰€æœ‰é€šçŸ¥çš„æ€»å’Œã€‚ç›¸å½“äºæ•´ä¸ª`try/catch`ç»“æ„

> ä¸åŒçš„æ³¨è§£ä»£è¡¨ä¸åŒçš„é€šçŸ¥ï¼Œæ³¨è§£çš„`value`å±æ€§ä»£è¡¨åˆ‡å…¥ç‚¹ã€‚

`@Around`çš„å†™æ³•ï¼Œè¿”å›å€¼`Object`

```java
@Around("pointcut()")
public Object method5(ProceedingJoinPoint joinPoint){
  proceedingJoinPoint.proceed();
}
```

`@AfterReturning`ï¼šæ³¨è§£å±æ€§`returning`å¯ä»¥æ¥æ”¶å§”æ‰˜ç±»çš„è¿”å›ç»“æœ

```java
  /**
     * afterReturningé€šçŸ¥
     * è¿”å›å€¼ï¼švoid
     * æ–¹æ³•åï¼šä»»æ„å»å†™
     * å½¢å‚ï¼šObject(å§”æ‰˜ç±»æ–¹æ³•çš„æ‰§è¡Œç»“æœ)
     */
  @AfterReturning(value = "mypointcut()",returning = "result")
  public void afterReturning(Object result){
    System.out.println("afterReturning");
  }
```

`@AfterThrowing`ï¼šæ³¨è§£å±æ€§`throwing`å¯ä»¥æ¥æ”¶å§”æ‰˜ç±»æŠ›å‡ºçš„å¼‚å¸¸

```java
  /**
     * afterThrowingé€šçŸ¥
     * è¿”å›å€¼ï¼švoid
     * æ–¹æ³•åï¼šä»»æ„å»å†™
     * å½¢å‚ï¼šException/Throwable(å§”æ‰˜ç±»æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸)
     */
  @AfterThrowing(value = "mypointcut()",throwing = "exception")
  public void afterThrowing(Exception exception){//Throwable
    System.out.println("afterThrowing");
    System.out.println(exception.getMessage());
  }
```

```java
/**
 * å¢åŠ å¯¹åº”é€šçŸ¥çš„æ–¹æ³•ï¼šå°†è¿™æ ·çš„ä¸€äº›æ–¹æ³•é…ç½®ä¸ºå¯¹åº”çš„é€šçŸ¥æ–¹æ³•
 * æ–¹æ³• â†’ é€šçŸ¥
 *  before
 *  after
 *  around
 *  afterReturning
 *  afterThrowing
 */
@Component
@Aspect
public class CustomAspect {
  /**
     * pointcutæ–¹æ³•
     * è¿”å›å€¼ï¼švoid
     * æ–¹æ³•åï¼šä»»æ„å†™ â†’ ç”¨äºä½œä¸ºpointcutç»„ä»¶çš„id
     * å½¢å‚ï¼šä¸ç”¨å†™
     * æ–¹æ³•ä½“ï¼šä¸ç”¨å†™
     * @Pointcutçš„valueå±æ€§å†™åˆ‡å…¥ç‚¹è¡¨è¾¾å¼
     */
  @Pointcut("execution(* com.cskaoyan.service..*(..))")
  public void mypointcut1(){}
  @Pointcut("@annotation(com.cskaoyan.CountTime)")
  public void mypointcut2(){}
  @Pointcut("@annotation(com.cskaoyan.CountTimeAllMethod)")
  public void mypointcut3(){}
  /**
     * é€šçŸ¥æ³¨è§£@Beforeã€@Afterã€@Aroundã€@AfterReturningã€@AfterThrowing
     * valueå±æ€§ï¼š
     *      1ã€å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼
     *      2ã€å¼•ç”¨çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„æ–¹æ³•å
     */

  /**
     * beforeé€šçŸ¥
     * è¿”å›å€¼ï¼švoid
     * æ–¹æ³•åï¼šä»»æ„å»å†™
     * å½¢å‚ï¼šjoinPointè¿æ¥ç‚¹ (å¯å†™å¯ä¸å†™)
     */
  //@Before("execution(* com.cskaoyan.service..*(..))")
  @Before("mypointcut()")
  public void before(JoinPoint joinPoint){
    System.out.println("before");
  }
  /**
     * afteré€šçŸ¥
     * è¿”å›å€¼ï¼švoid
     * æ–¹æ³•åï¼šä»»æ„å»å†™
     * å½¢å‚ï¼šjoinPointè¿æ¥ç‚¹ (å¯å†™å¯ä¸å†™)
     */
  @After("mypointcut()")
  public void after(){
    System.out.println("after");
  }
```

```java
 /**
     * aroundé€šçŸ¥
     * è¿”å›å€¼ï¼šObject
     * æ–¹æ³•åï¼šä»»æ„å»å†™
     * å½¢å‚ï¼šProceedingJoinPointè¿æ¥ç‚¹ (å¿…é¡»å†™) ğŸ‘‰ æä¾›äº†proceedæ–¹æ³•ï¼Œæ‰§è¡Œçš„æ˜¯å§”æ‰˜ç±»çš„ä»£ç 
     */
  @Around("mypointcut()")
  public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
    System.out.println("aroundçš„before");
		
    // è¯¥æ–¹æ³•æ‰§è¡Œçš„æ˜¯å§”æ‰˜ç±»çš„æ–¹æ³•
    Object proceed = joinPoint.proceed();

    System.out.println("aroundçš„after");
    return proceed;
  }
  /*public Object around(ProceedingJoinPoint joinPoint){
        System.out.println("aroundçš„before");
        Object proceed = null;//è¯¥æ–¹æ³•æ‰§è¡Œçš„æ˜¯å§”æ‰˜ç±»çš„æ–¹æ³•
        try {
            proceed = joinPoint.proceed();
        } catch (Throwable throwable) {
            throwable.printStackTrace();
        }
        System.out.println("aroundçš„after");
        return proceed;
    }*/

}
```

## JoinPointè¿æ¥ç‚¹

è·å–å¢å¼ºè¿‡ç¨‹ä¸­çš„ä¸€äº›å€¼

- `Signature`
  - æ–¹æ³•çš„æè¿°

- `Arguments`
  - å‚æ•°

- `This`
  - ä»£ç†å¯¹è±¡

- `Target`
  - å§”æ‰˜ç±»å¯¹è±¡


![image-20230911173715146](.\assets\image-20230911173715146.png)

åœ¨é€šçŸ¥æ–¹æ³•çš„å½¢å‚ä¸­ï¼Œä¼ å…¥`JoinPoint`å½¢å‚ï¼Œé€šè¿‡`JoinPoint`è·å¾—å¯¹åº”çš„ä¸€äº›å‚æ•°

```java
@Before("mypointcut()")
public void before(JoinPoint joinPoint){
    //Signature æ–¹æ³•çš„æè¿°
    //This ä»£ç†å¯¹è±¡
    //Target å§”æ‰˜ç±»å¯¹è±¡
    //Arguments å‚æ•°
    Signature signature = joinPoint.getSignature();
    Object proxy = joinPoint.getThis();
    Object target = joinPoint.getTarget();
    Object[] args = joinPoint.getArgs();

    System.out.println("signature:" + signature.getName());
    System.out.println(proxy.getClass().getName());
    System.out.println(target.getClass().getName());
    System.out.println(Arrays.asList(args));
}
```
