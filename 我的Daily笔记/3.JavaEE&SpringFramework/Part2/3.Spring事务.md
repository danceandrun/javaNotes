[TOC]

# å‰è¨€

>  ğŸƒ**Springæ•´åˆMybatis**
>
> `sqlSession`çº¿ç¨‹ä¸å®‰å…¨ï¼Œä¸èƒ½åšå…±äº«ã€‚ä½†æ˜¯`Mapper`å¯ä»¥è¢«å®¹å™¨ç®¡ç†ï¼Œæ¯ç§`Mapper`éƒ½ä»¥å•ä¾‹å½¢å¼å­˜åœ¨ã€‚
>
> å®¹å™¨ä¸­æœ‰serviceå±‚çš„å®ä¾‹ï¼Œå¯ä»¥åˆ©ç”¨å®¹å™¨å»ºç«‹å…³ç³»
>
> å¼•å…¥ä¾èµ–`mybatis-spring`, `spring-jdbc`ï¼ˆåŒ…å«å¯¹äº‹åŠ¡çš„ç®¡ç†ï¼‰
>
> æ³¨æ„`mybatis-spring`ä½œä¸º`Mybatis`æä¾›çš„è¡¥ä¸ï¼Œè¿˜éœ€è¦å¼•å…¥`Mybatis`è‡ªèº«çš„ä¾èµ–ã€‚
>
> æ•°æ®æº:`DataSource`
>
> å¸¸è§æœ‰: HikariCP(SpringBooté»˜è®¤æ”¯æŒ), Druidï¼ˆæœ‰æ€§èƒ½ç›‘æ§çš„åŠŸèƒ½ï¼‰, DBCP, C3P0
>
> Springç›¸å…³çš„ä¾èµ–ï¼Œç‰ˆæœ¬è¦ä¸€è‡´ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´å…¼å®¹æ€§é—®é¢˜ï¼Œæ¯”å¦‚å‘ç”Ÿå¼‚å¸¸`ClassNotFoundExcption`
>
> Ctrl + alt + shift + jï¼šå°†ç›¸åŒå†…å®¹éƒ½é€‰ä¸­
>
>  ğŸ·ï¸å®šä¹‰å…¨å±€çš„ç‰ˆæœ¬å·ï¼Œ`${spring.version}`ï¼Œéœ€è¦åœ¨`<properties>`æ ‡ç­¾é‡Œæ·»åŠ ã€‚
>
> ![ä¹‹å‰çš„äº‹åŠ¡](.\assets\ä¹‹å‰çš„äº‹åŠ¡.jpg)
>
> ![Day16-MyBatis-Spring](.\assets\Day16-MyBatis-Spring.jpg)
>
> Springä¸­æ•´åˆMybatisçš„ä½¿ç”¨æ­¥éª¤
>
> 1. å¼•å…¥ä¾èµ– `mybatis-spring`ï¼Œ`spring-jdbc`
>
> 2. æ³¨å†Œç»„ä»¶ 
>    1. DruidDataSource â†’  DataSource
>
>       ![image-20230918091015815](.\assets\image-20230918091015815.png)
>
>    2. SqlSessionFactoryBean â†’  SqlSessionFactory
>
>       ![image-20230918091043718](.\assets\image-20230918091043718.png)
>
>    3. MapperScannerConfigurer  â†’ MapperScannerConfigurer â†’ Mapper
>
>       ![image-20230918091112987](.\assets\image-20230918091112987.png)
>
>    4. æ³¨å†ŒPlatformTransactionManagerç»„ä»¶
>
>       > 1. æ‰“å¼€äº‹åŠ¡çš„æ³¨è§£å¼€å…³ï¼Œå®¹å™¨ä¸­è¦æ³¨å†ŒPlatformTransactionManagerç»„ä»¶
>       > 2. ä½¿ç”¨æ³¨è§£å¢åŠ äº‹åŠ¡ï¼Œé€šè¿‡æ³¨è§£çš„å±æ€§ è°ƒæ•´TransactionDefinitionçš„å€¼
>
>       ![image-20230918091213072](.\assets\image-20230918091213072.png)
>
> 3. åœ¨Serviceå±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰ä½¿ç”¨Mapperç»„ä»¶ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰
>
>  ![image-20230918091256321](.\assets\image-20230918091256321.png)

## å­¦ä¹ ç›®æ ‡

1. ç†è§£Springäº‹åŠ¡æ ¸å¿ƒæ€æƒ³
2. ç†Ÿæ‚‰Springäº‹åŠ¡çš„æ³¨è§£`@Transactional`

## å‰ç½®çŸ¥è¯†å‡†å¤‡

- äº‹åŠ¡
- AOPæ€æƒ³

# äº‹åŠ¡çš„å›é¡¾

## äº‹åŠ¡çš„ç‰¹æ€§

- åŸå­æ€§ Atomicity
- ä¸€è‡´æ€§ Consistency
- éš”ç¦»æ€§ Isolation
- æŒä¹…æ€§ Durability

## äº‹åŠ¡å¹¶å‘å¼•èµ·çš„é—®é¢˜

- è„è¯»
  - ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡<font color="red">è¿˜æœªæäº¤</font>çš„æ•°æ®
- ä¸å¯é‡å¤è¯»
  - ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡<font color="red">å·²ç»æäº¤</font>çš„æ•°æ®<font color="red">ï¼ˆä¿®æ”¹ï¼‰</font>
- è™šè¯»/å¹»è¯»
  - ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡<font color="red">å·²ç»æäº¤</font>çš„æ•°æ®<font color="red">ï¼ˆå¢åˆ ï¼‰</font>

## æ•°æ®åº“çš„éš”ç¦»çº§åˆ«

- è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ 
- è¯»å·²æäº¤ï¼ˆRead committedï¼‰ 
- å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰ 
- ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰

|          | è„è¯» | ä¸å¯é‡å¤è¯» | è™šè¯»/å¹»è¯» |
| -------- | :--: | :--------: | :-------: |
| è¯»æœªæäº¤ |  Ã—   |     Ã—      |     Ã—     |
| è¯»å·²æäº¤ |  âˆš   |     Ã—      |     Ã—     |
| å¯é‡å¤è¯» |  âˆš   |     âˆš      |     Ã—     |
| ä¸²è¡ŒåŒ–   |  âˆš   |     âˆš      |     âˆš     |

MySqlçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œä½†æ²¡æœ‰è™šè¯»é—®é¢˜çš„ã€‚

# äº‹åŠ¡çš„æ ¸å¿ƒæ¥å£

-  â­`PlatformTransactionManager` å¹³å°äº‹åŠ¡ç®¡ç†å™¨

  - ```java
    TransactionStatus getTransaction(TransactionDefinition);
    ```
  - ```java
    void commit(TransactionStatus);
    ```
  - ```java
    void rollback(TransactionStatus);
    ```

- `TransactionStatus` äº‹åŠ¡çŠ¶æ€
- `TransactionDefinition` äº‹åŠ¡å®šä¹‰

## `PlatformTransactionManager` å¹³å°äº‹åŠ¡ç®¡ç†å™¨

å¹³å°äº‹åŠ¡ç®¡ç†å™¨ï¼ŒSpringè¦ç®¡ç†äº‹åŠ¡ï¼Œå¿…é¡»ä½¿ç”¨äº‹åŠ¡ç®¡ç†å™¨ã€‚
æœ‰å¤šç§å®ç°ï¼Œé€šè¿‡å®ç°æ­¤æ¥å£ï¼ŒSpringå¯ä»¥ç®¡ç†ä»»ä½•å®ç°äº†è¿™äº›æ¥å£çš„äº‹åŠ¡ã€‚
å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„ç¼–ç¨‹æ¨¡å‹æ¥æ§åˆ¶ç®¡ç†äº‹åŠ¡ã€‚

å¸¸è§çš„äº‹åŠ¡ç®¡ç†å™¨çš„å®ç°ï¼š
`DataSourceTransactionManager`ï¼Œjdbcå¼€å‘æ—¶äº‹åŠ¡ç®¡ç†å™¨ï¼Œä½¿ç”¨JdbcTemplateã€MyBatis 
HibernateTransactionManagerï¼ŒHibernateå¼€å‘æ—¶äº‹åŠ¡ç®¡ç†å™¨ï¼Œæ•´åˆHibernate

```java
public interface PlatformTransactionManager extends TransactionManager {
    TransactionStatus getTransaction(@Nullable TransactionDefinition var1) throws TransactionException;

    void commit(TransactionStatus var1) throws TransactionException;

    void rollback(TransactionStatus var1) throws TransactionException;
}
```

## `TransactionStatus` äº‹åŠ¡çŠ¶æ€

è·å–äº‹åŠ¡çš„çŠ¶æ€ï¼ˆå›æ»šç‚¹ã€æ˜¯å¦å®Œæˆã€æ˜¯å¦æ–°äº‹åŠ¡ã€æ˜¯å¦å›æ»šï¼‰å±æ€§ï¼Œæ˜¯ä¸€ä¸ª**è¿‡ç¨‹å€¼**

```java
public interface TransactionStatus extends TransactionExecution, SavepointManager, Flushable {
  boolean hasSavepoint();

  void flush();
}
```

æä¾›äº†å…³äºäº‹åŠ¡çŠ¶æ€çš„æ–¹æ³•

![image-20230907091347916](.\assets\image-20230907091347916.png)

## `TransactionDefinition` äº‹åŠ¡å®šä¹‰

å®šä¹‰äº‹åŠ¡çš„åç§°ã€éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶æ—¶é—´é•¿çŸ­ã€åªè¯»å±æ€§ç­‰

```java
public interface TransactionDefinition {
  int PROPAGATION_REQUIRED = 0;
  int PROPAGATION_SUPPORTS = 1;
  int PROPAGATION_MANDATORY = 2;
  int PROPAGATION_REQUIRES_NEW = 3;
  int PROPAGATION_NOT_SUPPORTED = 4;
  int PROPAGATION_NEVER = 5;
  int PROPAGATION_NESTED = 6;
  int ISOLATION_DEFAULT = -1;
  int ISOLATION_READ_UNCOMMITTED = 1;
  int ISOLATION_READ_COMMITTED = 2;
  int ISOLATION_REPEATABLE_READ = 4;
  int ISOLATION_SERIALIZABLE = 8;
  int TIMEOUT_DEFAULT = -1;

  default int getPropagationBehavior() {
    return 0;
  }

  default int getIsolationLevel() {
    return -1;
  }

  default int getTimeout() {
    return -1;
  }

  default boolean isReadOnly() {
    return false;
  }

  @Nullable
  default String getName() {
    return null;
  }

  static TransactionDefinition withDefaults() {
    return StaticTransactionDefinition.INSTANCE;
  }
}
```

## äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º

äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºå±äº`TransactionDefinition`

**æŒ‡å¤šä¸ªæ–¹æ³•ä¹‹é—´å¦‚ä½•æ¥å…±äº«äº‹åŠ¡**ã€‚æ¯”å¦‚æ–¹æ³•aè°ƒç”¨æ–¹æ³•bï¼Œå¦‚æœaå‘ç”Ÿå¼‚å¸¸ï¼Œè¦è€ƒè™‘bæ˜¯å›æ»šè¿˜æ˜¯æäº¤ã€‚

- `REQUIRED`
  - åŒç”Ÿå…±æ­»
- `REQUIRES_NEW`
  - è‡ªç§å‹ï¼Œæˆ‘ç”Ÿä½ æ­»
- `NESTED`
  - æ— ç§å‹ï¼Œä½ ç”Ÿæˆ‘æ­»

> å¦‚æœä¸€ä¸ªæ²¡æœ‰åŒ…å«äº‹åŠ¡çš„æ–¹æ³•è°ƒç”¨äº†ä¸€ä¸ªåŒ…å«äº‹åŠ¡çš„æ–¹æ³•ï¼ŒåŒ…å«äº‹åŠ¡çš„æ–¹æ³•å•ç‹¬æ–°å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚

### `REQUIRED`

å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼›
å¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ä¸­ï¼Œå…±äº«ä¸€ä¸ªäº‹åŠ¡ã€‚

è¦ä¹ˆä¸€èµ·æäº¤ï¼Œè¦ä¹ˆä¸€èµ·å›æ»šã€‚

ä¸€è£ä¿±è£ï¼Œä¸€æŸä¿±æŸã€‚

```
ç°åœ¨æœ‰ä¸¤ä¸ªmethodï¼ŒmethodBï¼ˆå¤–å›´ï¼‰è°ƒç”¨äº†methodAï¼ˆå†…éƒ¨ï¼‰
Q1ï¼šå¦‚æœmethodBå‘ç”Ÿå¼‚å¸¸ï¼Œè°å›æ»šï¼Ÿ
Q2ï¼šå¦‚æœmethodAå‘ç”Ÿå¼‚å¸¸ï¼Œè°å›æ»šï¼Ÿ
```

<font color="red">Q1/Q2ï¼šABéƒ½å›æ»š</font>

### REQUIRES_NEW

å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼›
å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚

è‡ªç§å‹ã€‚å¤–éƒ¨ä¸ä¼šå½±å“å†…éƒ¨ï¼Œå†…éƒ¨ä¼šå½±å“å¤–å›´ã€‚

```
ç°åœ¨æœ‰ä¸¤ä¸ªmethodï¼ŒmethodBï¼ˆå¤–å›´ï¼‰è°ƒç”¨äº†methodAï¼ˆå†…éƒ¨ï¼‰
Q1ï¼šå¦‚æœmethodBå‘ç”Ÿå¼‚å¸¸ï¼Œè°å›æ»šï¼Ÿ
Q2ï¼šå¦‚æœmethodAå‘ç”Ÿå¼‚å¸¸ï¼Œè°å›æ»šï¼Ÿ
```

<font color="red">Q1ï¼šAä¸å›æ»šï¼ŒBå›æ»š</font>

<font color="red">Q2ï¼šABéƒ½å›æ»š</font>

åœºæ™¯ï¼šä¸æ˜¯å¾ˆé‡è¦çš„æ–¹æ³•è°ƒç”¨è°ƒç”¨é‡è¦çš„æ–¹æ³•ã€‚

### NESTED

å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼›
å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™ä»¥**åµŒå¥—äº‹åŠ¡**çš„æ–¹å¼è¿è¡Œã€‚

æ–¹æ³•æ˜¯Aè°ƒç”¨Bï¼Œä½†æ˜¯äº‹åŠ¡æ˜¯BåŒ…å«äº†Aã€‚

æ— ç§å‹ã€‚å¤–å›´ä¼šå½±å“å†…éƒ¨ï¼Œå†…éƒ¨ä¸ä¼šå½±å“å¤–å›´ã€‚

```
ç°åœ¨æœ‰ä¸¤ä¸ªmethodï¼ŒmethodBï¼ˆå¤–å›´ï¼‰è°ƒç”¨äº†methodAï¼ˆå†…éƒ¨ï¼‰
Q1ï¼šå¦‚æœmethodBå‘ç”Ÿå¼‚å¸¸ï¼Œè°å›æ»šï¼Ÿ
Q2ï¼šå¦‚æœmethodAå‘ç”Ÿå¼‚å¸¸ï¼Œè°å›æ»šï¼Ÿ
```

<font color="red">Q1ï¼šABéƒ½å›æ»š</font>

<font color="red">Q2ï¼šAå›æ»šï¼ŒBä¸å›æ»š</font>

åœºæ™¯ï¼šé‡è¦çš„æ–¹æ³•è°ƒç”¨ä¸å¤ªé‡è¦çš„æ–¹æ³•ã€‚æ¯”å¦‚PDDæ³¨å†Œè´¦å·å’Œå‘æ”¾ä¼˜æƒ åˆ¸ã€‚

### å…¶ä»–ä¼ æ’­è¡Œä¸ºï¼ˆäº†è§£ï¼‰

| ä¼ æ’­è¡Œä¸º                  | æè¿°                                                     |
| -------- | :-------- |
| `PROPAGATION_SUPPORTS`           | æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå‡è®¾å½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ             |
| `PROPAGATION_MANDATORY`       | æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå‡è®¾å½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸                            |
| `PROPAGATION_NOT_SUPPORTED` | ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œæ“ä½œã€‚å‡è®¾å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ· |
| `PROPAGATION_NEVER`                   | ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå‡è®¾å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸                    |

# äº‹åŠ¡çš„æ¡ˆä¾‹

ä¸ç®¡ä½¿ç”¨çš„æ˜¯å“ªä¸€ä¸ªæ¡ˆä¾‹ï¼Œåªè¦ä½¿ç”¨Springäº‹åŠ¡ï¼Œå¿…ç„¶è¦ä½¿ç”¨Spring**äº‹åŠ¡ç®¡ç†å™¨**ã€‚

```java
@Bean
public PlatformTransactionManager transactionManager(DataSource dataSource) {
  DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
  transactionManager.setDataSource(dataSource);
  return transactionManager;
}
```

## `TransactionTemplate`

äº‹åŠ¡çš„æ¨¡æ¿ï¼Œé‡‡ç”¨äº‹åŠ¡æ¨¡æ¿æä¾›çš„æ–¹æ³•æ¥ä½¿ç”¨äº‹åŠ¡ã€‚

åœ¨å®¹å™¨ä¸­æ³¨å†Œ`TransactionTemplate`ç»„ä»¶

```java
@Configuration
@ComponentScan("com.cskaoyan")
public class MyBatisConfiguration {

    // javaConfigè®²è¿‡è¿™ä¸ªç»„ä»¶æ³¨å†Œ
    // MyBatisæ³¨å†Œçš„ç»„ä»¶ç•¥

    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
        transactionManager.setDataSource(dataSource);
        return transactionManager;
    }
    @Bean
    public TransactionTemplate transactionTemplate(PlatformTransactionManager transactionManager) {
        TransactionTemplate transactionTemplate = new TransactionTemplate();
        transactionTemplate.setTransactionManager(transactionManager);
        return transactionTemplate;
    }
}
```

ä½¿ç”¨`TransactionTemplate`æä¾›çš„æ–¹æ³•

```java
@Service
public class AccountServiceImpl implements AccountService{
    @Autowired
    AccountDao accountDao;
    @Autowired
    TransactionTemplate transactionTemplate;
    @Override
    public void transfer(String from, String dest, Integer money) {
        Integer fromMoney = accountDao.selectMoneyByName(from) - money;
        Integer destMoney = accountDao.selectMoneyByName(dest) + money;

        //executeæ–¹æ³•çš„è¿”å›å€¼ æ˜¯doInTransactionæ–¹æ³•çš„è¿”å›å€¼
        Integer execute = transactionTemplate.execute(new TransactionCallback<Integer>() {
            //éœ€è¦å¢åŠ äº‹åŠ¡çš„ä»£ç æ”¾å…¥åˆ°doInTransactionä¸­
            //å¦‚æœéœ€è¦å¢åŠ äº‹åŠ¡çš„æ–¹æ³•éœ€è¦è¿”å›å€¼ â†’ ç›´æ¥è¿”å›å¯¹åº”çš„å€¼å³å¯
            @Override
            public Integer doInTransaction(TransactionStatus transactionStatus) {

                accountDao.updateMoneyByName(from, fromMoney);//æ“ä½œäº†æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å¢åŠ äº‹åŠ¡
                int i = 1/0;
                accountDao.updateMoneyByName(dest, destMoney);//æ“ä½œäº†æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å¢åŠ äº‹åŠ¡
                return null;
            }
        });
        /*transactionTemplate.execute(new TransactionCallbackWithoutResult() {
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus transactionStatus) {
                accountDao.updateMoneyByName(from, fromMoney);//æ“ä½œäº†æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å¢åŠ äº‹åŠ¡
                accountDao.updateMoneyByName(dest, destMoney);//æ“ä½œäº†æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å¢åŠ äº‹åŠ¡
            }
        });*/
    }
}
```

## `@Transactional`æ³¨è§£

åŠ ä¸Šè¿™ä¸ªæ³¨è§£ä¹‹å

1. è¡¨ç¤ºæ‰“å¼€äº†äº‹åŠ¡å¤„ç†çš„å¼€å…³
2. å°±å¯ä»¥ä¿®æ”¹`TransactionDefinition`

`@Transactional` æ³¨è§£çš„`ElementType`ä¸º<font color="red">`TYPE`å’Œ`METHOD`</font>ï¼Œæ„å‘³ç€å¯ä»¥å†™åœ¨<font color="red">ç±»ä¸Šæˆ–æ–¹æ³•ä¸Š</font>

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
public @interface Transactional {
    @AliasFor("transactionManager")
    String value() default "";

    @AliasFor("value")
    String transactionManager() default "";

    Propagation propagation() default Propagation.REQUIRED;

    Isolation isolation() default Isolation.DEFAULT;

    int timeout() default -1;

    boolean readOnly() default false;

    Class<? extends Throwable>[] rollbackFor() default {};

    String[] rollbackForClassName() default {};

    Class<? extends Throwable>[] noRollbackFor() default {};

    String[] noRollbackForClassName() default {};
}
```

ä½¿ç”¨æ³¨è§£å‰ï¼Œéœ€è¦<font color="red">å…ˆæ‰“å¼€äº‹åŠ¡çš„æ³¨è§£é©±åŠ¨</font>

```java
@Configuration
@ComponentScan("com.cskaoyan")
@EnableTransactionManagement
public class MyBatisConfiguration {}
```

ç›´æ¥ä½¿ç”¨ `@Transactional` æ³¨è§£ï¼Œå¯ä»¥ä½¿ç”¨æ³¨è§£æä¾›çš„å±æ€§<font color="red">é…ç½®äº‹åŠ¡çš„`TransactionDefinition`</font>

```java
/**
 * åœ¨ç±»ä¸Šå¢åŠ @Transactional æ„å‘³ç€è¯¥ç±»ä¸‹çš„æ‰€æœ‰æ–¹æ³•éƒ½å¢åŠ äº‹åŠ¡
 * @Transactionalè¦å¢åŠ åœ¨å®¹å™¨ä¸­çš„ç»„ä»¶æˆ–ç»„ä»¶ä¸­çš„æ–¹æ³•é‡Œ
 */
@Transactional
@Service
public class AccountServiceImpl implements AccountService{
    @Autowired
    AccountDao accountDao;

    //å¯¹åº”çš„æ–¹æ³•å¢åŠ ä¸Šäº‹åŠ¡
    @Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.DEFAULT,timeout = 5)
    @Override
    public void transfer(String from, String dest, Integer money) {
        Integer fromMoney = accountDao.selectMoneyByName(from) - money;
        Integer destMoney = accountDao.selectMoneyByName(dest) + money;

        accountDao.updateMoneyByName(from, fromMoney);//æ“ä½œäº†æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å¢åŠ äº‹åŠ¡
        int i = 1/0;
        accountDao.updateMoneyByName(dest, destMoney);//æ“ä½œäº†æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å¢åŠ äº‹åŠ¡

    }
}
```

