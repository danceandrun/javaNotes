[TOC]

# å‰è¨€

## å­¦ä¹ ç›®æ ‡

1. ç†è§£SpringMVCå’ŒServletä¹‹é—´çš„å…³ç³»
2. **ç†Ÿæ‚‰**Controllerç»„ä»¶ä¸­çš„Handleræ–¹æ³•å’ŒURLä¹‹é—´çš„æ˜ å°„å…³ç³»çš„å»ºç«‹
3. **ç†Ÿæ‚‰**Handleræ–¹æ³•çš„è¿”å›å€¼å“åº”JSONæ•°æ®
4. **ç†Ÿæ‚‰**Handleræ–¹æ³•æ¥æ”¶key-valueå’ŒJSONæ•°æ®çš„æ–¹å¼
5. ç†è§£SpringMVCçš„æ ¸å¿ƒæµç¨‹ï¼ˆé¢è¯•æ‹”é«˜ï¼‰ ğŸ˜¶â€ğŸŒ«ï¸éš¾ç‚¹
6. ç†è§£SpringMVCçš„é™æ€èµ„æºå¤„ç†
7. ç†è§£SpringMVCä½¿ç”¨è¿‡ç¨‹ä¸­çš„æ‹¦æˆªå™¨
8. æŒæ¡SpringMVCçš„å¼‚å¸¸å¤„ç†

> Springæ ¸å¿ƒæ˜¯å®¹å™¨
>
> MVCæ˜¯å¼€å‘webåº”ç”¨çš„æ¶æ„ï¼Œæ€ä¹ˆå°†è¿™ä¸¤ä¸ªè”ç³»èµ·æ¥ã€‚

## å‰ç½®çŸ¥è¯†å‡†å¤‡

- æŠ½è±¡ç±»
- ApplicationContext
  - æ˜¯å®¹å™¨ï¼Œå¯ä»¥åŠ è½½é…ç½®ç±»
  - æä¾›é…ç½®ç±»çš„æ–¹å¼
    - new AnnotationConfigAppllicationContext()

- Servleté˜¶æ®µURIå’ŒServletä¸­çš„æ–¹æ³•ä¹‹é—´çš„å…³ç³»
  - ä¸€ä¸ªURIåªèƒ½å¯¹åº”ä¸€ä¸ªServletæ–¹æ³•
  - ä¸€ä¸ªServletæ–¹æ³•å¯ä»¥å¯¹åº”å¤šä¸ªURI

- Servletä¸­å¦‚ä½•é€šè¿‡Requestè·å¾—è¯·æ±‚å‚æ•°
  - QueryStringå’Œè¯·æ±‚ä½“ä¸­çš„key=valueè¯·æ±‚å‚æ•°
  - è¯·æ±‚ä½“ä¸­çš„JSONè¯·æ±‚å‚æ•°
  - æ–‡ä»¶ï¼šrequest.getPart
- Servletä¸­å¦‚ä½•é€šè¿‡Responseå“åº”JSONå­—ç¬¦ä¸²
- æ³¨è§£
- åå°„æ‰§è¡Œæ–¹æ³• method.invoke(instance,args)
- Filterå’ŒListenerçš„æ‰§è¡Œæ—¶æœº

# SpringMVCä»‹ç»

## MVCæ¦‚å¿µ

MVCè®¾è®¡æ¨¡å¼çš„ä»»åŠ¡æ˜¯å°†åŒ…å«ä¸šåŠ¡æ•°æ®çš„æ¨¡å—ä¸æ˜¾ç¤ºæ¨¡å—çš„è§†å›¾**è§£è€¦**ã€‚
SpringMVCæ˜¯åœ¨Springæ¡†æ¶çš„åŸºç¡€ä¸Šåšçš„ï¼ŒMVCæ¯ä¸€å±‚æ€æ ·é€šè¿‡Springå¤„ç†çš„ï¼Œæ¯ä¸€å±‚å½“ä¸­æ€æ ·æ³¨å†Œå’Œç®¡ç†ç»„ä»¶ã€‚å“ªäº›ç»„ä»¶è¦æ³¨å†Œï¼Œè¦å–å‡ºã€‚

## SpringMVCå’ŒJavaEEçš„æ¯”è¾ƒ

SpringMVCå‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³JavaEEå¼€å‘çš„å¤æ‚æ€§è€Œæå‡ºçš„ã€‚ï¼ˆRod Johnsonï¼‰

SpringMVCå¯¹è¯·æ±‚åŠ¨ä½œçš„è§£è€¦æ›´åŠ çš„ç®€å•ï¼Œæ›´åŠ ç›´æ¥ã€‚

![image-20230907091721401](.\assets\image-20230907091721401.png)

ä»è€Œåªéœ€è¦å…³æ³¨æ–¹æ³•ä¸Šçš„URIå°±å¯ä»¥å¤„ç†è¯·æ±‚

SpringMVCæ˜¯é€šè¿‡ä¸€ä¸ªServletï¼ˆDispatcherServletï¼‰æ¥æ¥æ”¶å…¨éƒ¨è¯·æ±‚ï¼Œç„¶ååˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•ä¸Š

![Day17-SpringMVCæ¶æ„](.\assets\Day17-SpringMVCæ¶æ„.jpg)

## SpringMVCçš„æ ¸å¿ƒæµç¨‹

å…¨éƒ¨çš„è¯·æ±‚éƒ½é€šè¿‡`DispatcherServlet`æ¥æ¥æ”¶ï¼Œç„¶åæ ¹æ®è¯·æ±‚urlåˆ†å‘åˆ°ä¸åŒçš„`Handler`ï¼Œ`Handler`å¤„ç†ä¹‹åå“åº”`ModelAndView`æˆ–è€…`Json`æ•°æ®

![image-20230907091757237](.\assets\image-20230907091757237.png)

![Day17-AACDSI](.\assets\Day17-AACDSI.jpg)

# SpringMVCçš„å…¥é—¨æ¡ˆä¾‹

1. å¼•å…¥ä¾èµ–`spring-webmvc` (spring-web,Springé˜¶æ®µçš„ä¾èµ–ä¹Ÿä¼šå¼•å…¥è¿›æ¥)
2. é…ç½®`DispatcherServlet`ä»¥åŠæ˜ å°„ï¼ˆ`url-pattern = /`ï¼‰
   1. ç»§æ‰¿AACDSI
   2. é‡å†™æ–¹æ³•ï¼š`getServletMappings()`
3. æä¾›é…ç½®ç±»åˆå§‹åŒ– `ApplicationContext` â†’ `WebApplicationContext(getServletContext())` â†’ `AnnotationConfigWebApplicationContext`

`@Controller`å¢åŠ servletå’Œå…¶ä»–ç»„ä»¶é—´çš„è”ç³»

ä¸‰ä¸ª`congfig`

`ApplicationInitializer`

```JAVA
public class ApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {
    // æä¾›é…ç½®ç±»ï¼Œåˆå§‹åŒ–å®¹å™¨ä¼šåŠ è½½ä½ æä¾›çš„é…ç½®ç±»
    @Override
    protected Class<?>[] getRootConfigClasses() {
        return new Class[]{RootConfiguration.class};
    }

    @Override
    protected Class<?>[] getServletConfigClasses() {
        return new Class[]{WebConfiguration.class};
    }

    /**
     * DispatcherServletæ˜¯é€šè¿‡ServletContexté…ç½®çš„ï¼Œé…ç½®Servletå·²ç»å¯¹åº”çš„URL-Pattern
     * è¿™ä¸ªè¿‡ç¨‹ AACDSIåšçš„ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æä¾›ä¸€ä¸ªurl-pattern
     *
     * é…ç½®DispatcherServletçš„url-pattern
     * @return
     */
    @Override
    protected String[] getServletMappings() {
        return new String[]{"/"};
    }
}
```

`RootConfiguration`

```JAVA
@Configuration
//@ComponentScan(value = "com.cskaoyan.demo2",excludeFilters = @ComponentScan.Filter({Controller.class, EnableWebMvc.class}))
@ComponentScan(value = "com.cskaoyan.demo2",excludeFilters = {@ComponentScan.Filter(type = FilterType.ANNOTATION,value = {Controller.class,EnableWebMvc.class})})
@EnableTransactionManagement
public class RootConfiguration {

    @Bean
    public DataSource dataSource() {
        DruidDataSource dataSource = new DruidDataSource();
        dataSource.setDriverClassName("com.mysql.jdbc.Driver");
        dataSource.setUrl("jdbc:mysql://localhost:3306/cskaoyan_market?useUnicode=true&characterEncoding=utf-8");
        dataSource.setUsername("root");
        dataSource.setPassword("123456");
        return dataSource;
    }

    @Bean
    public SqlSessionFactoryBean sqlSessionFactory(DataSource dataSource) {
        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();
        sqlSessionFactoryBean.setDataSource(dataSource);
        sqlSessionFactoryBean.setTypeHandlersPackage("com.cskaoyan.demo2.typehandler");
        PageInterceptor pageInterceptor = new PageInterceptor();

        Properties properties = new Properties();
        properties.setProperty("helperDialect", "mysql");
        properties.setProperty("reasonable", "true");
        pageInterceptor.setProperties(properties);
        sqlSessionFactoryBean.setPlugins(pageInterceptor);
        return sqlSessionFactoryBean;
    }

    @Bean
    public MapperScannerConfigurer mapperScannerConfigurer() {
        MapperScannerConfigurer configurer = new MapperScannerConfigurer();
        configurer.setBasePackage("com.cskaoyan.demo2.mapper");
        configurer.setSqlSessionFactoryBeanName("sqlSessionFactory");
        return configurer;
    }

    @Bean
    public PlatformTransactionManager platformTransactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

`WebConfiguration`

```JAVA
@EnableWebMvc
@ComponentScan("com.cskaoyan.demo2.controller")
public class WebConfiguration implements WebMvcConfigurer {
}
```

## JavaConfig

> AACDSI â†’ æŠ½è±¡ç±» AbstractAnnotationConfigDispatcherServletInitializer

AACDSIå®ç°äº†æ¥å£`WebApplicationInitializer`ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼ŒTomcaté»˜è®¤ä½¿ç”¨ï¼Œå®ƒçš„å®ç°ç±»ä¼šåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æ‰§è¡Œå¯¹åº”çš„`onStartup`æ–¹æ³•

1. `onStartup` å°±æ˜¯èµ·ç‚¹ï¼ŒåŒæ—¶åŒ…å«äº†`ServletContext`ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥é…ç½®`ApplicationContext`
2. `onStartup` é‡Œåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ
   1. åˆ›å»ºäº†ä¸€ä¸ª`WebApplicationContext` å¯¹è±¡ï¼ŒåŠ è½½äº†é…ç½®ç±»ï¼ŒåŠ è½½çš„æ˜¯ `getRootConfigClasses()`è¿”å›çš„é…ç½®ç±»
   2. è·å¾—äº†`ServletContext`ï¼Œåœ¨`ServletContext`ä¸­æŠŠ`WebApplicationContext`å¯¹è±¡æ”¾è¿›å»äº†ï¼Œkeyä¸ºxxx_Root
   3. ![Day17-AACDSI](.\assets\Day17-AACDSI-1694785162346-1.jpg)
   
   4. `@Contrroller` `@EnableWebMvc` ä¹Ÿæœ‰ç»„ä»¶æ³¨å†Œçš„åŠŸèƒ½

â€‹		

éœ€è¦æˆ‘ä»¬åœ¨æŠ½è±¡ç±»çš„å­ç±»ä¸­å»å†™è¿™ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•çš„å®ç° â†’ æä¾›è‡ªå®šä¹‰çš„é…ç½®ç±»

å®ç°

```java
/**
 * åº”ç”¨ç¨‹åºå¯åŠ¨çš„å…¥å£
 */
public class ApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {
    @Override
    protected Class<?>[] getRootConfigClasses() {
	// åˆå§‹åŒ–Listenerçš„WebApplicationContextè¯»å–çš„é…ç½®ç±»
	// å®é™…ä¸Šåšçš„å°±æ˜¯è¿™æ ·çš„äº‹æƒ… new AnnotationConfigWebApplicationContext(RootConfiguration.class);
        return new Class[]{RootConfiguration.class};
    }

    @Override
    protected Class<?>[] getServletConfigClasses() {
      // åˆå§‹åŒ–DispatcherServletçš„WebApplicationContextè¯»å–çš„é…ç½®ç±»
      // å®é™…ä¸Šåšçš„å°±æ˜¯è¿™æ ·çš„äº‹æƒ… new AnnotationConfigWebApplicationContext(ServletConfiguration.class);
        return new Class[]{ServletConfiguration.class};
    }

    @Override
    protected String[] getServletMappings() {
      // é…ç½®DispatcherServletçš„url-pattern â†’ /
        return new String[]{"/"};
    }
}
```

 **é…ç½®ç±»åˆå§‹åŒ–**

Springé…ç½®ç±»åˆå§‹åŒ–çš„`ApplicationContext` åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ

- æ‰«æ`com.cskaoyan` è¿™ä¸ªåŒ…ç›®å½•ï¼Œå¹¶ä¸”æ’é™¤æ‰`Controller`

SpringMVCé…ç½®ç±»åˆå§‹åŒ–çš„`ApplicationContext` åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ

- æ‰«æ`com.cskaoyan.controller` è¿™ä¸ªåŒ…ç›®å½•
- `@EnableWebMvc`

```java
//@Configuration
@ComponentScan("com.cskaoyan.controller")
@EnableWebMvc // mvc:annotation-driven  
// åé¢è¿˜ä¼šåšä¸€äº›å’ŒSpringMVCç›¸å…³çš„é…ç½® éœ€è¦å®ç°æ¥å£ WebMvcConfigurerï¼Œå®ç°æ¥å£é‡Œçš„æ–¹æ³•å°±æ˜¯æä¾›ä¸€äº›é¢å¤–çš„é…ç½®ä¿¡æ¯
public class ServletConfiguration implements WebMvcConfigurer {
}
```

```java
@Configuration
@ComponentScan(value = "com.cskaoyan",
        //excludeFilters = {@ComponentScan.Filter(type = FilterType.ANNOTATION,classes = {Controller.class, EnableWebMvc.class})})
        //excludeFilters = {@ComponentScan.Filter(type = FilterType.ANNOTATION,value = {Controller.class, EnableWebMvc.class})}) //classeså’Œvalueäº’ç›¸æ›¿ä»£
        //excludeFilters = {@ComponentScan.Filter(value = {Controller.class, EnableWebMvc.class})})//çœç•¥æ‰äº†typeå±æ€§å€¼ï¼Œå…¶é»˜è®¤å€¼å°±æ˜¯FilterType.ANNOTATION
        //excludeFilters = {@ComponentScan.Filter({Controller.class, EnableWebMvc.class})})//çœç•¥æ‰äº†value= åªæœ‰valueå±æ€§äº†
        excludeFilters = @ComponentScan.Filter({Controller.class, EnableWebMvc.class}))//çœç•¥æ‰äº†{} æ•°ç»„ä¸­åªæœ‰ä¸€ä¸ªå€¼
public class RootConfiguration {
}
```

## ä½¿ç”¨

```java
//controllerç»„ä»¶ä¸­æ”¾handleræ–¹æ³•ï¼Œhandleræ–¹æ³•å¤„ç†è¯·æ±‚
@Controller
public class HelloController {

    @RequestMapping("hello")
    public ModelAndView hello(){
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("/jsp/hello.jsp");
        modelAndView.addObject("content", "mvc2");
        return modelAndView;
    }
}
```

## é—®é¢˜

```JAVA
Qï¼š@EnableWebMvcå’ŒWebMvcConfigureræ¥å£èƒ½å¤Ÿèµ·åˆ°ä»€ä¹ˆåŠŸèƒ½
Aï¼š@EnableWebMvcå¸®åŠ©æˆ‘ä»¬æ³¨å†Œäº†ä¸€äº›ç»„ä»¶ï¼ŒWebMvcConfigureræ¥å£æä¾›å¯¹æ•°æ®ç»‘å®šã€jsonæ•°æ®ã€conversion-serviceã€validatorç­‰æ”¯æŒï¼Œæœ€é‡è¦çš„å°±æ˜¯RequestMappingHandlerMappingå’ŒRequestMappingHandlerAdapterã€‚
```

```JAVA
Qï¼šæˆ‘ä»¬åˆå§‹åŒ–å®¹å™¨æ„é€ Springç¯å¢ƒï¼ŒSpringå®¹å™¨åœ¨Webç¯å¢ƒä¸‹çš„å…·ä½“å­˜åœ¨æ˜¯ä»€ä¹ˆï¼Ÿ
Aï¼šå…·ä½“å­˜åœ¨ä»ç„¶æ˜¯ApplicationContextä½œä¸ºå®¹å™¨ï¼Œåªä¸è¿‡å½“å‰æ˜¯WebApplicationContext
æˆ‘ä»¬åœ¨ServletContextä¸‹å…±äº«WebApplicationContext
```

![Day18-å®¹å™¨ä¸­çš„ç»„ä»¶](.\assets\Day18-å®¹å™¨ä¸­çš„ç»„ä»¶.jpg)

>ä¸ºäº†é¿å…é‡å¤çš„åŒ…ï¼Œéœ€è¦æŠŠRootConfiguration ä¸­çš„`@Controller` `@EnableWebMvc`ä¸¤ä¸ªæ³¨è§£æ’é™¤æ‰ã€‚å¦‚ä½•æ’é™¤çš„ï¼Ÿ
>
>ä½¿ç”¨`@ComponentScan`çš„`excludeFilters`å±æ€§ï¼š
>
>```java
>@ComponentScan(value = "com.cskaoyan",excludeFilters = {@ComponentScan.Filter(classes = {Controller.class, EnableWebMvc.class})})
>```

è¦ç†æ¸…æ¶æ„å›¾ï¼š

1. Servletå’Œå®¹å™¨ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆ
2. æ€ä¹ˆç»´æŠ¤è¿™äº›å…³ç³»çš„

# `@RequestMapping`æ³¨è§£çš„ä½¿ç”¨

- è¯·æ±‚URLé™å®š
- çª„åŒ–è¯·æ±‚
- è¯·æ±‚æ–¹æ³•é™å®š
- è¯·æ±‚å‚æ•°é™å®š
- è¯·æ±‚å¤´é™å®š

é€šè¿‡`@RequestMapping`æ³¨è§£çš„ä¸åŒå±æ€§ï¼Œå®ç°ä¸åŒåŠŸèƒ½ä¸Šçš„é™å®š

## `@RequestMapping` æ³¨è§£çš„å®šä¹‰

```java
@Target({ElementType.TYPE, ElementType.METHOD})//è¯¥æ³¨è§£å¯ä»¥å†™åœ¨ç±»ä¸Šæˆ–æ–¹æ³•ä¸Š
@Retention(RetentionPolicy.RUNTIME)
public @interface RequestMapping {
    // æ²¡ç”¨
    String name() default "";
	 // valueå±æ€§ï¼šæ˜ å°„çš„URLæ˜¯ä»€ä¹ˆ
    @AliasFor("path")
    String[] value() default {};
    @AliasFor("value")
    String[] path() default {};
	 // è¯·æ±‚æ–¹æ³•é™å®š
    RequestMethod[] method() default {};
	 // è¯·æ±‚å‚æ•°é™å®š
    String[] params() default {};
	 // è¯·æ±‚å¤´é™å®š
    String[] headers() default {};
	 // ç‰¹å®šè¯·æ±‚å¤´çš„å€¼çš„é™å®šï¼šContent-Type
    String[] consumes() default {};
	 // ç‰¹å®šè¯·æ±‚å¤´çš„å€¼çš„é™å®šï¼šAccept
    String[] produces() default {};
}
```

## URLè·¯å¾„æ˜ å°„ `value`ğŸŒŸğŸŒŸğŸŒŸ 

<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**SpringMVCè¿™ä¸ªæ¡†æ¶çš„çµé­‚æ˜¯@RequestMappingï¼Œ@RequestMappingå®ƒçš„çµé­‚æ˜¯valueå±æ€§**</span>

ğŸƒ `value`å±æ€§ä½¿ç”¨æ³¨æ„ï¼š

1. å†™å¤šä¸ªå€¼
2. å†™é€šé…ç¬¦`*`
3. çª„åŒ–è¯·æ±‚

> `value`å±æ€§çš„ç‰¹ç‚¹ï¼šå¦‚æœåªç”¨åˆ°`value`å±æ€§ï¼Œå¯ä»¥çœç•¥ä¸å†™
>
> æ•°ç»„ï¼šå¦‚æœæ•°ç»„ä¸­åªæœ‰ä¸€ä¸ªå€¼ï¼Œå¯ä»¥çœç•¥æ‰`{}`

```java
//æ˜ å°„URL â†’ localhost:8080/hello
@RequestMapping(value={"hello"})
@ResponseBody
// å½¢å‚ â†’ é€šè¿‡å½¢å‚æ¥æ”¶äº†è¯·æ±‚å‚æ•°
public String hello(String username) {
    String result = "hello " + username;
    // è¦å“åº”çš„å€¼ç›´æ¥è¿”å›
    return result; 
}

@RequestMapping("goodbye")
@ResponseBody
public String goodbye(String username) {
    return "goodbye " + username;
}
```

`value`å±æ€§çš„ä½œç”¨ï¼šåœ¨URLå’Œå¤„ç†è¿™ä¸ªURLè¯·æ±‚çš„æ–¹æ³•ä¹‹é—´**å»ºç«‹æ˜ å°„å…³ç³»**

```java
String[] value() default {};
```

å€¼çš„ç±»å‹æ˜¯Stringæ•°ç»„

å¦‚æœæˆ‘ä»¬é€šè¿‡`value`å±æ€§æä¾›äº†**æ•°ç»„ç±»å‹çš„å€¼**ï¼šè¿™ä¸ªæ•°ç»„å¯¹åº”urlå°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥å¤„ç†

å†™`value`å±æ€§çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨**é€šé…ç¬¦`*`**

```java
@Controller
public class UrlMappingController {

    //localhost:8080/hello
    //localhost:8080/hi
    //localhost:8080/nihao
    //@RequestMapping(value = {"hello","hi","nihao"})
    @RequestMapping({"hello","hi","nihao"})
    @ResponseBody
    public String hello() {
        return "hello demo5";
    }
    //localhost:8080/goodbye
    //localhost:8080/goodbyesong
    //localhost:8080/goodbyeligenli
    //localhost:8080/goodbye/ligenli
    //localhost:8080/goodbye/xuejia
    // å¯ä»¥ä½¿ç”¨é€šé…ç¬¦*
    @RequestMapping({"goodbye*","goodbye/*"})
    @ResponseBody
    public String goodbye() {
        return "byebye";
    }
}
```

åˆ©ç”¨å…¶`value`å±æ€§è¿˜å¯ä»¥åšçª„åŒ–è¯·æ±‚

`/user/create`

`/user/modify`

`/user/remove`

`/user/query`

ä¸Šé¢çš„å€¼éƒ½æ˜¯ä»¥`/user`å¼€å¤´çš„

```java
@Controller
public class UserController {
    
    @RequestMapping("user/query")
    @ResponseBody
    public String query() {
        return "user/query";
    }
    @RequestMapping("user/create")
    @ResponseBody
    public String create() {
        return "user/create";
    }
    @RequestMapping("user/remove")
    @ResponseBody
    public String remove() {
        return "user/remove";
    }
    @RequestMapping("user/modify")
    @ResponseBody
    public String modify() {
        return "user/modify";
    }
}
```

**çª„åŒ–è¯·æ±‚**ï¼š**åœ¨ç±»ä¸ŠåŠ `@RequestMapping`**

> è¯¥ `Controller`ç»„ä»¶ä¸­çš„æ–¹æ³•æ˜ å°„çš„URLï¼ ç±»ä¸Šçš„`@RequestMapping` çš„valueå±æ€§å€¼ + æ–¹æ³•ä¸Šçš„`@RequestMapping`çš„valueå±æ€§å€¼

```java
@Controller
@RequestMapping("user")
public class UserController {

    //@RequestMapping("user/query")
    @RequestMapping("query")
    @ResponseBody
    public String query() {
        return "user/query";
    }
    //@RequestMapping("user/create")
    @RequestMapping("create")
    @ResponseBody
    public String create() {
        return "user/create";
    }
    //@RequestMapping("user/remove")
    @RequestMapping("remove")
    @ResponseBody
    public String remove() {
        return "user/remove";
    }
    //@RequestMapping("user/modify")
    @RequestMapping("modify")
    @ResponseBody
    public String modify() {
        return "user/modify";
    }
}
```

ä¸¤è€…ä¹‹é—´çš„`/ `å†™ä¸å†™éƒ½è¡Œï¼Œå†™URLçš„æ—¶å€™ï¼Œä¹Ÿä¸å¿…ä»¥` / `å¼€å¤´ã€‚

> ä½†æ˜¯`servlet`ä¸­çš„`/` ä¸å¯ä»¥çœç•¥

 ğŸ·ï¸å¼€å‘è§„èŒƒï¼š

é€šè¿‡çª„åŒ–è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å»åš**è§£è€¦**ï¼Œå¦‚æœè¯·æ±‚åšçš„æ˜¯æŸä¸€æ–¹é¢çš„ä¸šåŠ¡çš„è¯ï¼Œé…ç½®å…¶URLçš„æ—¶å€™ç»™å…¶ç›¸åŒçš„å‰ç¼€ï¼Œå¹¶ä¸”å°†å…¶å†™åˆ°åŒä¸€ä¸ª`Controller`ç±»ï¼ˆç»„ä»¶ï¼‰ä¸­ï¼Œåœ¨è¿™ä¸ªç±»ä¸Šå°±å¯ä»¥ä½¿ç”¨`@RequestMapping`æ³¨è§£åšçª„åŒ–è¯·æ±‚ã€‚

æ¯”å¦‚è®¢å•ç›¸å…³çš„ä¸šåŠ¡ï¼Œæˆ‘ä»¬çš„æ–¹æ³•ï¼Œå¤„ç†çš„urlåˆ†åˆ«æ˜¯`order/create`ã€`order/remove`ã€`order/query`ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™åˆ°åŒä¸€ä¸ª`Controller`ç»„ä»¶ä¸­ï¼Œæ¯”å¦‚`OrderController`ï¼Œåœ¨ä¸Šé¢å¢åŠ çª„åŒ–è¯·æ±‚`@RequestMapping("order")`

```java
@Controller
@RequestMapping("order")
public class OrderController{}
```

## è¯·æ±‚æ–¹æ³•é™å®š` method`

è¯·æ±‚æ–¹æ³•é™å®š

> åœ¨Servleté˜¶æ®µå¤„ç†`get` è¯·æ±‚ï¼Œä½¿ç”¨Servletä¸­çš„`doGet`æ–¹æ³•ï¼›å¤„ç†`post` è¯·æ±‚ä½¿ç”¨Servletä¸­çš„`doPost`æ–¹æ³•ï¼›

å¦‚æœæˆ‘ä»¬åœ¨SpringMVCä¸­å¤„ç†ç‰¹å®šçš„è¯·æ±‚æ–¹æ³•çš„è¯·æ±‚ï¼Œåœ¨è¿™é‡Œå°±æ˜¯ç”¨åˆ°äº†`methodå±æ€§`

```JAVA
RequestMethod[] method() default {};
```

`RequestMethodæ•°ç»„`

â­ : å¯ä»¥å†™å•ä¸ªå€¼ï¼Œä¹Ÿå¯ä»¥å†™å¤šä¸ªå€¼ï¼Œå¦‚æœå†™å¤šä¸ªå€¼çš„è¯ï¼Œå¤šä¸ªå€¼ä¹‹é—´çš„å…³ç³»æ˜¯`OR`ã€‚

æ¯”å¦‚ï¼Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºå¯ä»¥å¤„ç†è¯·æ±‚æ˜¯`GET`æˆ–è€…`POST`ã€‚å› ä¸ºä¸€ä¸ªè¯·æ±‚æ–¹æ³•ä¸å¯èƒ½åŒæ—¶æ˜¯å¤šä¸ªï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æˆ–çš„å…³ç³»ã€‚

```JAVA
method = {RequestMethod.GET,RequestMethod.POST}
```

```java
@Controller
@RequestMapping("method")
public class RequestMethodLimitController {
    
    @RequestMapping(value = "get",method = RequestMethod.GET)
    @ResponseBody
    public String methodGet() {
        return "Method GET";
    }
    @RequestMapping(value = "post",method = RequestMethod.POST)
    @ResponseBody
    public String methodPost() {
        return "Method POST";
    }
    @RequestMapping(value = "double",method = {RequestMethod.GET,RequestMethod.POST})
    @ResponseBody
    public String methodDouble() {
        return "Method GET OR Method POST";
    }
}
```

**å¼•ç”³æ³¨è§£**ï¼šâ­ 

+ `@GetMapping`
+ `@PostMapping`

è¿™ä¸¤ä¸ªæ³¨è§£å°±æ˜¯é™å®šäº†è¯·æ±‚æ–¹æ³•çš„`@RequestMapping`

```java
@RequestMapping(
    method = {RequestMethod.GET}
)
public @interface GetMapping {}

@RequestMapping(
    method = {RequestMethod.POST}
)
public @interface PostMapping {}
```

æˆ‘ä»¬å¯ä»¥æ”¹é€ ä¸€ä¸‹æˆ‘ä»¬å‰é¢çš„æ–¹æ³•

```java
//@RequestMapping(value = "get",method = RequestMethod.GET)
@GetMapping("get")
@ResponseBody
public String methodGet() {
    return "Method GET";
}
//@RequestMapping(value = "post",method = RequestMethod.POST)
@PostMapping("post")
@ResponseBody
public String methodPost() {
    return "Method POST";
}
```

## è¯·æ±‚å‚æ•°é™å®š `params`

è¿™é‡Œçš„è¯·æ±‚å‚æ•°æŒ‡çš„æ˜¯ï¼š`key=value&key=value&key=value`è¿™ç§è¯·æ±‚å‚æ•°ï¼Œä½¿ç”¨`request.getParameter`æ–¹æ³•èƒ½å¤Ÿè·å¾—çš„è¿™ç§å‚æ•°ã€‚

å‡ºç°ä½ç½®ï¼š

1. `queryString`
1. è¯·æ±‚ä½“é‡Œ

å«ä¹‰ï¼š**å¿…é¡»**è¦æºå¸¦è¿™é‡ŒæŒ‡å®šçš„è¯·æ±‚å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰æºå¸¦åˆ™ä¼šæŠ¥é”™ã€‚

```JAVA
String[] params() default {};
```

â­ï¼šå€¼æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œæ„å‘³ç€å¯ä»¥å†™å¤šä¸ªå€¼ï¼Œå†™å¤šä¸ªå€¼çš„æƒ…å†µï¼Œå¤šä¸ªå€¼ä¹‹é—´çš„å…³ç³»æ˜¯`and` 

```java
@RequestMapping("params") // @RequestMappingæ³¨è§£çš„valueå±æ€§æ‰æ˜¯çª„åŒ–è¯·æ±‚
@Controller//("params")// Controlleræ³¨è§£æ˜¯ç»„ä»¶æ³¨å†ŒåŠŸèƒ½çš„æ³¨è§£ï¼Œvalueå±æ€§æŒ‡å®šçš„æ˜¯ç»„ä»¶çš„id
public class ParameterLimitController {

    //localhost:8080/params/login?username=songge&password=niupi
    //params = {"username","password"} å«ä¹‰ï¼šæ—¢è¦æºå¸¦usernameè¿™ä¸ªè¯·æ±‚å‚æ•°ï¼Œä¹Ÿè¦æºå¸¦password
    @RequestMapping(value = "login",params = {"username","password"})
    @ResponseBody
    public String login() {
        return "ok";
    }
}
```

## è¯·æ±‚å¤´é™å®š `headers`

é™å®šçš„æ˜¯è¯·æ±‚å¤´çš„`key`

![image-20230907091955415](.\assets\image-20230907091955415.png)

å†’å·å·¦ä¾§çš„éƒ¨åˆ†å°±æ˜¯è¯·æ±‚å¤´çš„`key`

> è¯·æ±‚æŠ¥æ–‡æœ‰å“ªäº›ç»„æˆéƒ¨åˆ†ï¼š 
>
> - è¯·æ±‚è¡Œ â†’ URI åè®® æ–¹æ³•
> - è¯·æ±‚å¤´
> - ï¼ˆç©ºè¡Œï¼‰
> - è¯·æ±‚ä½“

ä»ç„¶ä½¿ç”¨Postmanæ¥æ„é€ è¯·æ±‚

![image-20230907092020380](.\assets\image-20230907092020380.png)

```JAVA
String[] headers() default {};
```

ä¹Ÿæ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œå¤šä¸ªå€¼ä¹‹é—´çš„å…³ç³»ä¹Ÿæ˜¯`and`

```java
@Controller
@RequestMapping("header")
public class HeaderLimitController {

    // æ—¢è¦æºå¸¦abcè¿™ä¸ªè¯·æ±‚å¤´ï¼Œä¹Ÿè¦æºå¸¦defè¿™ä¸ªè¯·æ±‚å¤´
    @RequestMapping(value = "limit",headers = {"abc","def"})
    @ResponseBody
    public String headerLimit() {
        return "ok";
    }
}
```

## <span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**Con**</span>tent-Typeè¯·æ±‚å¤´å€¼é™å®š <span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**con**</span>sumes

> consumesï¼šæ¶ˆè´¹è€…
>
> producesï¼šç”Ÿäº§è€…

é™å®šçš„æ˜¯`Content-Type` è¿™ä¸ªè¯·æ±‚å¤´çš„å€¼

> 1. è¿™ä¸ªè¯·æ±‚å¤´çš„å«ä¹‰ï¼šè¯·æ±‚æºå¸¦çš„æ­£æ–‡çš„ç±»å‹ï¼ˆè¯·æ±‚ä½“ï¼‰
>
> 2. è¯­æ³•çš„æ ¼å¼ï¼š`Mime-Type` ä¹Ÿå°±æ˜¯ `xxx/xxx`
>
>    æ¯”å¦‚ä¸€ä¸ªjpgæ–‡ä»¶ï¼š`image/jpeg`
>
>    æ¯”å¦‚æ–‡æœ¬ï¼š`text/html`
>
>    æ¯”å¦‚jsonï¼š`application/json`

```java
@RequestMapping(value = "consumes",consumes = "abc/def")
@ResponseBody
public String contentTypeLimit() {
    return "ok";
}
```

## Ac<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**ce**</span>ptè¯·æ±‚å¤´å€¼é™å®š produ<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**ce**</span>så±æ€§

é™å®šçš„æ˜¯`Accept`è¿™ä¸ªè¯·æ±‚å¤´çš„å€¼ 

> 1. è¿™ä¸ªè¯·æ±‚çš„å«ä¹‰ï¼šå®¢æˆ·ç«¯å¸Œæœ›æ¥æ”¶åˆ°çš„æœåŠ¡ç«¯å“åº”çš„æ­£æ–‡ç±»å‹
>
> 2. è¯­æ³•çš„æ ¼å¼ï¼š`Mime-Type` ä¹Ÿå°±æ˜¯ `xxx/xxx`
>
>    æ¯”å¦‚ä¸€ä¸ªjpgæ–‡ä»¶ï¼š`image/jpeg`
>
>    æ¯”å¦‚æ–‡æœ¬ï¼š`text/html`
>
>    æ¯”å¦‚jsonï¼š`application/json`



![image-20230907092059016](.\assets\image-20230907092059016.png)

```java
@RequestMapping(value = "produces",produces = "application/json")
@ResponseBody
public String acceptLimit(){
    return "ok";
}
```

```java
// å¸Œæœ›æ¥æ”¶åˆ°æ­£æ–‡çš„charsetä¸ºutf-8
@RequestMapping(value = "chinese",produces = "text/html;charset=utf-8")
@ResponseBody
public String chinese() {
    return "è¿™æ˜¯ä¸­æ–‡";
    //å“åº”è¿™ä¸ªå­—ç¬¦ä¸²çš„æ˜¯SpringMVCç»™æˆ‘ä»¬å»å“åº”è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œ
    // é»˜è®¤çš„å€¼ï¼Œå“åº”å¤´ä¸­çš„Content-Typeçš„å€¼å˜ä¸ºäº†text/html;charset-iso-8859-1
}
```

![image-20230907092123094](.\assets\image-20230907092123094.png)

> ä¸­æ–‡ä¹±ç é—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¸€ï¼š
>
> Handlerè¿™é‡Œå¦‚æœç›´æ¥è¿”å›å­—ç¬¦ä¸²ï¼Œä¼šç”¨åˆ°`StringHttpMessageConverter`ï¼Œé»˜è®¤çš„charsetæ˜¯ISO-8859-1ï¼Œä¼šå‡ºç°ä¸­æ–‡ä¹±ç ï¼›
>
> è®¾ç½®`produces=â€œapplication/jsonâ€`åä¼šä½¿ç”¨`JsonHttpMessageConverter`ï¼Œé»˜è®¤çš„å­—ç¬¦é›†æ˜¯`utf-8`ï¼Œä»è€Œè§£å†³ä¹±ç é—®é¢˜ã€‚
>

æ‹¦æˆªå™¨è§£å†³ä¸äº†è¿™ä¸ªé—®é¢˜ï¼ŒSpringMVCçš„å­—ç¬¦ä¸²æ¶ˆæ¯å¤„ç†é‡Œé¢çš„é»˜è®¤çš„charsetä¸ºiso-8859-1ï¼ŒFilterå°±ç®—é€šè¿‡responseåšäº†è®¾ç½®ï¼Œä½†æ˜¯æ¶ˆæ¯å¤„ç†å™¨ä»ç„¶ç”¨çš„è¿˜æ˜¯é»˜è®¤çš„iso-8859-1ã€‚

â­ `BeanPostProcessor`å»ä¿®æ”¹å…¶é»˜è®¤çš„å­—ç¬¦é›†

> ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š
>
> **åˆ«äººå¸®ä½ æ³¨å†Œäº†ç»„ä»¶ï¼Œæ³¨å†Œçš„ç»„ä»¶é‡Œè®¾ç½®äº†ä¸€äº›é»˜è®¤å€¼ï¼Œæˆ‘ä»¬è¿˜èƒ½ä¿®æ”¹å—ï¼Ÿ**ğŸ·ï¸ 
>
> ç•™æ„`BeanPostProcessor`ï¼ˆé€šå¸¸ä½¿ç”¨`postProcessAfterInitialization`ä¸ºäº†å®Œæˆä¸€äº›åˆå§‹åŒ–ï¼‰
>
> ![image-20230914111842458](.\assets\image-20230914111842458.png)
>
> è¿™å¯ä»¥ä½œä¸ºä¸€ä¸ªäº®ç‚¹ã€‚

## å°ç»“

`@RequestMapping` æ³¨è§£å±æ€§å…¶å®å°±æ˜¯æä¾›äº†ä¸åŒä¿¡æ¯ï¼Œæˆ‘ä»¬è·å¾—è¿™äº›ä¸åŒçš„ä¿¡æ¯ï¼Œå®Œæˆäº†ä¸åŒçš„åŠŸèƒ½

> é€šå¸¸ä¸€ä¸ªæ³¨è§£æœ€æ ¸å¿ƒï¼ˆé‡è¦ï¼‰çš„å±æ€§å°±æ˜¯å…¶`value`å±æ€§ï¼Œå¯¹äº`@RequestMapping`æ³¨è§£ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå®ƒçš„æœ€é‡è¦çš„å±æ€§ä¹Ÿæ˜¯`value`å±æ€§ï¼Œæˆ‘ä»¬åç»­åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸»è¦ä½¿ç”¨çš„å°±æ˜¯å…¶`value`å±æ€§
>
> å…¶ä»–çš„å±æ€§ï¼ŒåŸºæœ¬ä¸Šå¾ˆå°‘ä½¿ç”¨ï¼Œä½†æ˜¯å‘¢ï¼Œä½ åªè¦æ˜¯åœ¨åšSpringMVCçš„å¼€å‘ï¼Œä¸€å®šä¼šç”¨åˆ°`@RequestMapping`æ³¨è§£å’Œå…¶`value`å±æ€§

# `Handler`æ–¹æ³•çš„è¿”å›å€¼

å‰é¢çš„æ¡ˆä¾‹ä¸­æˆ‘ä»¬è¿”å›å€¼å†™çš„éƒ½æ˜¯`String`ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„è¿”å›å€¼

## `ModelAndView`ï¼ˆäº†è§£ï¼‰

æ¯”è¾ƒè¿‡æ—¶äº†

ä¸»æµå¼€å‘æŠ€æœ¯ï¼šå‰åç«¯åˆ†ç¦»ï¼Œä½¿ç”¨`Json`åšäº¤äº’

`ModelAndView`ä¸»è¦æ˜¯ä¸ºå•ä½“åº”ç”¨æœåŠ¡çš„ï¼Œå•ä½“åº”ç”¨çš„è¯ï¼Œå‰ç«¯å’Œåç«¯éƒ½æ•´åˆåœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­

`ModelAndView`ä¸»è¦æ˜¯ç»™è®¿é—®å‰ç«¯çš„è§†å›¾å’Œæ•°æ®çš„ï¼Œå½“æœåŠ¡å™¨çš„è¿™ä¸ªæ–¹æ³•è¿”å›äº†ä¸€ä¸ª`ModelAndView`çš„è¯ï¼Œä¼šè®¿é—®åˆ°å‰ç«¯çš„å†…å®¹

ä¸¾ä¸ªä¾‹å­ï¼š`hello.jsp`

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>

</body>
</html>
```

é•¿ç›¸ç±»ä¼¼äº`html`

ç°è±¡ï¼šåœ¨`webapp`ç›®å½•ä¸‹æ”¾äº†ä¸€ä¸ª`banner.png`å’Œä¸€ä¸ª`hello.jsp` ä¸¤ä¸ªæ–‡ä»¶ï¼Œè®¿é—®`banner.png`äº§ç”Ÿäº†`404`æŠ¥é”™ï¼Œè®¿é—®`hello.jsp`æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®

åˆ†æï¼š

- æ˜¯å¦æ˜¯`DispatcherServlet`ä½œä¸ºç¼ºçœçš„`Servlet`å¤„ç†äº†`hello.jsp`è¿™ä¸ªè¯·æ±‚å‘¢ï¼Ÿ å¹¶ä¸æ˜¯
- æœ‰æ²¡æœ‰å¯èƒ½æœ‰å…¶ä»–çš„åŸå› å‘¢ï¼Ÿ Tomcatæä¾›äº†ä¸“é—¨å¤„ç†`jsp`çš„`Servlet`ï¼Œ`jsp` æœ¬èº«å°±æ˜¯ä¸€ç§`Servlet`
- Tomcatå¯¹`jsp`å¤„ç†æœ¬èº«å°±æ˜¯ç‰¹æ®Šçš„å¤„ç† â†’ `jsp` æ–‡ä»¶ä¼šè¢«ç¼–è¯‘`Servlet`

ç°åœ¨æƒ³è¦åšä¸€ä»¶äº‹æƒ…ï¼š` localhost:8080/hello?username=xxx` ,å‘é€è¿™ä¸ªè¯·æ±‚èƒ½å¤Ÿè®¿é—®åˆ°ä¸Šé¢çš„`hello.jsp`ï¼Œå¹¶ä¸”åœ¨é‡Œé¢èƒ½å¤Ÿè¾“å‡º`hello xxx`

è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ°`ModelAndView`ï¼Œ`ModelAndView`çš„ä½¿ç”¨ç±»ä¼¼äºå®Œå½¢å¡«ç©ºï¼Œ`View`æä¾›çš„æ˜¯é¢˜å¹²ï¼Œ`Model`æä¾›çš„é¢˜ç›®çš„åºå·å’Œç­”æ¡ˆ

```java
@Controller
public class ModelAndViewController {

  @RequestMapping("hello")
  public ModelAndView hello(String username) {// æ¥æ”¶å‚æ•°çš„è¿™ä¸ªæ–¹å¼å¤§å®¶å…ˆä¸ç”¨å…³æ³¨
    ModelAndView modelAndView = new ModelAndView();
    // åœ¨ModelAndViewä¸­è®¾ç½®å®ƒçš„Viewï¼Œè®©è¿™ä¸ªviewèƒ½å¤ŸæŒ‡å‘hello.jspè¿™ä¸ªæ–‡ä»¶
    modelAndView.setViewName("/hello.jsp");
    // å¦‚æœå¸Œæœ›åœ¨è§†å›¾æ–‡ä»¶ä¸­æ˜¾ç¤ºä¸€äº›å€¼ï¼Œé€šè¿‡Modelæ¥æä¾›ï¼ŒModelå°è£…çš„é”®å€¼å¯¹ï¼ˆMap<String,Object>ï¼‰
    modelAndView.addObject("username", username);
    return modelAndView;
  }
}
```

å’Œå‰é¢å†™çš„æ–¹æ³•çš„**å·®åˆ«**ï¼š

- è¿”å›å€¼å†™ä¸ºäº† `ModelAndView`
- åœ¨æ–¹æ³•ä¸Šå¹¶<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**æ²¡æœ‰å¢åŠ @ResponseBody**</span>

è¿˜æœ‰ä¸€ç§æ–¹å¼ä¹Ÿå¯ä»¥è¿”å›`ModelAndView`ï¼Œå¯ä»¥è¿”å›`String`ï¼Œè¿™ä¸ª`String`å­—ç¬¦ä¸²ä½œä¸º`ModelAndView`ä¸­çš„`viewName`æ¥ä½¿ç”¨

```java
@RequestMapping("hello2")
public String hello2(String username, Model model) {// æ¥æ”¶å‚æ•°çš„è¿™ä¸ªæ–¹å¼å¤§å®¶å…ˆä¸ç”¨å…³æ³¨
    model.addAttribute("username", username);
    return "/hello.jsp";
}
```

å’Œæˆ‘ä»¬å‰é¢è¿”å›å€¼ä¸º`String`çš„å«ä¹‰ä¸ä¸€æ ·ï¼šåœ¨æ–¹æ³•ä¸Šå¹¶<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**æ²¡æœ‰å¢åŠ @ResponseBody**</span>

## `Json`ğŸŒŸ 

æ ¸å¿ƒæ³¨è§£å°±æ˜¯`@ResponseBody`

éœ€è¦åšä¸€äº›å‡†å¤‡ï¼š

- jacksonç›¸å…³ä¾èµ–ï¼ˆ`jackson-databind`ï¼‰
- `@EnableWebMvc`
- æ–¹æ³•ä¸Šï¼ˆæˆ–ç±»ä¸Šï¼‰å¢åŠ æ³¨è§£`@ResponseBody`

### Stringï¼ˆå¹¶ä¸å»ºè®®ç»§ç»­ä½¿ç”¨äº†ï¼‰

åç»­æˆ‘ä»¬å¹¶ä¸ç›´æ¥è¿”å›Stringäº†ï¼Œå› ä¸ºè¿™æ ·å­å†™æ¯”è¾ƒç¹çï¼Œå¤§å®¶è¿˜éœ€è¦å¤„ç†å­—ç¬¦é›†é—®é¢˜ã€‚è¿”å›å€¼ä¸º`String`çš„è¯ï¼Œå®ƒçš„å­—ç¬¦é›†é»˜è®¤æ˜¯`ISO-8859-1`ã€‚

### Objectï¼ˆä½ å†™å•¥ç±»å‹éƒ½è¡Œï¼‰

ç›´æ¥è¿”å›é›†åˆæˆ–å¼•ç”¨ç±»å‹å¯¹è±¡å°±å¯ä»¥äº†

ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ï¼šæƒ³è¦è¿”å›ä¸€ä¸ªUserå®ä¾‹å¯¹åº”çš„Jsonå­—ç¬¦ä¸²çš„æ–¹æ³•

```java
@RequestMapping("json")
@Controller
public class JsonController {

    @RequestMapping("user")
    @ResponseBody
    public User user() {
        User user = new User("å¼ æ¾", "è¿œå¿—", 30);
        return user;
    }
}
```

æ³¨è§£è¿”å›Userå¯¹è±¡å°±å¯ä»¥äº†ï¼ŒJacksonä¼šè‡ªåŠ¨çš„å¸®æˆ‘ä»¬è¿›è¡Œè½¬æ¢ï¼Œ å¹¶ä¸”ä¹Ÿä¸éœ€è¦è®¾ç½®å­—ç¬¦é›†ï¼Œè¿”å›å€¼çš„ä¸­æ–‡æ²¡æœ‰ä¹±ç ã€‚

### è¿›ä¸€æ­¥ä½¿ç”¨

çœ‹ä¸€ä¸‹`@ResponseBody`æ³¨è§£

```java
@Target({ElementType.TYPE, ElementType.METHOD})// è¿™ä¸ªæ³¨è§£å¯ä»¥å†™åœ¨ç±»ä¸Šï¼Œä¹Ÿå¯ä»¥å†™åœ¨æ–¹æ³•ä¸Š
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface ResponseBody {
}
```

æˆ‘ä»¬å‰é¢å­¦è¿‡çš„ä»€ä¹ˆæ³¨è§£ï¼Œä¹Ÿæ˜¯å¯ä»¥å†™åœ¨ç±»ä¸Šï¼Œä¹Ÿå¯ä»¥å†™åœ¨æ–¹æ³•ä¸Šï¼š

+ `@RequestMapping`
+ `@Transactional`

<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**@ResponseBodyå¦‚æœå†™åœ¨ç±»ä¸Šï¼Œæ„å‘³ç€å½“å‰ç±»ä¸‹æ‰€æœ‰çš„æ–¹æ³•å“åº”çš„éƒ½æ˜¯å­—ç¬¦ä¸²æˆ–Jsonå­—ç¬¦ä¸²**</span>

```java
@RequestMapping("json")
@Controller
@ResponseBody
public class JsonController {

    @RequestMapping("user")
    //@ResponseBody
    public User user() {
        User user = new User("å¼ æ¾", "è¿œå¿—", 30);
        return user;
    }
}
```

**å¼•ç”³æ³¨è§£ï¼š**

 â­**`@RestController `= `@Controller `+ `@ResponseBody`**

```java
@RequestMapping("json")
//@Controller
//@ResponseBody
@RestController
public class JsonController {

    @RequestMapping("user")
    //@ResponseBody
    public User user() {
        User user = new User("å¼ æ¾", "è¿œå¿—", 30);

        return user;
    }
}
```

`@RestController`æ³¨è§£åœ¨åç»­çš„å¼€å‘è¿‡ç¨‹ä¸­éå¸¸å¸¸ç”¨ï¼ŒåŸºæœ¬ä¸Šæˆ‘ä»¬æ‰€æœ‰çš„æ–¹æ³•å“åº”çš„éƒ½æ˜¯`Json`ã€‚

### æ³¨æ„äº‹é¡¹

ä¸ä»…ä»…æ˜¯è¿™é‡Œå“åº”`JSON`ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨ä»»æ„ä¸€ä¸ª`Json`å·¥å…·çš„æ—¶å€™éƒ½éœ€è¦æ³¨æ„çš„ä¸€ä¸ªç‚¹ï¼Œä¸ç®¡ç”¨çš„æ˜¯`Jackson`è¿˜æ˜¯`Gson`è¿˜æ˜¯`fastJson`ç­‰å·¥å…·ï¼Œéƒ½éœ€è¦æ³¨æ„ï¼š

<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**å¼•ç”¨æ•°æ®ç±»å‹ç±»å‹è¿™ä¸ªç±»éœ€è¦æä¾›ï¼šæ— å‚æ„é€ æ–¹æ³•å’ŒGetter/Setteræ–¹æ³•**</span>

å¦‚æœæ²¡æœ‰æä¾›ï¼Œ`Json`è½¬æ¢è¿‡ç¨‹ä¼šæŠ¥é”™ã€‚`vo`çš„å°è£…æ˜¯å¼€å‘è¿‡ç¨‹ä¸­éå¸¸å¸¸è§„çš„ä½¿ç”¨ã€‚

```java
@Data
public class BaseRespVo <T>{
    T data;
    String msg;
    int status;
    
    // å¯ä»¥åœ¨voä¸­å¢åŠ ä¸€äº›é™æ€æ–¹æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬å®Œæˆä¸€äº›å°è£…
    public static BaseRespVo ok() {
        BaseRespVo baseRespVo = new BaseRespVo();
        baseRespVo.setMsg("æˆåŠŸ");
        baseRespVo.setStatus(200);
        return baseRespVo;
    }
    public static <T> BaseRespVo ok(T data) {
        BaseRespVo<T> baseRespVo = new BaseRespVo();
        baseRespVo.setData(data);
        baseRespVo.setMsg("æˆåŠŸ");
        baseRespVo.setStatus(200);
        return baseRespVo;
    }
}
```

```java
@RequestMapping("vo")
public BaseRespVo vo() {
		// "hello vo" ä½œä¸ºBaseRespVoå¯¹è±¡ä¸­çš„dataçš„ï¼Œä¹Ÿå¯ä»¥å†™å…¶ä»–çš„Objectç±»å‹çš„å€¼
    return BaseRespVo.ok("hello vo");
}
```

> åœ¨ä½¿ç”¨ä»»ä½•å®ä½“ç±»çš„æ—¶å€™ï¼Œå¦‚æœå¢åŠ äº†æœ‰å‚æ„é€ æ–¹æ³•ï¼Œä¸€å®šè¦å¢åŠ æ— å‚æ„é€ æ–¹æ³•ã€‚å› ä¸ºé»˜è®¤ç”Ÿæˆçš„æ— å‚æ„é€ æ–¹æ³•åœ¨æœ‰æœ‰å‚æ„é€ æ—¶ä¸ä¼šæä¾›ã€‚

# å½¢å‚

å½¢å‚çš„æ¥æ”¶è¦å½’åŠŸäº `HandlerAdapter`ã€‚

æ–¹æ³•çš„å½¢å‚ï¼šä¸»è¦åšçš„äº‹æƒ…æ˜¯**æ¥æ”¶è¯·æ±‚å‚æ•°** ä»¥åŠä¸€äº›å…¶ä»–çš„ä¿¡æ¯

- `key=value`å½¢å¼çš„è¯·æ±‚å‚æ•°
- `Json`å½¢å¼çš„è¯·æ±‚å‚æ•°
- `multipart/form-data`æäº¤æ–‡ä»¶

ç¹ççš„ç‚¹ï¼š

+ `key = value`å¦‚æœå‚æ•°æ¯”è¾ƒå¤šï¼Œè¦ä¾æ¬¡å°è£…æˆ–ä½¿ç”¨`BeanUtils`è¿™æ ·çš„å·¥å…·ç±»ï¼Œè¿˜è¦åšç±»å‹å¤„ç†ã€‚

+ `Json`éœ€è¦æ‰‹åŠ¨è°ƒç”¨`Jackson`å°†å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡

+ `multipart/form-data`éœ€è¦è·å¾—`inputStream`ï¼Œæ‰‹åŠ¨åˆ›å»º`outputStream`æ¥å†™å…¥

ä¼˜åŒ–

+ `key = value`ï¼šåœ¨`Handler`æ–¹æ³•çš„å½¢å‚ä¸Šï¼Œç›´æ¥å†™è¯·æ±‚å‚æ•°
+ `Json`ï¼šåœ¨`Handler`æ–¹æ³•çš„å½¢å‚ä¸ŠåŠ ä¸€ä¸ªæ³¨è§£`@RequestBody`,å¯ä»¥ä½¿ç”¨`String`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`Map`
+ `multipart/form-data`ï¼šåœ¨`Handler`æ–¹æ³•çš„å½¢å‚ä¸Šï¼Œç›´æ¥å†™è¯·æ±‚å‚æ•°

## `key=value`å½¢å¼çš„è¯·æ±‚å‚æ•°

1. åŸºæœ¬ç±»å‹ä»¥åŠå¯¹åº”çš„åŒ…è£…ç±»ã€`String`ï¼Œå¯ä»¥ç›´æ¥æ¥æ”¶ã€‚æ¡ä»¶æ˜¯ï¼š**è¯·æ±‚å‚æ•°åå’Œå½¢å‚åä¸€è‡´**ã€‚SpringMVCæä¾›äº†ç±»å‹å¤„ç†å™¨ã€‚

2. è¯·æ±‚å‚æ•°æœ‰æ•°ç»„ï¼ˆç›¸åŒçš„`key`ç­‰äºå¤šä¸ªå€¼ä¹Ÿå°±æ˜¯æ•°ç»„ï¼‰ã€‚å½¢å‚å¯ä»¥ä½¿ç”¨å¯¹åº”åŒ…è£…ç±»çš„æ•°ç»„æ¥æ”¶ã€‚

3. æ—¥æœŸæ ¼å¼ï¼š

   1. å¯ä»¥ç”¨Stringæ¥æ”¶ï¼Œç„¶åè¿›è¡Œæ—¥æœŸè½¬æ¢

      ```JAVA
      SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd")
      Date startDate = sdf.parse(start); 
      ```

   2. å¯ä»¥ä½¿ç”¨`Date`æ¥æ¥æ”¶

      1. è¦æ±‚ï¼šè¯·æ±‚å‚æ•°åå’Œå½¢å‚åä¸€è‡´ã€‚

      2. é»˜è®¤æ ¼å¼ï¼š`yyyy/MM/dd`

      3. éé»˜è®¤æ ¼å¼éœ€è¦æ³¨è§£æŒ‡å®š

         ```JAVA
         @DateTimeFormat(patttern = "yyyy-MM-dd")
         ```
   
4. `multipart/form-data`ï¼šæœ¬è´¨ä¹Ÿæ˜¯ä¸€ç§`key = value`ã€‚`key`æ˜¯nameã€‚

   1. å¼•å…¥ä¾èµ–ï¼š`commons-fileupLoad`(ä¼šè‡ªåŠ¨å¼•å…¥`commons-io`ï¼‰ 

   2. æ³¨å†Œä¸€ä¸ªç»„ä»¶  ğŸ·ï¸`mutipartResolver` ğŸ·ï¸ï¼Œåœ¨`WebConfiguration`é…ç½®ç±»ä¸­ã€‚è¯¥ç»„ä»¶çš„åå­—ä¸å¯ä»¥æ”¹æˆåˆ«çš„ã€‚

      ```JAVA
      @EnableWebMvc
      @ComponentScan("com.cskaoyan.demo5.controller")
      public class WebConfiguration implements WebMvcConfigurer {
      
          /**
           * å¼•å…¥commons-fileupload(io)
           * @return
           */
          @Bean
          public CommonsMultipartResolver multipartResolver() {
              CommonsMultipartResolver resolver = new CommonsMultipartResolver();
              return resolver;
          }
      }
      ```

   3. ç›´æ¥åœ¨å‚æ•°ä¸­å†™ `MultipartFile file`

      ```JAVA
      @RestController
      @RequestMapping("admin/storage")
      public class AdminStorageController {
      
          @Autowired
          StorageService storageService;
      
          @SneakyThrows
          @RequestMapping("create")
          public BaseRespVo create(MultipartFile file) { 
              // åœ¨Parté‡Œèƒ½å¤Ÿæ‹¿åˆ°çš„ä¿¡æ¯ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡ä¹Ÿèƒ½æ‹¿åˆ°
              // æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œèƒ½å¤Ÿç›´æ¥ä¿å­˜åˆ°æŒ‡å®šä½ç½®
      
              MarketStorage storage = MarketStorage.builder()
                      .key(randomFileName)
                      .size((int) size)
                      .type(contentType)
                      .name(originalFilename)
                      .url("http://localhost:8080/demo5/storage/fetch/" + randomFileName)
                      .addTime(new Date())
                      .updateTime(new Date())
                      .build();
              storageService.save(storage);
      
              return BaseRespVo.ok(storage);
          }
      }
      ```
      
   
1. ï¼ˆåœ¨`Part`å¯ä»¥è·å¾—çš„ä¿¡æ¯ï¼Œè¯¥å¯¹è±¡ä¹Ÿå¯ä»¥è·å¾—ï¼‰
   
   ```JAVA
   	String contentType = file.getContentType();//ç±»å‹
   	long size = file.getSize();//æ–‡ä»¶å¤§å°
   	String originalFilename = file.getOriginalFilename();//æ–‡ä»¶çš„åŸå§‹å
   ```
   
2.  â­ æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œèƒ½å¤Ÿç›´æ¥ä¿å­˜åˆ°æŒ‡å®šä½ç½®ï¼š`transferTo(File)`
    
   ```JAVA
   	file.transferTo(File file);
   ```
   
   > å¦‚ä½•å¾—åˆ°æ–‡ä»¶çš„åç¼€ï¼ŸğŸ·ï¸ 
   >
   > ```java
   > String suffix = originalFilename.substring(originalFilename.lastIndexOf("."));
   > ```
   
   > å¦‚ä½•éšæœºç”Ÿæˆä¸€ä¸ªåå­—ï¼ŸğŸ·ï¸ 
         >
         > ```JAVA
         > String randomName = UUID.randomUUID().toString().replaceAll("-", "");
         > ```
   

æ¥æ”¶æ–¹å¼ï¼š

å½¢å‚ä¸Šä½¿ç”¨å¼•ç”¨ç±»å‹å¯¹è±¡æ¥æ¥æ”¶ï¼šå°†å½¢å‚ä½œä¸ºå¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œè¦é€šè¿‡`set`æ–¹æ³•èµ‹å€¼ï¼ˆè‡ªåŠ¨è¿›è¡Œï¼‰ã€‚

æ··åˆæ¥æ”¶ï¼šå°è£…ä¸ºä¸¤ä¸ªå¯¹è±¡ã€‚

ä¾‹å¦‚ï¼š

> ```html
> localhost:8080/user/register1?username=songge&password=niupi&age=40
> ```

è¯·æ±‚ä½“

```html
username=songge&password=niupi&age=40
```

æˆ‘ä»¬é€šè¿‡å½¢å‚æ¥æ¥æ”¶è¿™äº›è¯·æ±‚å‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ç¨‹æ¥åšè¿™ä»¶äº‹

```java
@RequestMapping("user")
@RestController// = @Controller + @ResponseBody
public class UserController {

    //localhost:8080/user/register1?username=songge&password=niupi&age=40
    @RequestMapping("register1")
    public BaseRespVo register1(String username,String password,String age) {
        System.out.println("username = " + username);
        System.out.println("password = " + password);
        System.out.println("age = " + age);
        return BaseRespVo.ok();
    }
}
```

æ§åˆ¶å°é‡Œæ‰“å°äº†å¯¹åº”çš„å†…å®¹

```java
username = songge
password = niupi
age = 40
```

è¯´æ˜æˆ‘ä»¬å·²ç»æ¥æ”¶åˆ°äº†è¿™äº›è¯·æ±‚å‚æ•°æ‰€å¯¹åº”çš„å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬åšçš„äº‹æƒ…ï¼š<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**è¯·æ±‚å‚æ•°åå’Œæ–¹æ³•çš„å½¢å‚åä¸€è‡´**</span>ã€‚

SpringMVCç»™æˆ‘ä»¬å»æ¥æ”¶è¿™äº›å‚æ•°ï¼Œå®ƒå¸®æˆ‘ä»¬ä½¿ç”¨`request.getParameter`æ¥æ¥æ”¶äº†ï¼Œè€Œ`request.getParameter`è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ï¼Œå®ƒçš„ç±»å‹çš„æ˜¯ä»€ä¹ˆï¼Ÿ `String`ã€‚

æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨`String`æ¥è¿›è¡Œæ¥æ”¶ï¼Œå°±ç›´æ¥æ¥æ”¶åˆ°äº†ã€‚

SpringMVCå°±è¿™ï¼Ÿä¸ä»…ä»…å°±è¿™

### â­ `String`ã€åŸºæœ¬ç±»å‹ä»¥åŠå¯¹åº”çš„åŒ…è£…ç±»

ç›´æ¥æ¥æ”¶ï¼š<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**è¯·æ±‚å‚æ•°åå’Œæ–¹æ³•çš„å½¢å‚åä¸€è‡´**</span>

> å¯ä»¥ä½¿ç”¨åŸºæœ¬ç±»å‹æˆ–å…¶åŒ…è£…ç±»æ¥æ”¶çš„æ—¶å€™ï¼Œå»ºè®®ä½¿ç”¨åŒ…è£…ç±»æ¥æ¥æ”¶ï¼šå¥å£®æ€§
>
> åŒ…è£…ç±»å¯ä»¥ä¸º`null`ï¼Œä½†æ˜¯åŸºæœ¬ç±»å‹ä¸èƒ½ä¸º`null`ã€‚

```java
// localhost:8080/user/register2?username=songge&password=niupi&age=40
@RequestMapping("register2")
// public BaseRespVo register2(String username,String password,int age) {}
public BaseRespVo register2(String username,String password,Integer age) {
    System.out.println("username = " + username);
    System.out.println("password = " + password);
    System.out.println("age = " + age);
    return BaseRespVo.ok();
}
```

> ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨åŸºæœ¬ç±»å‹æˆ–å¯¹åº”çš„åŒ…è£…ç±»æ¥è¿›è¡Œæ¥æ”¶ï¼Œ`request.getParameter`è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¸æ˜¯`String` å—ï¼Ÿ
>
> ä¸Šé¢è¿™ä¸ªæ¡ˆä¾‹æˆ‘ä»¬ç”¨`Integer`ç±»å‹çš„`age`æ¥æ¥æ”¶è¿™ä¸ªè¯·æ±‚å‚æ•°çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†è¿™æ ·çš„äº‹æƒ…
>
> - ```java
>   String result = request.getParameter("age");
>   ```
> - SpringMVCç»™æˆ‘ä»¬æä¾›äº†ç±»å‹è½¬æ¢å™¨`converter`ï¼Œè½¬æ¢å™¨èƒ½å¤Ÿå°†`String`ç±»å‹çš„å€¼è½¬æ¢ä¸ºæˆ‘ä»¬éœ€è¦`Integer`ç±»å‹çš„å€¼
> - SpringMVCä¸ä»…ä»…æä¾›äº†  `String` â†’ `Integer`è¿™æ ·çš„ç±»å‹è½¬æ¢å™¨ï¼Œè¿™äº›åŸºæœ¬ç±»å‹ä»¥åŠå¯¹åº”çš„åŒ…è£…ç±»éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ç±»å‹è½¬æ¢å™¨ ï¼ˆ124ä¸ªï¼‰

### Date

æˆ‘ä»¬è‡ªå·±å†™çš„æ—¥æœŸè½¬æ¢çš„ä»£ç 

```java
String string = "2022/12/23";
// å°†è¿™ä¸ªStringè½¬æ¢ä¸ºDateçš„ä»£ç å¦‚ä½•å†™
String pattern = "yyyy/MM/dd"; // æ—¥æœŸçš„æ ¼å¼
SimpleDateFormat simpleDateFormat = new SimpleDateFormat(pattern);
Date date = simpleDateFormat.parse(string);
```

é€šè¿‡ä¸Šé¢åˆ°äº†ä»£ç ï¼š`String â†’ Date` çš„è¿‡ç¨‹ä¸­éœ€è¦`pattern`ä¿¡æ¯ï¼ˆæ ¼å¼ä¿¡æ¯ï¼‰

SpringMVCæä¾›çš„`String â†’ Date` çš„è½¬æ¢å™¨ï¼Œæ‰§è¡Œè½¬æ¢çš„è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯éœ€è¦`pattern` ä¿¡æ¯çš„

- ä¸€ç§æ˜¯ï¼šé‡‡ç”¨é»˜è®¤çš„`pattern` ä¿¡æ¯ â†’` yyyy/MM/dd`
- å¦ä¸€ç§ï¼šä½¿ç”¨`@DateTimeFormat`æ³¨è§£çš„`pattern`å±æ€§æŒ‡å®š

> localhost:8080/user/register3?username=songge&password=niupi&age=30&birthday=2022/06/21
>
> - æœŸæœ›ç”¨çš„æ˜¯é»˜è®¤çš„`pattern` â†’ `yyyy/MM/dd`
>
> localhost:8080/user/register4?username=songge&password=niupi&age=30&birthday=2022-06-21
>
> - æœŸæœ›æŒ‰ç…§`@DateTimeFormat`æ³¨è§£çš„`pattern`å±æ€§å€¼çš„æ ¼å¼åšè½¬æ¢

æ³¨æ„ï¼š<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**è¯·æ±‚å‚æ•°åå’Œæ–¹æ³•çš„å½¢å‚åä¸€è‡´**</span>

```java
//localhost:8080/user/register3?username=songge&password=niupi&age=30&birthday=2022/06/21
@RequestMapping("register3")
public BaseRespVo register3(String username, String password, Integer age,
                            Date birthday) {
    System.out.println("birthday = " + birthday);
    return BaseRespVo.ok();
}
//localhost:8080/user/register4?username=songge&password=niupi&age=30&birthday=2022-06-21
@RequestMapping("register4")
public BaseRespVo register4(String username,String password,Integer age,
                            @DateTimeFormat(pattern = "yyyy-MM-dd") Date birthday) {
    System.out.println("birthday = " + birthday);
    return BaseRespVo.ok();
}
```

### æ•°ç»„

å¯ä»¥ç›´æ¥åœ¨å½¢å‚ä¸­ä½¿ç”¨æ•°ç»„æ¥æ¥æ”¶

å‰é¢èƒ½å¤Ÿæ¥æ”¶åˆ°çš„è¿™ä¸ªç±»å‹çš„å€¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹åº”ç±»å‹çš„æ•°ç»„æ¥æ¥æ”¶

åŒä¸€ä¸ª`key`æœ‰å¤šä¸ª`value`æ—¶å°±éœ€è¦æ•°ç»„æ¥æ”¶ã€‚å¦‚ä¸‹é¢ä¾‹å­ä¸­çš„`hobbies`&`ids`

```java
//localhost:8080/user/register5?username=songge&password=niupi&age=30
// &hobbies=sing&hobbies=dance&hobbies=rap&ids=1&ids=2&ids=3
@RequestMapping("register5")
public BaseRespVo register5(String username,String password,Integer age,
                            String[] hobbies,Integer[] ids) {
    //String[] hobbies = request.getParameterValues("hobbies");
    System.out.println("hobbies = " + Arrays.asList(hobbies));
    System.out.println("ids = " + Arrays.asList(ids));
    return BaseRespVo.ok();
}
```

> æ€è€ƒï¼šå¼€å‘è¿‡ç¨‹ä¸­ä»€ä¹ˆåœºæ™¯ä½¿ç”¨æ•°ç»„ï¼Ÿ å¤šé€‰é¢˜
>
> æ¯”å¦‚ä½ è¦æŸ¥è¯¢è®¢å•ä¿¡æ¯ï¼šæŸ¥è¯¢æœªæ”¶è´§ 101ã€å·²ä»˜æ¬¾201çŠ¶æ€çš„è®¢å•ä¿¡æ¯
>
> è¿™æ ·çš„sqlè¯­å¥åº”è¯¥å¦‚ä½•å†™ï¼Ÿ

```sql
--- è¿™æ ·å†™å¹¶ä¸å¥½
select * from cskaoyan_order where order_status = 101 or order_status = 201
--- åº”è¯¥ä½¿ç”¨çš„æ˜¯inè¯­å¥
select * from cskaoyan_order where order_status in (101,201)
--- ä½¿ç”¨mybatisçš„foreachæ ‡ç­¾æ¥åšæ‹¼æ¥
```

### æ–‡ä»¶ `MultipartFile`

> localhost:8080/upload/file
>
> localhost:8080/upload/files

è¿™ä¸¤ä¸ªè¯·æ±‚ä¼šæäº¤æ–‡ä»¶ï¼Œå¯ä»¥æ¥æ”¶åˆ° â†’ å¯¹åº”JavaEEé˜¶æ®µçš„`fileupload`

å¯ä»¥æ¥æ”¶åˆ°æ–‡ä»¶ï¼Œå¹¶ä¸”ä¿å­˜åˆ°æœ¬åœ°

å¦‚æœæˆ‘ä»¬è¦åšæ–‡ä»¶ä¸Šä¼ ï¼Œæˆ‘ä»¬çš„è¯·æ±‚å¦‚ä½•æ„é€ ï¼Ÿ

é€šè¿‡`form`è¡¨å•æ¥æ„é€ è¯·æ±‚ï¼Œæ³¨æ„ï¼š`input`æ ‡ç­¾çš„`name`å±æ€§å°±æ˜¯è¯·æ±‚å‚æ•°å

```html
<form action="/upload/file" enctype="multipart/form-data" method="post">
    <input type="file" name="myfile"/><br>
    <input type="submit"/>
</form>
å¦‚æœè¦ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œinputæ ‡ç­¾ä¸­å¢åŠ ä¸€ä¸ªmultipleå±æ€§
<form action="/upload/files" enctype="multipart/form-data" method="post">
    <input type="file" multiple name="myfiles"/><br>
    <input type="submit"/>
</form>
```

ä½¿ç”¨Postmanæ¥åšè¯·æ±‚çš„æ„é€ 

![image-20230907092218238](.\assets\image-20230907092218238.png)

éœ€è¦åšçš„äº‹æƒ…

- `commons-io`å’Œ`commons-fileupload`ä¾èµ–

  - ```xml
    <!--å¼•å…¥commons-fileuploadæ—¶å€™ä¹Ÿä¼šå°†commons-ioå¼•å…¥-->
    <dependency>
        <groupId>commons-fileupload</groupId>
        <artifactId>commons-fileupload</artifactId>
        <version>1.4</version>
    </dependency>
    ```

- éœ€è¦å‘å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ªç»„ä»¶ï¼Œ`multipartResolver`è¿™ä¸ªç»„ä»¶`id`å¿…é¡»ä¸º`multipartResolver`ï¼Œä¸èƒ½ä¸ºå…¶ä»–å€¼ï¼ŒSpringMVCåœ¨ä½¿ç”¨è¿™ä¸ªç»„ä»¶çš„æ—¶å€™`applicationContext.getBean("multipartResolver")`

  - å¯ä»¥åœ¨`xml`ä¸­æ³¨å†Œï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®ç±»ä¸­æ³¨å†Œ

  - ```JAVA
    @Configuration
    public class MvcConfiguration {
        // ç»„ä»¶idä¸€å®šè¦æ˜¯multipartResolver
        @Bean("multipartResolver")
        public CommonsMultipartResolver multipartResolver() {
            CommonsMultipartResolver commonsMultipartResolver = new CommonsMultipartResolver();
            // commonsMultipartResolver.set å¯ä»¥ä½¿ç”¨å…¶setæ–¹æ³•åšä¸€äº›è®¾ç½®
            return commonsMultipartResolver;
        }
    }
    ```

- æ–¹æ³•çš„å½¢å‚ä¸­ä½¿ç”¨`MultipartFile`æ¥æ¥æ”¶

æ³¨æ„ï¼š<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**è¯·æ±‚å‚æ•°åå’Œæ–¹æ³•çš„å½¢å‚åä¸€è‡´**</span>

```java
@RestController
@RequestMapping("upload")
public class UploadController {

    @RequestMapping("file")
    public BaseRespVo file(MultipartFile myfile) {
        return BaseRespVo.ok();
    }
}
```

æ¥æ”¶åˆ°`MultipartFile`ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåšä»€ä¹ˆäº‹æƒ…ï¼Œå–å†³äº`MultipartFile` ç»™æˆ‘ä»¬æä¾›äº†ä»€ä¹ˆæ–¹æ³•ï¼Ÿ

| æ–¹æ³•å                                                       | æè¿°                                                         | è¿”å›å€¼   |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- |
| `getOriginFileName()`                                        | è·å¾—ä¸Šä¼ æ—¶çš„æ–‡ä»¶å                                           | `String` |
| `getContentType()`                                           | è·å¾—ä¸Šä¼ çš„æ–‡ä»¶çš„æ­£æ–‡ç±»å‹ï¼Œæ¯”å¦‚ä¸Šä¼ `banner.png`ï¼Œæ­£æ–‡ç±»å‹å°±æ˜¯`image/png` | `String` |
| `getName()`                                                  | è·å¾—æ˜¯è¯·æ±‚å‚æ•°åï¼ˆæ²¡å•¥ç”¨ï¼‰                                   | `String` |
| `getSize()`                                                  | è·å¾—æ–‡ä»¶å¤§å°                                                 | `long`   |
| <span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**transferTo(File)**</span> | æä¾›çš„å‚æ•°æ˜¯`File`ç±»å‹çš„å€¼ï¼Œ`File`æä¾›çš„ä¿å­˜ä½ç½®åŠæ–‡ä»¶åï¼Œå°±å¯ä»¥ä¿å­˜è¿™ä¸ªæ–‡ä»¶ | `void`   |

```java
@RequestMapping("file")
public BaseRespVo file(MultipartFile myfile) {
    String name = myfile.getName(); // myfile
    String originalFilename = myfile.getOriginalFilename(); //å¦‚æœä¸Šä¼ çš„æ˜¯banner.png â†’ banner.png
    String contentType = myfile.getContentType(); // image/png
    long size = myfile.getSize();
    // æ¯”å¦‚æˆ‘ä»¬è¦ä¿å­˜åˆ°D:\tmpè·¯å¾„ä¸‹ï¼Œä¿å­˜çš„æ–‡ä»¶åå«banner.png ï¼Œæˆ‘ä»¬å°±è¦æä¾›ä¸€ä¸ªè¿™æ ·çš„File
    //File file = new File("D:\\tmp\\banner.png");
    //File file = new File("D:\\tmp\\","banner.png");
    // ä¿å­˜æ—¶ä»¥åŸå§‹çš„æ–‡ä»¶åä¿å­˜ï¼Œå¦‚æœä¸Šä¼ åŒåæ–‡ä»¶ä¼šè¦†ç›– â†’ JavaEE  hashcodeå’Œuuid
    File file = new File("D:\\tmp\\",originalFilename);
    try {
        myfile.transferTo(file);
    } catch (IOException e) {
        e.printStackTrace();
    }
    return BaseRespVo.ok();
}
```

ä¹Ÿå¯ä»¥ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨æ•°ç»„æ¥æ¥æ”¶

```java
private void uploadSingleFile(MultipartFile myfile) {
    String name = myfile.getName(); // myfile
    String originalFilename = myfile.getOriginalFilename(); //å¦‚æœä¸Šä¼ çš„æ˜¯banner.png â†’ banner.png
    String contentType = myfile.getContentType(); // image/png
    long size = myfile.getSize();
    // æ¯”å¦‚æˆ‘ä»¬è¦ä¿å­˜åˆ°D:\tmpè·¯å¾„ä¸‹ï¼Œä¿å­˜çš„æ–‡ä»¶åå«banner.png ï¼Œæˆ‘ä»¬å°±è¦æä¾›ä¸€ä¸ªè¿™æ ·çš„File
    //File file = new File("D:\\tmp\\banner.png");
    //File file = new File("D:\\tmp\\","banner.png");
    // ä¿å­˜æ—¶ä»¥åŸå§‹çš„æ–‡ä»¶åä¿å­˜ï¼Œå¦‚æœä¸Šä¼ åŒåæ–‡ä»¶ä¼šè¦†ç›– â†’ JavaEE  hashcodeå’Œuuid
    File file = new File("D:\\tmp\\",originalFilename);
    try {
        myfile.transferTo(file);
    } catch (IOException e) {
        e.printStackTrace();
    }
}

@RequestMapping("files")
public BaseRespVo files(MultipartFile[] myfiles) {
    for (MultipartFile myfile : myfiles) {
        uploadSingleFile(myfile);
    }
    return BaseRespVo.ok();
}
```

###  â­ ä½¿ç”¨å¼•ç”¨ç±»å‹æ¥æ”¶

ä»ç„¶æ˜¯ä¸Šé¢çš„è¿™äº›è¯·æ±‚ï¼Œä¸Šé¢è¿™äº›è¯·æ±‚ï¼Œå®ƒçš„è¯·æ±‚å‚æ•°ï¼Œæ˜¯æ”¾åœ¨æ–¹æ³•çš„å½¢å‚ä¸­ã€‚

ä½¿ç”¨å¼•ç”¨ç±»å‹çš„è¯ï¼Œå°†æ¥æ”¶åˆ°çš„å½¢å‚ï¼Œå°è£…ä¸ºä¸€ä¸ªå¼•ç”¨ç±»å‹å¯¹è±¡ï¼Œè¿™ä¸ªå¼•ç”¨ç±»å‹çš„å¯¹è±¡çš„æˆå‘˜å˜é‡å°è£…çš„å°±æ˜¯è¿™äº›å½¢å‚çš„å€¼ã€‚

> localhost:8080/user/register6?username=abc&password=niupi&age=30&hobbies=sing&hobbies=dance&hobbies=rap&ids=1&ids=2&ids=3&birthday=2022-06-21

ä¸Šé¢è¿™ä¸ªè¯·æ±‚å¦‚æœè¦ä½¿ç”¨å½¢å‚æ¥æ¥æ”¶ï¼Œæˆ‘ä»¬çš„æ–¹æ³•å¦‚ä½•æ¥å†™ï¼Ÿ

```java
//localhost:8080/user/register6?username=abc&password=niupi&age=30
// &hobbies=sing&hobbies=dance&hobbies=rap&ids=1&ids=2&ids=3
// &birthday=2022-06-21
@RequestMapping("register6")
public BaseRespVo register6(String username,String password,Integer age,
                            String[] hobbies,Integer[] ids,
                            @DateTimeFormat(pattern = "yyyy-MM-dd") Date birthday) {
    return BaseRespVo.ok();
}
```

å°†è¿™ä¸ªå½¢å‚å˜ä¸ºä¸€ä¸ªå®ä½“ç±»çš„æˆå‘˜å˜é‡ï¼Œå½¢å‚è¿™é‡Œå†™è¿™ä¸ªå®ä½“ç±»çš„å®ä¾‹

```java
@Data
public class User {
    String username;
    String password;
    Integer age;

    String[] hobbies;
    Integer[] ids;

    @DateTimeFormat(pattern = "yyyy-MM-dd")
    Date birthday;

}
```

```java
@RequestMapping("register6")
public BaseRespVo register6(User user) {
    return BaseRespVo.ok();
}
```

SpringMVCå¸®åŠ©æˆ‘ä»¬åšçš„å°è£…ï¼Œå½“å®ƒå‘ç°æ–¹æ³•çš„å½¢å‚æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å®ä¾‹çš„æ—¶å€™ï¼Œä¼šæ ¹æ®è¿™ä¸ªç±»ä¸­çš„æˆå‘˜å˜é‡çš„åç§°å’Œç±»å‹å»æ¥æ”¶è¯·æ±‚å‚æ•°çš„å€¼ï¼Œæ ¹æ®åç§°è·å¾—å€¼ï¼Œ**æ ¹æ®ç±»å‹æ¥åšæ ¼å¼è½¬æ¢ï¼Œé€šè¿‡`set`æ–¹æ³•åšçš„å°è£…**ã€‚

### æ€è€ƒ

æˆ‘ä»¬åœ¨åç»­çš„å¼€å‘ä¸­ï¼Œä½¿ç”¨å“ªäº›å½¢å¼æ¥æ¥æ”¶ï¼š

- ä½¿ç”¨å½¢å‚ç›´æ¥æ¥æ”¶ï¼šå¦‚æœå‚æ•°æ¯”è¾ƒå°‘ï¼Œç›´æ¥ä½¿ç”¨å½¢å‚
- ä½¿ç”¨å¼•ç”¨ç±»å‹çš„å¯¹è±¡æ¥æ¥æ”¶ï¼šå‚æ•°æ¯”è¾ƒå¤šï¼›åœ¨å¤šä¸ªè¯·æ±‚ä¸­éƒ½ä½¿ç”¨äº†ç›¸åŒçš„è¯·æ±‚å‚æ•°
- æ··åˆæ¥æ”¶ï¼šæœ‰äº›å‚æ•°å°±ç”¨ä¸€æ¬¡æˆ–è€…ç”¨çš„æ¬¡æ•°æ¯”è¾ƒå°‘ï¼ˆç›´æ¥æ¥æ”¶ï¼‰ï¼Œæœ‰çš„å‚æ•°ç”¨äº†å¤šæ¬¡ï¼ˆå°è£…ä¸ºå®ä½“ç±»ï¼‰

æ¯”å¦‚æˆ‘ä»¬è¦åšä¸€ä¸ªæŸ¥è¯¢

> localhost:8080/user/query?username=song&sort=add_time&order=asc&page=1&limit=10
>
> è¯·æ±‚å‚æ•°usernameï¼šæ ¹æ®è¿™ä¸ªå€¼åšusernameçš„æ¨¡ç³ŠæŸ¥è¯¢
>
> è¯·æ±‚å‚æ•°pageã€limitï¼šæ ¹æ®è¿™ä¸¤ä¸ªå€¼åšåˆ†é¡µï¼Œpageæ˜¯é¡µç ï¼Œlimitæ˜¯è¿™ä¸€é¡µçš„æ•°æ®é‡
>
> è¯·æ±‚å‚æ•°sortã€orderï¼šåšç»“æœæ’åºï¼Œæ ¹æ®æ·»åŠ æ—¶é—´åšå‡åºæ’åº

pageã€limitã€sortã€orderåœ¨åšå…¶ä»–çš„æŸ¥è¯¢æ—¶ä¹Ÿæ˜¯ä¼šä½¿ç”¨çš„ï¼Œä¸ºäº†è¿™äº›å‚æ•°çš„å¤ç”¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è£…ä¸ºå®ä½“ç±»

```java
//localhost:8080/user/query?username=song&sort=add_time&order=asc&page=1&limit=10
@RequestMapping("query")
public BaseRespVo query(String username, CommonParameter commonParameter) {
    return BaseRespVo.ok();
}

@Data
public class CommonParameter {
    String sort;
	String order;
	Integer page;
	Integer limit;
	
}
```

## `Json`è¯·æ±‚å‚æ•°

ğŸ·ï¸ å¦‚æœè¯´ä¸€ä¸ªè¯·æ±‚æºå¸¦`Json`è¯·æ±‚å‚æ•°ï¼Œè¿™ä¸ªè¯·æ±‚å…·æœ‰ä»€ä¹ˆæ ·çš„ç‰¹ç‚¹ï¼Ÿ

- è¯·æ±‚æ–¹æ³•ï¼š`POST`
- æ­£æ–‡ç±»å‹`Content-Type`ï¼š`application/json`
- æ•°æ®æ˜¯`Json`å­—ç¬¦ä¸²

å¦‚æœæ„é€ è¯·æ±‚æ˜¯`Json`è¯·æ±‚å‚æ•°ï¼šajaxã€axios

å¯ä»¥ä½¿ç”¨Postmanæ¥æ„é€ è¯·æ±‚

![image-20230907092255235](.\assets\image-20230907092255235.png)

`Json`è¯·æ±‚å‚æ•°ä»ç„¶æ˜¯åœ¨å½¢å‚ä¸­è¿›è¡Œæ¥æ”¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§ç±»å‹æ¥æ¥æ”¶

- `String`
- å¼•ç”¨ç±»å‹å¯¹è±¡
- `Map`

å½¢å‚å‰éœ€è¦å¢åŠ ä¸€ä¸ªæ³¨è§£`@RequestBody`

> `@RequestBody`å’Œ`@ResponseBody`è¿™ä¸¤ä¸ªæ³¨è§£éƒ½æ˜¯å’Œ`Json`æ‰“äº¤é“çš„æ—¶å€™ä½¿ç”¨çš„æ³¨è§£
>
> æ¥æ”¶çš„æ—¶å€™ç”¨çš„æ˜¯`@RequestBody`
>
> å“åº”çš„æ—¶å€™ç”¨çš„æ˜¯`@ResponseBody`

ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¼•ç”¨ç±»å‹å¯¹è±¡ã€`Map`æ¥è¿›è¡Œæ¥æ”¶ï¼Ÿ

æˆ‘ä»¬æœ¬èº«æ¥æ”¶åˆ°çš„å€¼æ˜¯ `String`ï¼Œ`Jackson` è¯†åˆ«äº†æˆ‘ä»¬æ–¹æ³•çš„å½¢å‚ç±»å‹ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹åº”çš„ç±»å‹çš„å½¢å‚ã€‚

```java
@RestController
@RequestMapping("user")
public class UserController {
    /**
     * String
     * {"username":"songge","password":"niupi","birthday":"2022-07-12"}
     * @return
     */
    @RequestMapping("login")
    public BaseRespVo login(@RequestBody String result) {
        System.out.println(result);
        return BaseRespVo.ok();
    }

    /**
     * å¼•ç”¨ç±»å‹å¯¹è±¡
     * {"username":"songge","password":"niupi","age":50,"birthday":"1995-03-19"}
     * @return
     */
    @RequestMapping("login2")
    public BaseRespVo login2(@RequestBody User user) {
        System.out.println(user);
        return BaseRespVo.ok();
    }

    /**
     * Map â†’ LinkedHashMap
     * {"username":"songge","password":"niupi","age":50,"birthday":"1995-03-19"}
     * @return
     */
    @RequestMapping("login3")
    public BaseRespVo login3(@RequestBody Map map) {
        System.out.println(map);
        return BaseRespVo.ok();
    }
}
```

å¦‚æœè¦æŒ‡å®šæ—¥æœŸæ ¼å¼ï¼š`@JsonFormat(pattern = "yyyy-MM-dd")`

1. æ¥æ”¶`Json`å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå°†å…¶å˜é‡çš„ç±»å‹å®šä¹‰ä¸º`Date`
2. ` @DateTimeFormat(pattern = "yyyy-MM-dd")` â†’ è¿™ä¸ªæ˜¯ä¸è¡Œï¼Œè¿™ä¸ªæ³¨è§£æ˜¯ç»™`Key-value`è¿™ç§è¯·æ±‚å‚æ•°ä½¿ç”¨çš„
3.  æˆ‘ä»¬æ¥æ”¶`Json`æ•°æ®çš„è¿‡ç¨‹ä¸­` String â†’ user`å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å®Œå…¨æ˜¯é `Json`å·¥å…·ç±» â†’ å¯ä»¥åš`Date`æ ¼å¼çš„æŒ‡å®š

```java
@NoArgsConstructor
@Data
public class User {

    private String username;
    private String password;
    private Integer age;
    // æä¾›çš„Jsonæ•°æ®birthdayè¿™ä¸ªkeyå¯¹åº”çš„å€¼å°±æ˜¯String
    // è¿™ä¸ªå­—ç¬¦ä¸²æœ‰ç‚¹åƒDateçš„ä¸€ä¸ªpattern â†’ yyyy-MM-dd
    //private String birthday;
    // æ¥æ”¶Jsonå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå°†å…¶å˜é‡çš„ç±»å‹å®šä¹‰ä¸ºDate
    //@DateTimeFormat(pattern = "yyyy-MM-dd") â†’ è¿™ä¸ªæ˜¯ä¸è¡Œï¼Œè¿™ä¸ªæ³¨è§£æ˜¯ç»™Key-valueè¿™ç§è¯·æ±‚å‚æ•°ä½¿ç”¨çš„
    // æˆ‘ä»¬æ¥æ”¶Jsonæ•°æ®çš„è¿‡ç¨‹ä¸­ String â†’ userå¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å®Œå…¨æ˜¯é Jsonå·¥å…·ç±» â†’ å¯ä»¥åšDateæ ¼å¼çš„æŒ‡å®š
    @JsonFormat(pattern = "yyyy-MM-dd")// å½±å“æ¥æ”¶è¿‡ç¨‹ä¸­çš„æ—¥æœŸæŒ‡å®šï¼›ä¹Ÿå½±å“å“åº”è¿‡ç¨‹ä¸­çš„æ—¥æœŸæ ¼å¼
    private Date birthday;
}
```

æ€è€ƒï¼šæˆ‘ä»¬åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬é‡‡ç”¨ä¸Šé¢3ç§æ–¹å¼ä¸­çš„å“ªç§æ–¹å¼ï¼Ÿ

- `String` ä¸ä½¿ç”¨ï¼Œå› ä¸ºæ¥æ”¶åˆ°`String`ç±»å‹çš„å€¼ï¼Œä½ è¿˜éœ€è¦é¢å¤–å¤„ç†ï¼Œè¿‡ç¨‹å°±ç¹çäº†
- å¼•ç”¨ç±»å‹å¯¹è±¡ï¼šå¯ä»¥ä½¿ç”¨ã€‚å‚æ•°æ¯”è¾ƒå¤šï¼Œå°è£…æ¯”è¾ƒå¤æ‚ï¼Œä½ éœ€è¦ç¡®åˆ‡çš„å‚æ•°ç±»å‹çš„æ—¶å€™ï¼Œä½¿ç”¨çš„åœºæ™¯æ¯”è¾ƒå¤š
- `Map`ï¼šå¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä½ çš„å‚æ•°æ¯”è¾ƒå°‘ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±ç›´æ¥ä½¿ç”¨`Map`å°±è¡Œäº†
  - `{â€œusernameâ€:"songge"}`

## å…¶ä»–ä¿¡æ¯

### `HttpServletRequest`ã€`HttpServletResponse`

å¯ä»¥ç›´æ¥å†™åœ¨å½¢å‚ä¸­ï¼Œ `Controller`ç»„ä»¶ä¸­çš„æ–¹æ³•ä¸Šéƒ½æ˜¯å¯ä»¥å¢åŠ `HttpServletRequest`å’Œ`HttpServletResponse`è¿™ä¸¤ä¸ªå½¢å‚çš„ã€‚å…¶ä»–ä¿¡æ¯é€šè¿‡è¿™ä¸¤ä¸ªå½¢å‚è·å¾—ï¼Œå› ä¸ºSpringæœ¬è´¨æ˜¯å¯¹ä¸¤è€…çš„å°è£…ã€‚

ä¸å¤ªå»ºè®®ï¼Œé™¤éä¸‡ä¸å¾—å·²ã€‚

```java
// Controllerç»„ä»¶ä¸­çš„æ–¹æ³•ä¸Šéƒ½æ˜¯å¯ä»¥å¢åŠ HttpServletRequestå’ŒHttpServletResponseè¿™ä¸¤ä¸ªå½¢å‚çš„
@RequestMapping("reqAndResp")
public BaseRespVo reqAndResp(HttpServletRequest request, HttpServletResponse response) {
    return BaseRespVo.ok();
}
```

### `Cookie`å’Œ`Session`

éœ€è¦é€šè¿‡`request`æ¥è·å¾—

```java
//localhost:8080/cookies
@RequestMapping("cookies")
public BaseRespVo cookies(HttpServletRequest request) {
    Cookie[] cookies = request.getCookies();
    for (Cookie cookie : cookies) {
        System.out.println(cookie.getName() + " = " + cookie.getValue());
    }
    return BaseRespVo.ok();
}
```

é€šè¿‡æµè§ˆå™¨æ„é€ Cookie

![image-20230912090306142](.\assets\image-20230912090306142.png)

è¯·æ±‚å¤´é‡Œæœ‰`Cookie`

ä¹Ÿå¯ä»¥é€šè¿‡Postmanæ„é€ Cookie â†’ æ„é€ Postmançš„è¯·æ±‚å¤´å°±å¯ä»¥äº†

![image-20230912090329018](.\assets\image-20230912090329018.png)

å¯ä»¥é€šè¿‡`request`æ¥è·å¾—ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨å½¢å‚ä¸­å†™`HttpSession`

http://localhost:8080/session1?username=xuejia

http://localhost:8080/session2

è¿™ä¸¤ä¸ªè¯·æ±‚ï¼Œ

session1ï¼Œè·å¾—`session`ï¼Œå‘`session`ä¸­æ”¾å…¥æ•°æ®

session2ï¼Œè·å¾—`session`ï¼Œä»`session`ä¸­å–å‡ºæ•°æ®

é€šè¿‡ä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥è·å¾—`session`

```java
//http://localhost:8080/session1?username=xuejia
@RequestMapping("session1")
public BaseRespVo session1(HttpServletRequest request,String username) {
    HttpSession session = request.getSession();
    session.setAttribute("username", username);
    return BaseRespVo.ok();
}
//http://localhost:8080/session2
@RequestMapping("session2")
public BaseRespVo session2(HttpSession session) {
    Object username = session.getAttribute("username");
    System.out.println("username = " + username);
    return BaseRespVo.ok(username);
}
```

# `RESTful` é£æ ¼æ¥å£

`REST`  â†’ ` Representational State Transfer`

 **è¡¨è¿°æ€§çŠ¶æ€ä¼ é€’**

é€šè¿‡è¯·æ±‚ï¼ˆæŠ¥æ–‡ï¼‰èƒ½å¤Ÿæä¾›ä¸€äº›å¯¹åº”çš„ä¿¡æ¯ï¼Œæä¾›ç»™æœåŠ¡å™¨ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡ä¸€äº›æ–¹æ³•æ¥è·å¾—å¯¹åº”çš„ä¿¡æ¯ã€‚

**å…¶å®å°±æ˜¯å¯¹`Request`çš„å°è£…**

> RESTï¼ˆRepresentational State Transferï¼‰æ˜¯ä¸€ç§ç½‘ç»œåº”ç”¨ç¨‹åºè®¾è®¡é£æ ¼ï¼Œå®ƒæ˜¯ä¸€ç§é€šè¿‡HTTPåè®®è¿›è¡Œé€šä¿¡çš„è½¯ä»¶æ¶æ„é£æ ¼ã€‚RESTfulé£æ ¼æ¥å£æ˜¯ç¬¦åˆRESTåŸåˆ™çš„åº”ç”¨ç¨‹åºæ¥å£è®¾è®¡ï¼Œå®ƒä½¿ç”¨æ ‡å‡†çš„HTTPæ–¹æ³•ï¼ˆå¦‚GETã€POSTã€PUTã€DELETEï¼‰è¿›è¡Œæ“ä½œèµ„æºï¼Œè€Œä¸éœ€è¦é¢å¤–çš„æ“ä½œæˆ–åè®®ã€‚
>
> ä»¥ä¸‹æ˜¯ä¸€äº›RESTfulæ¥å£çš„ä¸»è¦ç‰¹å¾ï¼š
>
> 1. **åŸºäºèµ„æºï¼ˆResource-Basedï¼‰ï¼š** RESTfulæ¥å£å°†æ¯ä¸ªæ•°æ®æˆ–æœåŠ¡éƒ½è§†ä¸ºä¸€ä¸ªèµ„æºï¼Œæ¯ä¸ªèµ„æºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆé€šå¸¸æ˜¯URLï¼‰ã€‚
>
> 2. **ä½¿ç”¨æ ‡å‡†çš„HTTPæ–¹æ³•ï¼š** RESTfulæ¥å£ä½¿ç”¨æ ‡å‡†çš„HTTPæ–¹æ³•æ¥æ‰§è¡Œæ“ä½œã€‚ä¾‹å¦‚ï¼ŒGETç”¨äºè·å–èµ„æºï¼ŒPOSTç”¨äºåˆ›å»ºæ–°èµ„æºï¼ŒPUTç”¨äºæ›´æ–°èµ„æºï¼ŒDELETEç”¨äºåˆ é™¤èµ„æºã€‚
>
> 3. **çŠ¶æ€æ— å…³ï¼ˆStatelessï¼‰ï¼š** æ¯ä¸ªè¯·æ±‚ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨éƒ½å¿…é¡»åŒ…å«æ‰€æœ‰ä¿¡æ¯ï¼ŒæœåŠ¡å™¨ä¸åº”å­˜å‚¨å…³äºå®¢æˆ·ç«¯çŠ¶æ€çš„ä»»ä½•ä¿¡æ¯ã€‚æ¯ä¸ªè¯·æ±‚éƒ½åº”æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨ä¸åº”ä¾èµ–äºä¹‹å‰çš„è¯·æ±‚ã€‚
>
> 4. **è¡¨ç¤ºå±‚çŠ¶æ€è½¬åŒ–ï¼ˆRepresentation State Transferï¼‰ï¼š** èµ„æºçš„çŠ¶æ€ä»¥åŠèµ„æºä¹‹é—´çš„è½¬æ¢é€šè¿‡è¡¨ç¤ºï¼ˆé€šå¸¸æ˜¯JSONæˆ–XMLï¼‰ä¼ é€’ã€‚å®¢æˆ·ç«¯é€šè¿‡è·å–ã€ä¿®æ”¹å’Œä¼ é€’èµ„æºçš„è¡¨ç¤ºæ¥å®ç°çŠ¶æ€è½¬åŒ–ã€‚
>
> 5. **ç»Ÿä¸€æ¥å£ï¼š** RESTfulæ¥å£çš„è®¾è®¡åº”è¯¥æ˜¯ç»Ÿä¸€çš„ï¼Œä»¥ç®€åŒ–ç³»ç»Ÿæ¶æ„ï¼Œå¹¶ä½¿ä¸åŒéƒ¨åˆ†ä¹‹é—´çš„äº¤äº’æ›´åŠ å¯é¢„æµ‹å’Œå¯ç†è§£ã€‚
>
> 6. **å¯ç¼“å­˜æ€§ï¼š** å¯¹äºå¯ç¼“å­˜çš„èµ„æºï¼ŒæœåŠ¡å™¨å¯ä»¥æ ‡è®°å“åº”ä¸ºå¯ç¼“å­˜ï¼Œä»¥æé«˜æ€§èƒ½ã€‚
>
> ä½¿ç”¨RESTfulé£æ ¼çš„æ¥å£æœ‰åŠ©äºå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¾è€¦åˆæ€§ï¼Œæé«˜ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚è¿™ç§è®¾è®¡é£æ ¼å·²ç»æˆä¸ºè®¸å¤šç°ä»£Webåº”ç”¨ç¨‹åºçš„æ ‡å‡†ã€‚

è¿‡å»ä½¿ç”¨RESTfulé£æ ¼æ¥å£çš„æ—¶å€™ï¼Œæ¯”å¦‚åœ¨åšuserçš„å¢åˆ æ”¹æŸ¥åœºæ™¯ä¸‹ï¼Œè¯·æ±‚URLéƒ½æ˜¯`/user`

> - `/user` æŸ¥è¯¢ `GET`
> - `/user` åˆ é™¤ `DELETE`
> - `/user` æ–°å¢ `PUT`
> - `/user` ä¿®æ”¹ `POST`
>
> è¯·æ±‚URLéƒ½æ˜¯userï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åšçš„æ˜¯userçš„ç›¸å…³ä¸šåŠ¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›ä¿¡æ¯**è¾…åŠ©æˆ‘ä»¬å»åˆ¤æ–­**åˆ°åº•åšçš„æ–°å¢è¿˜æ˜¯æŸ¥è¯¢è¿˜æ˜¯åˆ é™¤è¿˜æ˜¯ä¿®æ”¹ï¼Œé€šè¿‡è¯·æ±‚æ–¹æ³•çš„ä¸åŒï¼Œå¯ä»¥åšå‡ºä¸åŒæ“ä½œçš„åˆ¤æ–­

å½“å‰çš„ä¸»æµæˆ‘ä»¬å¹¶ä¸è¿™æ ·åšäº†ï¼Œä¸»æµçš„è¯·æ±‚æ–¹æ³•å…¶å®å°±æ˜¯`GET/POST`ï¼Œå½“å‰æˆ‘ä»¬è¯´`RESTful`çš„æ—¶å€™ï¼Œé€šè¿‡åŒ…å«ä¸€ä¸ªä¿¡æ¯ï¼Œä½ èƒ½å¤Ÿä½¿ç”¨`JSON`åšæ•°æ®äº¤äº’ï¼š`@RequestBody`ã€`@ResponseBody`ã€‚

è€Œæˆ‘ä»¬å½“å‰å®šä¹‰æ¥å£çš„URLï¼Œ**é€šè¿‡URLçš„ä¸åŒåŒºåˆ†ä¸åŒçš„æ“ä½œ**

> -  `/user/query` æŸ¥è¯¢ 
> - `/user/remove` åˆ é™¤ 
> -  `/user/create` æ–°å¢ 
> -  `/user/modify` ä¿®æ”¹ 

å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥è·å¾—ä¸€äº›å…¶ä»–çš„ä¿¡æ¯

- è¯·æ±‚URLçš„ä¿¡æ¯ â†’ `@PathVariable` â­ 
- è¯·æ±‚å‚æ•°ä¿¡æ¯ â†’ `@RequestParam`
- è¯·æ±‚å¤´ä¿¡æ¯ â†’ `@RequestHeader`
- `Cookie` ä¿¡æ¯ â†’ `@CookieValue`
- `Session`ä¿¡æ¯ â†’ `@SessionAttribute`

èƒ½å¤Ÿè·å¾—è¿™æ ·çš„ä¿¡æ¯ï¼Œè·å¾—çš„è¿™äº›ä¿¡æ¯æ˜¯æ”¾åœ¨æ–¹æ³•çš„å½¢å‚ä¸­ï¼Œä½¿ç”¨ä¸åŒçš„æ³¨è§£æ¥åŒºåˆ†è·å¾—çš„ä¸åŒçš„ä¿¡æ¯ã€‚

## â­ `@PathVariable`

`@PathVariable` ï¼šè·å¾—è¯·æ±‚`URL` çš„ä¸€éƒ¨åˆ†å€¼ ã€‚

åœ¨`@RequestMapping` çš„`value` å±æ€§å†™å ä½ç¬¦`{}`ï¼›è·å¾—æŒ‡å®šå ä½ç¬¦ä½ç½®çš„å€¼ç»™åˆ°æ‰€å¯¹åº”çš„å½¢å‚ï¼Œå½¢å‚é€šè¿‡æ³¨è§£æ¥æ”¶æŒ‡å®šå ä½ç¬¦ä½ç½®çš„å€¼ã€‚

> å ä½ç¬¦ï¼šplaceholder

```java
//localhost:8080/path/songge

// é€šè¿‡è¿™ä¸ªæ³¨è§£ï¼Œå°±å¯ä»¥æŠŠä¸€éƒ¨åˆ†è¯·æ±‚å‚æ•°å†™åˆ°URLä¸­ï¼Œæ¯”å¦‚è±†ç“£ã€CSDN
@RequestMapping("path/{username}")
public BaseRespVo path(@PathVariable("username")String name) {
    System.out.println("name = " + name);
    return BaseRespVo.ok();
}
```

## `@RequestParam`

ä¸å†™è¿™ä¸ªæ³¨è§£ä¹Ÿå¯ä»¥è·å¾—å‚æ•°ï¼Œå†™äº†è¯¥æ³¨è§£ï¼Œå¦‚æœè¯·æ±‚å‚æ•°æ²¡æœ‰å¯¹åº”çš„å€¼ä¼šæŠ¥é”™ã€‚

//`@RequestParam` â†’ å¼€å‘è¿‡ç¨‹ä¸­åŸºæœ¬ä¸ç”¨ï¼Œç›´æ¥ä½¿ç”¨å½¢å‚å
// å½¢å‚é€šè¿‡è¿™ä¸ªæ³¨è§£è·å¾—æŒ‡å®šè¯·æ±‚å‚æ•°ï¼Œå¦‚æœä½¿ç”¨äº†è¿™ä¸ªæ³¨è§£ï¼Œå°±**ä¸€å®šè¦æºå¸¦**å¯¹åº”çš„è¯·æ±‚å‚æ•°

```java
// localhost:8080/param?username=songge&password=niupi

@RequestMapping("param")
public BaseRespVo param(@RequestParam("username")String usernamea,
                        @RequestParam("password")String passwordb) {
    return BaseRespVo.ok();
}
```

## `@RequestHeader`

æ¯”å¦‚è¦è·å¾—`Accept`è¿™ä¸ªè¯·æ±‚å’Œ`Host`è¿™ä¸ªè¯·æ±‚å¤´çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„æ¥æ¥æ”¶ ã€‚

```JAVA
Accept :text/html,application/json;q=0.9
```

 å¦‚æœä½¿ç”¨æ•°ç»„æ¥æ¥æ”¶ï¼Œå…¶å®å°±æ˜¯å°†å­—ç¬¦ä¸²é€šè¿‡é€—å·åˆ†éš”ä¸ºæ•°ç»„(split)ï¼Œ å½¢å‚é€šè¿‡è¿™ä¸ªæ³¨è§£è·å¾—æŒ‡å®šè¯·æ±‚å¤´çš„å€¼ã€‚

```java
@RequestMapping("header")
public BaseRespVo header(@RequestHeader("Accept")String[] accept,
                         @RequestHeader("Host")String host) {
    System.out.println(Arrays.asList(accept));
    System.out.println(host);
    return BaseRespVo.ok();
}
```

## `@CookieValue`

`@CookieValue`
å½¢å‚é€šè¿‡è¿™ä¸ªæ³¨è§£è·å¾—æŒ‡å®š`Cookie`çš„å€¼ï¼Œæ ¹æ®`key`è·å¾—`value`
æ¯”å¦‚æ„é€ çš„`Cookie`æ˜¯è¿™æ ·çš„ 

```JAVA
Cookie:songge=yuanzhi;ligenli=tianming;xuejia=qiezi
```

ç›¸è¾ƒäºå‰é¢ä½¿ç”¨Cookieçš„è¯ï¼ˆè¦é€šè¿‡requestè·å¾—Cookiesæ•°ç»„ï¼Œç„¶åé€šè¿‡éå†è·å¾—keyå¯¹åº”çš„å€¼ï¼‰ï¼Œè¦æ–¹ä¾¿çš„å¤š

```java
@RequestMapping("cookie")
public BaseRespVo cookie(@CookieValue("songge")String value) {
    System.out.println(value);
    return BaseRespVo.ok();
}
```

## `@SessionAttribute`

// å½¢å‚é€šè¿‡è¿™ä¸ªæ³¨è§£è·å¾—æŒ‡å®š`Session`çš„å€¼ï¼Œæ ¹æ®`key`è·å¾—`value`
// æ¯”å¦‚æˆ‘å‘`session`ä¸­æ”¾å…¥ä¸€ä¸ª`key=username`çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å–å‡º`username`å¯¹åº”çš„å€¼

```java
@RequestMapping("session")
public BaseRespVo session(@SessionAttribute("username")String username) {
    return BaseRespVo.ok();
}
//localhost:8080/put/xuejia
@RequestMapping("put/{username}")
public BaseRespVo sessionPut(@PathVariable("username")String username, HttpSession session) {
    session.setAttribute("username",username);
    return BaseRespVo.ok();
}
```

# SpringMVCä½¿ç”¨å°ç»“

æ˜¯å¯¹JavaEEç¹çè¿‡ç¨‹çš„å°è£…

![Day18-SpringMVCä½¿ç”¨æ¢³ç†](.\assets\Day18-SpringMVCä½¿ç”¨æ¢³ç†.jpg)

# SpringMVCæ ¸å¿ƒæµç¨‹ï¼ˆéš¾ï¼‰

> é˜…è¯»å‚è€ƒï¼š
>
> + [é¥¿äº†ä¹ˆäºŒé¢ï¼šè¯´è¯´Spring MVCçš„å¤„ç†æµç¨‹ï¼Ÿ (qq.com)](https://mp.weixin.qq.com/s/6n6whvAvBeHEsaq3eARVOg)

å‰é¢çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬äº§ç”Ÿä¸€äº›å…±è¯†ï¼š

- `DispatcherServlet` å¤„ç†å‡ ä¹å…¨éƒ¨è¯·æ±‚
  - jspæœ‰è‡ªèº«çš„servletæ‰€ä»¥ä¸ä¼šæ‰¾ç¼ºçœçš„servlet
  - æŸ¥çœ‹tomcatçš„web.xml

- `Controller` ç»„ä»¶ä¸­çš„æ–¹æ³•å¤„ç†è¯·æ±‚ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸»è¦å¼€å‘çš„å†…å®¹

åº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

éœ€è¦è®¾ç½®ROOTçš„åŸå› ï¼Œä¸ºäº†å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ä¸€äº›ä¸œè¥¿ã€‚æ¯”å¦‚DataSourceã€‚

å‘é€è¯·æ±‚çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

## `DispatcherServlet`å’Œ `ApplicationContext` çš„å…³ç³»

æ˜¯åŒ…å«å…³ç³»ï¼š`DispatcherServlet`åŒ…å« `ApplicationContext` 

![image-20230915095236855](E:\0.ç‹é“è®­ç»ƒè¥\3.æˆ‘çš„Dailyç¬”è®°\3.JavaEE&SpringFramework\Part2\assets\image-20230915095236855.png)

ä¸ºä»€ä¹ˆæˆ‘ä»¬å»å¼€å‘`Controller` ç»„ä»¶ä¸­çš„æ–¹æ³•å°±å¯ä»¥äº†ï¼Ÿ

> ğŸ˜¶â€ğŸŒ«ï¸ æ–¹æ³•æ˜¯å“ªé‡Œçš„ï¼Ÿ
>
> å­˜åœ¨äº`Controller`ç»„ä»¶ä¸­ã€‚`Controller`æ˜¯Handlerçš„ä¸€ç§å®ç°æ–¹å¼ã€‚
>
>  ğŸ˜¶â€ğŸŒ«ï¸`Controller` ç»„ä»¶æ”¾åœ¨å“ªé‡Œï¼Ÿä»å“ªé‡Œèƒ½å¤Ÿè·å¾—`Controller` ç»„ä»¶ï¼Ÿ
>
> å®¹å™¨ä¸­ ï¼Œå®¹å™¨å°±æ˜¯`ApplicationContext`ã€‚
>
> ğŸ˜¶â€ğŸŒ«ï¸ åœ¨å“ªé‡Œæ‰§è¡Œåˆ°è¿™äº›æ–¹æ³•ï¼Ÿ
>
> å½“æˆ‘ä»¬å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œåˆ°è¿™äº›æ–¹æ³•ï¼›å½“æˆ‘ä»¬å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œ`DispatcherServlet` å¤„ç†å‡ ä¹å…¨éƒ¨çš„è¯·æ±‚ï¼Œ `DispatcherServlet `â†’ æ–¹æ³•ã€‚

![image-20230912090421675](.\assets\image-20230912090421675.png)

å¦‚ä½•æ‰¾åˆ°è¿™äº›æ–¹æ³•ï¼Œæ‰¾åˆ°è¿™äº›æ–¹æ³•çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**Handler**</span>ï¼šå¤„ç†å™¨ï¼Œmethod1ã€method2ã€method3å…¶å®å°±æ˜¯å¤„ç†å™¨ï¼Œå¤„ç†æˆ‘ä»¬çš„è¯·æ±‚ï¼Œä¹Ÿç§°ä¹‹ä¸º<font color='red'>**HandlerMethod**</font>ï¼ˆHandleræ–¹æ³•ï¼‰

å°ç»“è®ºï¼š`DispatcherServlet` å¦‚æœèƒ½å¤Ÿæ‰¾åˆ°`ApplicationContext`ï¼ˆå®¹å™¨ï¼‰ï¼Œå°±å¯ä»¥æ‰§è¡Œåˆ°å®¹å™¨ä¸­çš„`Controller`ç»„ä»¶ä¸­`Handler`æ–¹æ³•ã€‚

![image-20230912090506024](.\assets\image-20230912090506024.png)

æ¥ä¸‹æ¥è€ƒè™‘çš„é—®é¢˜ï¼Œ**`DispatcherServlet`å¦‚ä½•å’Œ`ApplicationContext`å»ºç«‹è”ç³»ï¼Ÿ**

å¯å¦åœ¨`DispatcherServlet`ä¸­å¢åŠ æˆå‘˜å˜é‡å«åš`ApplicationContext`å¯ä»¥ä¸ï¼Ÿå¯ä»¥ã€‚

SpringMVCæ˜¯è¿™æ ·å­åšï¼š`DispatcherServlet`çš„çˆ¶ç±»ï¼ˆ`FrameworkServlet`ï¼‰ä¸­å¢åŠ äº†æˆå‘˜å˜é‡`ï¼ˆWebï¼‰ApplicationContext`ï¼Œå¦‚æœè¿™ä¸ªçˆ¶ç±»ä¸­æä¾›äº†`getWebApplicationContext`è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œ`DispatcherServlet`å¯ä»¥è·å¾—`ApplicationContext`ã€‚

```java
public abstract class FrameworkServlet {
    private WebApplicationContext webApplicationContext;
    @Nullable
    public final WebApplicationContext getWebApplicationContext() {
        return this.webApplicationContext;
    }
}
public class DispatcherServlet extends FrameworkServlet {}
```

`WebApplicationContext`æ˜¯SpringMVCé˜¶æ®µæˆ‘ä»¬ä½¿ç”¨çš„å®¹å™¨ï¼Œä¹Ÿæ˜¯`ApplicationContext`çš„å­æ¥å£ï¼Œ`ApplicationContext` æä¾›çš„åŠŸèƒ½ï¼Œ`WebApplicationContext` å…¨éƒ¨éƒ½æœ‰ã€‚é‡Œé¢è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„æ–¹æ³•`getServletContext`ï¼›é€šè¿‡`ServletContext`å¯ä»¥å’Œ`Servlet` å…±äº«æ•°æ®ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œçš„`Servlet`åªæœ‰ `DispatcherServlet`ã€‚

ä¹Ÿå°±æ˜¯ï¼š<span style='color:yellow;background:red;font-size:æ–‡å­—å¤§å°;font-family:å­—ä½“;'>**WebApplicationContextå’ŒDispatcherServletå¯ä»¥é€šè¿‡ServletContextå…±äº«æ•°æ®**</span>

```java
public interface WebApplicationContext extends ApplicationContext {

    @Nullable
    ServletContext getServletContext();
}
```

![image-20230912090533085](.\assets\image-20230912090533085.png)

![image-20230915100249085](.\assets\image-20230915100249085.png)

`DispatcherServlet`ä½¿ç”¨çš„`WebApplicationContext`æ˜¯**ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„ï¼Ÿ**

> æŸ¥çœ‹â€œonStartupâ€æ–¹æ³•

å®¹å™¨ä½•æ—¶åˆå§‹åŒ–çš„ï¼Œä¹Ÿå°±`WebApplicationContext`çš„å®ä¾‹æ˜¯ä½•æ—¶ç”Ÿæˆçš„ï¼Œä½œä¸º`DispatcherServlet`çš„æˆå‘˜å˜é‡ï¼Ÿ

> Servletå·¥ä½œçš„æ–¹æ³•æ˜¯serviceæ–¹æ³•ï¼ŒWebApplicationContextè¦åœ¨serviceæ–¹æ³•æ‰§è¡Œä¹‹å‰å®Œæˆåˆå§‹åŒ–
>
> - Listener â†’ contextInitialized
> - Servletçš„ç”Ÿå‘½å‘¨æœŸçš„initæ–¹æ³•
>
> SpringMVCæ˜¯é‡‡ç”¨ä¸Šé¢çš„å“ªç§æ–¹å¼ï¼Ÿ
>
> æˆ‘ä»¬å‰é¢ï¼š2ã€‚ä¹Ÿå¯ä»¥1,2éƒ½ç”¨

å¦‚æœæ—¢ä½¿ç”¨Listenerï¼Œåˆä½¿ç”¨Servletçš„initæ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹å¦‚ä½•ç»´æŠ¤çš„ï¼Ÿ

SpringMVCç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªListener â†’ `ContextLoaderListener` ã€‚åˆå§‹åŒ–äº†ä¸€ä¸ª`WebApplicationContext`ï¼Œå¹¶ä¸”ç»™å®ƒæ”¾åˆ°äº†`ServletContext` ä¸­

```java
public class ContextLoaderListener extends ContextLoader implements ServletContextListener {
    public void contextInitialized(ServletContextEvent event) {
        this.initWebApplicationContext(event.getServletContext());
    }
}
```

æ‰§è¡Œå®ŒListener

![image-20230912090556042](.\assets\image-20230912090556042.png)

æ¥ä¸‹æ¥ è¦æ‰§è¡Œ `DispatcherServlet` çš„ç”Ÿå‘½å‘¨æœŸçš„`init` æ–¹æ³•

`DispatcherServlet` è‡ªå·±ä¼šåˆå§‹åŒ–ä¸€ä¸ª`WebApplicationContext`

`DispatcherServlet`åœ¨æ‰§è¡Œ`init`æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œä»`ServletContext`é‡Œæ ¹æ®`xxx_ROOT`è¿™ä¸ª`key`è·å¾—`WebApplicationContext`ï¼Œä½œä¸º`DispatcherServlet`åˆå§‹åŒ–çš„`WebApplicationContext`çš„æˆå‘˜å˜é‡

![image-20230912090620549](.\assets\image-20230912090620549.png)

ç»“è®ºï¼š`DispatcherServlet`å®ƒæ€»æ˜¯å’Œé»„è‰²ï¼ˆå¤§ï¼‰çš„è¿™`WebApplicationContext`åšäº¤äº’ï¼Œ`DispatcherServlet`å¯ä»¥ä½¿ç”¨åˆ°æ©™è‰²ï¼ˆå°ï¼‰çš„`WebApplicationContext`ï¼Œåªæ˜¯è¦é€šè¿‡é»„è‰²ï¼ˆå¤§ï¼‰çš„`WebApplicationContext` ã€‚æˆ‘ä»¬å¯ä»¥ç²—æš´çš„è®¤ä¸ºåªæœ‰ä¸€ä¸ª`WebApplicationContext`ï¼ˆé»„è‰²å¤§ï¼‰

## Handlerçš„åˆ†å‘

å‘é€è¯·æ±‚çš„æ—¶å€™å¦‚ä½•æ‰§è¡Œåˆ°å¯¹åº”çš„æ–¹æ³•ï¼Ÿ

å¤§å®¶å¯ä»¥æ‰¾æŒ‡å®šä½ç½®çš„åŸå›¾æŸ¥çœ‹æ›´æ¸…æ™°ä¸€äº›

![image-20230912090645589](.\assets\image-20230912090645589.png)

é€šè¿‡`DispatcherServlet`çš„`doGet/doPost`æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ°`doDispatch`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æœ€æ ¸å¿ƒçš„æ–¹æ³•ã€‚

> æ‰¾æ–¹æ³•çš„å¿«æ·é”®ï¼šCTRL + F12

 ğŸ·ï¸åœ¨`doDispatch`æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œ`getHandlerMapping`æ–¹æ³•ï¼Œæ ¹æ®`URL`å’Œæ–¹æ³•ä¹‹é—´çš„å…³ç³»ï¼ˆ`@RequestMapping`æ³¨è§£ç»´æŠ¤çš„ï¼‰ï¼Œé€šè¿‡å½“å‰è¯·æ±‚çš„`URL`æ‰¾åˆ°å¯¹åº”çš„`HandlerMethod`ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œåå°„çš„ä¸€ä¸ªä¾æ®ï¼‰ã€‚

 ğŸ·ï¸æ¥ç€åœ¨`doDispatch`æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œ`getHandlerAdapter`ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®ä¸Šé¢`getHandlerMapping`æ‰¾åˆ°ä¸ä¹‹å¯¹åº”çš„é€‚é…å™¨ï¼Œ
æ‰¾åˆ°é€‚é…å™¨ä¹‹åï¼Œæ‰§è¡Œé€‚é…å™¨çš„`handle`æ–¹æ³•ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•çš„è¯ä¼šå°è£…`Object[] args`(æ‰§è¡Œåå°„æ—¶æä¾›çš„å‚æ•°)ï¼Œå¹¶ä¸”ä¼šé€šè¿‡åå°„çš„æ–¹å¼ï¼ˆ`method.invoke`ï¼‰æ‰§è¡Œåˆ°å¯¹åº”çš„`Handler`æ–¹æ³•ã€‚

![image-20230912090704463](.\assets\image-20230912090704463.png)

## é…ç½®çš„åˆ†æ

> æŠ½è±¡ç±»çš„ç‰¹ç‚¹æ˜¯å•¥ï¼Œå¦‚æœé‡Œé¢æœ‰æŠ½è±¡æ–¹æ³•æˆ‘ä»¬éœ€è¦æ˜¯å®ç°å…¶æŠ½è±¡æ–¹æ³•
>
> ä½¿ç”¨æŠ½è±¡ç±»çš„æ—¶å€™ï¼Œé€šå¸¸æ˜¯è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯
>
> - ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨åˆ°å…¶éæŠ½è±¡æ–¹æ³•
> - éæŠ½è±¡æ–¹æ³•é‡Œä¼šè°ƒç”¨åˆ°æŠ½è±¡æ–¹æ³•
> - æˆ‘ä»¬æä¾›å…¶æŠ½è±¡æ–¹æ³•çš„å…·ä½“çš„å®ç°
>

è¿™ä¸ªæŠ½è±¡ç±»ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼Œè¿™ä¸ªæŠ½è±¡ç±»å®ç°äº†ä¸€ä¸ªæ¥å£

```java
public interface WebApplicationInitializer {
    void onStartup(ServletContext var1) throws ServletException;
}
```

è¿™ä¸ª`onStartup` æ–¹æ³•æ˜¯`AbstractAnnotationConfigDispatcherServletInitializer`ä¸­çš„æ ¸å¿ƒæ–¹æ³•

Tomcatåœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ä¼šåšä¸€ä»¶äº‹æƒ…ï¼Œæ‰«æä½ æ‰€æœ‰çš„ç±»ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®ç°`WebApplicationInitializer`æ¥å£çš„ç±»ï¼Œå¦‚æœæœ‰å®ç°è¿™ä¸ªæ¥å£çš„ç±»ï¼Œå°±ä¼šæ‰§è¡Œå…¶`onStartup`æ–¹æ³•

è¿™ä¸ª`onStartup`æ–¹æ³•å°±æ˜¯åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ–¹æ³•

`onStartup`æ–¹æ³•æ˜¯ä¸€ä¸ªéæŠ½è±¡çš„æ–¹æ³•

- åˆå§‹åŒ–`Listener`ï¼Œåˆå§‹åŒ–ä¸€ä¸ª`WebApplicationContext` æ”¾åœ¨ `ServletContext` ä¸­
  - è¿™ä¸ª`WebApplicationContext` åŠ è½½çš„ä¸æ˜¯xmlæ–‡ä»¶ï¼Œè€Œæ˜¯é…ç½®ç±»
  - é…ç½®ç±»çš„ä¿¡æ¯é€šè¿‡æ–¹æ³•æä¾› â†’ `getRootConfigClasses` æ–¹æ³•
  - `getRootConfigClasses` æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•
- åˆå§‹åŒ– `DispatcherServlet` ï¼Œåˆå§‹åŒ–ä¸€ä¸ª `WebApplicationContext`
  - è¿™ä¸ª `WebApplicationContext` åŠ è½½çš„ä¸æ˜¯xmlæ–‡ä»¶ï¼Œè€Œæ˜¯é…ç½®ç±»
  - é…ç½®ç±»çš„ä¿¡æ¯é€šè¿‡æ–¹æ³•æä¾› â†’ `getServletConfigClasses` æ–¹æ³•
  - `getServletConfigClasses` è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•

éœ€è¦æˆ‘ä»¬åœ¨æŠ½è±¡ç±»çš„å­ç±»ä¸­å»å†™è¿™ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•çš„å®ç° â†’ æä¾›è‡ªå®šä¹‰çš„é…ç½®ç±»

```java
public void onStartup(ServletContext servletContext) throws ServletException {
    super.onStartup(servletContext);// åˆå§‹åŒ–Listener â†’ åˆå§‹åŒ–ä¸€ä¸ªWebApplicationContextæ”¾åœ¨ServletContextä¸­
    this.registerDispatcherServlet(servletContext);// æ³¨å†ŒDispatcherServlet
}
```

```xml
public void onStartup(ServletContext servletContext) throws ServletException {
    this.registerContextLoaderListener(servletContext);
}
```

```java
protected void registerDispatcherServlet(ServletContext servletContext) {
    
    WebApplicationContext servletAppContext = this.createServletApplicationContext();
}
```

# é™æ€èµ„æºå¤„ç†

æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦åšé™æ€èµ„æºå¤„ç†

JavaEEé˜¶æ®µå¦‚æœå°†å›¾ç‰‡æ”¾åœ¨`webapp`ç›®å½•ï¼Œå®ƒä¼šç¼–è¯‘åˆ°webèµ„æºæ ¹ç›®å½•ï¼Œå›¾ç‰‡èƒ½è®¿é—®åˆ°ï¼›åº”ç”¨ç¨‹åºæ•´åˆSpringMVCä¹‹åï¼Œæ”¾åœ¨webèµ„æºæ ¹ç›®å½•çš„å›¾ç‰‡è®¿é—®ä¸åˆ°äº†ï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿ

- JavaEEé˜¶æ®µï¼Œç¼ºçœçš„servletæ˜¯`default` â†’ è¿™ä¸ªç¼ºçœçš„servletåšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®è¯·æ±‚æ‰¾ç›®å½•ä¸‹çš„é™æ€èµ„æº

  ![image-20230915141816199](.\assets\image-20230915141816199.png)

- SpringMVCè¿™é‡Œï¼Œç¼ºçœçš„`Servlet`æ˜¯`DispatcherServlet` â†’ `localhost:8080/banner.png`æ‰¾çš„æ˜¯`DispatcherServlet`è€Œä¸æ˜¯default

å¦‚æœæˆ‘ä»¬æä¾›äº†èƒ½å¤Ÿå¤„ç†`banner.png`è¿™æ ·çš„`Handler`ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå¤„ç†é™æ€èµ„æºã€‚

- SpringMVCæœ‰æä¾›å¯¹åº”çš„ç±»ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ¥é…ç½®
  - è‡ªå·±å†™çš„Handlerä»£ç å¯ä»¥å¤ç”¨ï¼Œä¸»è¦æä¾›çš„ç‰¹æ®Šç‚¹æ˜¯é™æ€èµ„æºè·¯å¾„å’Œæ˜ å°„

  - å¦‚ä¸‹ä»£ç ï¼šæ³¨æ„å¦‚ä½•è·å¾—æ–‡ä»¶åå­—çš„
  
  - ```JAVA
        @RequestMapping("fetch/*")
        public void fetch(HttpServletRequest request, HttpServletResponse response) throws IOException {
            String requestURI = request.getRequestURI();
            String image = requestURI.substring(requestURI.lastIndexOf("/") + 1);
            File file = new File(IMAGE_DIR, image);
            FileInputStream inputStream = new FileInputStream(file);
            ServletOutputStream outputStream = response.getOutputStream();
            byte[] bytes = new byte[1024];
            int len = 0;
            while ((len = inputStream.read(bytes)) != -1){
                outputStream.write(bytes,0,len);
            }
            inputStream.close();
        }
    ```
  
- æä¾›çš„æ˜¯`ResourceHandler `(æ¥å£`WebMvcConfigurer`æä¾›)
  
  - åšçš„äº‹æƒ…
  
    - å¤„ç†é™æ€èµ„æº
    - é…ç½®å…¶æ˜ å°„èŒƒå›´
  
  - è¯­æ³•ï¼š
  
    - `** `ä»£è¡¨å¤šçº§ä»»æ„url
    - æ–‡ä»¶è·¯å¾„çš„è¯­æ³•
  
    + â­ æœ¬åœ°æ–‡ä»¶è·¯å¾„ `file : æ–‡ä»¶è·¯å¾„` 
  
    + ç±»åŠ è½½è·¯å¾„ `classpathï¼šæ–‡ä»¶è·¯å¾„`
  
    + webèµ„æºæ ¹è·¯å¾„ `/ æ–‡ä»¶è·¯å¾„`
  

```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    // æ³¨å†ŒResourceHandlerä½¿ç”¨ResourceHandlerRegistry
    // addResourceHandleré…ç½®ResourceHandlerçš„æ˜ å°„èŒƒå›´
    // addResourceLocationså‘ŠçŸ¥å½“å‰ResourceHandlerä½ çš„èµ„æºæ–‡ä»¶å¤„äºä»€ä¹ˆä½ç½®
    // ** ä»£è¡¨å¤šçº§ä»»æ„url
    // localhost:8080/pic/banner.png
    // localhost:8080/pic/dlrb.jpg
    // location:
    // 1. / webèµ„æºè·¯å¾„
    // 2. classpath:/  ç±»åŠ è½½è·¯å¾„
    // 3. file:æ–‡ä»¶è·¯å¾„/  æ–‡ä»¶è·¯å¾„ â†’ å»ºè®®ï¼ˆè¦æ±‚ï¼‰ä½¿ç”¨çš„è·¯å¾„
    registry.addResourceHandler("/pic/**").addResourceLocations("/");
    registry.addResourceHandler("/pic2/**").addResourceLocations("classpath:/");
    registry.addResourceHandler("/pic3/**").addResourceLocations("file:D:/tmp/");
}
```

è¯¥æ–¹æ³•æ¥æºäº`WebMvcConfigurer`æ¥å£ï¼Œå¦‚æœä½ å®ç°é‡Œé¢çš„æ–¹æ³•ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨ç”Ÿæ•ˆã€‚

 ğŸ·ï¸`location`å†™çš„æ—¶å€™æ³¨æ„ï¼šæœ€åçš„ä½ç½®`/`ä¸è¦æ¼æ‰

**è®¿é—®é™æ€èµ„æºéœ€è¦æ„é€ çš„URL**ï¼š mappingæ˜ å°„çš„urlè¿™éƒ¨åˆ†å€¼ + é™æ€èµ„æºç›¸å¯¹äºlocationçš„ä½ç½®

![image-20230912090758002](.\assets\image-20230912090758002.png)

æ ¹æ®ä¸Šé¢çš„é…ç½®èƒ½å¦è®¿é—®åˆ°logo.png ï¼Ÿ å¯ä»¥

> localhost:8080/pic3/a/e/logo.png

å»ºè®®å¤§å®¶ä½¿ç”¨**æ–‡ä»¶è·¯å¾„**ï¼šåé¢æˆ‘ä»¬ä½¿ç”¨SpringBootåº”ç”¨ â†’ åº”ç”¨ç¨‹åºæ‰“åŒ…çš„æ—¶å€™æ˜¯jaråŒ…

# Filterå’ŒHandlerInterceptor

èµ·åˆ°æ‹¦æˆªå™¨åŠŸèƒ½çš„

## `Filter`

Filterå°±æ˜¯JavaEEé˜¶æ®µçš„Filter â†’ å®ç°Filteræ¥å£ â†’ `doFilter`ã€‚

Filteråœ¨SpringMVCé˜¶æ®µä»ç„¶æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼ŒFilterå’ŒSpringMVCä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆæ ·çš„å…³ç³»ï¼Ÿ

æœ¬è´¨ä¸Šå°±æ˜¯Filterå’ŒServletä¹‹é—´çš„å…³ç³»ï¼Œæ‰§è¡ŒSpringMVCçš„æ ¸å¿ƒ`DispatcherServlet`çš„`doDispatch`æ–¹æ³•ä¹‹å‰å…ˆå»æ‰§è¡Œçš„æ˜¯`Filter`çš„`doFilter`æ–¹æ³•ã€‚

åœ¨SpringMVCçš„è¿‡ç¨‹ä¸­ä½¿ç”¨`Filter`ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ä½¿ç”¨`Filter`æ¥å£ï¼Œå› ä¸ºç›´æ¥ä½¿ç”¨æœ‰å¯èƒ½å¯¼è‡´`Filter`é‡Œçš„`doFilter`æ–¹æ³•æ‰§è¡Œå¤šæ¬¡ï¼Œè¿™æ˜¯ç”±äºJAVAEEå®¹å™¨ï¼Œæ¯”å¦‚Tomcatå­˜åœ¨çš„é—®é¢˜å¯¼è‡´çš„ã€‚

SpringMVCç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±»`OncePerRequestFilter` å¯¹`doFilter`è¿›è¡Œäº†å°è£…ã€‚

è¯¥ç±»å®ç°äº†Filteræ¥å£é‡Œé¢åŒ…å«äº†`doFilter`æ–¹æ³•çš„å®ç°ï¼ˆéæŠ½è±¡æ–¹æ³•ï¼‰ï¼Œå®ƒåœ¨é‡Œé¢è°ƒç”¨äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³•`doFilterInternal`ï¼Œå®ƒå®ç°çš„è¿™ä¸ª`doFilter`ä¿è¯äº†`doFilterInternal`è¿™ä¸ªæ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

å¦‚æœè¦æä¾›æ‹¦æˆªå™¨ï¼Œåšä¸€äº›ä¸šåŠ¡çš„è¯ï¼Œä¸šåŠ¡ä»£ç å†™åœ¨`OncePerRequestFilter`çš„`doFilterInternal`

```java
public class CustomFilter extends OncePerRequestFilter {
    // èƒ½å¤Ÿä¿è¯doFilterInternalè¿™ä¸ªæ–¹æ³•åœ¨è¿™æ¬¡è¯·æ±‚ä¸­åªä¼šæ‰§è¡Œä¸€æ¬¡
    @Override
    protected void doFilterInternal(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain) throws ServletException, IOException {
        System.out.println("custom filter");
        filterChain.doFilter(httpServletRequest,httpServletResponse);
    }
}
```

```java
//AACDSIé‡Œçš„
@Override
protected Filter[] getServletFilters() {
    return new Filter[]{new CustomFilter()};
}
```

é…ç½®çš„è¿™ä¸ªFilterå®ƒçš„ä½œç”¨èŒƒå›´æ˜¯`/* `  (JavaEEé˜¶æ®µè®²çš„ â†’ æ‰€æœ‰)

## `HandlerInterceptor`

`Handler`çš„æ‹¦æˆªå™¨ï¼Œåœ¨`doDispatch`è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œåœ¨`Handler`æ‰§è¡Œä¹‹å‰åšçš„æ‹¦æˆªã€‚

ä¸€ä¸ª`Handler`æœ‰å¯èƒ½æœ‰å¤šä¸ª`HandlerInterceptor`ï¼Œå¦‚ä½•çŸ¥æ™“å½“å‰è¿™ä¸ªè¯·æ±‚å¯¹åº”çš„`HandlerInterceptor`æ˜¯å“ªä¸€ä¸ªæˆ–å“ªä¸€äº›å‘¢ï¼Ÿ

`HandlerMapping` å¸®æˆ‘ä»¬åšæ˜ å°„

![image-20230912090832459](.\assets\image-20230912090832459.png)

åˆ†æå‘é€ä¸åŒè¯·æ±‚çš„æ—¶å€™æ‰¾åˆ°çš„`Handler` å’Œ`HandlerInterceptor`

![image-20230912090847862](.\assets\image-20230912090847862.png)

`HandlerMapping` èµ·ä½œç”¨ â†’ `HandlerExecutionChain`å®ä¾‹

æ¯æ¬¡å‘é€è¯·æ±‚ï¼šéƒ½ä¼šç”Ÿæˆæ–°çš„`HandlerExecutionChain`çš„å®ä¾‹

- å°è£…äº†`Handler`
- å°è£…äº†å¤šä¸ª`HandlerInterceptor`

```java
HandlerExecutionChain mappedHandler = this.getHandler(processedRequest);
```

```java
public class HandlerExecutionChain {
    
    private final Object handler;
    @Nullable
    private HandlerInterceptor[] interceptors;
    @Nullable
    private List<HandlerInterceptor> interceptorList;
}
```

1. `HandlerInterceptor`æ˜¯è°
2. ä½œç”¨èŒƒå›´æ˜¯ä»€ä¹ˆ
   1. å¦‚æœæ²¡æœ‰`Handler`åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰`HandlerInterceptor`åŒ¹é…æˆåŠŸ
3. å¤šä¸ª`HandlerInterceptor`ä¹‹é—´çš„é¡ºåºæ˜¯ä»€ä¹ˆ

é…ç½®`HandlerInterceptor`

- å®ç°`HandlerInterceptor`æ¥å£
  - `preHandle` â†’ åœ¨`Handler`æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„ï¼Œè¿”å›å€¼ä¸º`boolean`
    - å¦‚æœè¿”å›å€¼ä¸º`true`åˆ™ç»§ç»­æµç¨‹
    - å¦‚æœè¿”å›å€¼ä¸º`false`åˆ™ä¸­æ–­æµç¨‹ï¼›ä¼šå»æ‰§è¡Œè¿”å›å€¼ä¸º`true`çš„éƒ¨åˆ†çš„`afterCompletion`
    - å¦‚æœæœ‰å¤šä¸ª`HandlerInterceptor`ï¼Œ`preHandle`æ–¹æ³•æ˜¯æ­£åºéå†
  - `Handler` â†’ é€šå¸¸å°±æ˜¯`Controller`ç»„ä»¶ä¸­çš„`Handler`æ–¹æ³•
  - `postHandle` â†’ åœ¨`Handler`ä¹‹åæ‰§è¡Œçš„
    -  â­å¦‚æœæ‰§è¡Œä¸åˆ°`Handler`ï¼ˆå‰é¢çš„`preHandle`è¿”å›å€¼ä¸º`false`ï¼‰ï¼Œé‚£ä¹ˆä¸€ä¸ª`postHandle`éƒ½æ‰§è¡Œä¸åˆ°
    - å¦‚æœèƒ½å¤Ÿæ‰§è¡Œåˆ°`Handler`å°±èƒ½å¤Ÿæ‰§è¡Œåˆ°å…¨éƒ¨çš„`postHandle`
    - å¦‚æœæœ‰å¤šä¸ª`HandlerInterceptor`ï¼Œ`postHandle`æ–¹æ³•æ˜¯å€’åºéå†
  - `afterCompletion` â†’ æ‰§è¡Œå®Œ`postHandle`ã€`preHandle` è¿”å›å€¼ä¸º`false`
    - æ‰§è¡Œå®Œ`postHandle`ä¹‹åæ‰§è¡Œ`afterCompletion`ï¼Œèƒ½å¤Ÿæ‰§è¡Œåˆ°å…¨éƒ¨çš„`afterCompletion`
    - `preHandle` è¿”å›å€¼ä¸º`false`çš„æ—¶å€™æ‰§è¡Œ`afterCompletion` çš„è¯ï¼Œ**æ‰§è¡Œçš„æ˜¯`preHandle`è¿”å›å€¼ä¸º`true`çš„éƒ¨åˆ†`afterCompletion`**
    - å¦‚æœæœ‰å¤šä¸ª`HandlerInterceptor`ï¼Œ`afterCompletion`æ–¹æ³•æ˜¯å€’åºéå†
- é…ç½®`HandlerInterceptor`ä»¥åŠå…¶ä½œç”¨èŒƒå›´
  - `WebMvcConfigurer` æ¥å£ä¸­çš„æ–¹æ³•ï¼š`getInterceptors`

å¼€å‘ï¼Œå’Œä¸Šé¢çš„ç¤ºæ„å›¾æ˜¯ä¸€è‡´çš„

```java
@RequestMapping("hello")
public String handler1() {
    System.out.println("Handler1");
    return "handler1";
}
@RequestMapping("hello/songge")
public String handler2() {
    System.out.println("Handler2");
    return "handler2";
}
@RequestMapping("goodbye")
public String handler3() {
    System.out.println("Handler3");
    return "handler3";
}
@RequestMapping("goodbye/xuejia")
public String handler4() {
    System.out.println("Handler4");
    return "handler4";
}
```

æä¾›`HandlerInterceptor`çš„å®ç°ç±»

```java
public class HandlerInterceptor1 implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        System.out.println("preHandle1");
        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        System.out.println("postHandle1");

    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        System.out.println("afterCompletion1");
    }
}
```

é…ç½®è¿™5ä¸ªHandlerInterceptor

```java
@Autowired
HandlerInterceptor handlerInterceptor1;

// HandlerInterceptorçš„å®ä¾‹ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨æ„é€ æ–¹æ³•åˆå§‹åŒ–ï¼›ä¹Ÿå¯ä»¥ä»å®¹å™¨ä¸­å–å‡º
@Override
public void addInterceptors(InterceptorRegistry registry) {
    //registry.addInterceptor(new HandlerInterceptor1()).addPathPatterns("/hello");
    registry.addInterceptor(handlerInterceptor1).addPathPatterns("/hello");
    registry.addInterceptor(new HandlerInterceptor2()).addPathPatterns("/hello/**");
    registry.addInterceptor(new HandlerInterceptor3()).addPathPatterns("/goodbye");
    registry.addInterceptor(new HandlerInterceptor4()).addPathPatterns("/goodbye/**");
    registry.addInterceptor(new HandlerInterceptor5());//.addPathPatterns("/**");
}
```

![image-20230912090909582](.\assets\image-20230912090909582.png)

```
preHandle4
preHandle5
Handler4
postHandle5
postHandle4
afterCompletion5
afterCompletion4
```

å¦‚æœå‘é€æŸä¸ªè¯·æ±‚ï¼Œèƒ½å¤Ÿæ‰¾åˆ°çš„`HandlerInterceptor`æœ‰5ä¸ªï¼Œ

å¦‚æœå…¶ä¸­ç¬¬å››ä¸ªHandlerInterceptorçš„preHandleè¿”å›å€¼ä¸ºfalseï¼Œé‚£ä¹ˆæ‰§è¡Œè¯·æ±‚å¦‚ä½•ï¼Ÿ 1234321

å¦‚æœå…¶ä¸­çš„2å’Œ5çš„preHandleæ‰§è¡Œå¯èƒ½ä¸ºfalseï¼Œé‚£ä¹ˆæ‰§è¡Œæƒ…å†µå¦‚ä½•å‘¢ï¼Ÿ121

å¦‚æœè¿™5ä¸ªå…¨ä¸ºtrue â†’ 123455432154321

å¦‚æœè¯´æ‰¾ä¸åˆ°å¯¹åº”çš„`Handler`ï¼Œé‚£ä¹ˆ`HandlerExecutionChain`çš„å€¼å°±ä¸º`null`ï¼Œå°±æ‰§è¡Œä¸åˆ°`HandlerInterceptor`ï¼›ä¹Ÿå°±æ˜¯åªæœ‰æœ‰å¯¹åº”çš„`Handler`çš„æƒ…å†µä¸‹æ‰æœ‰å¯èƒ½ä¼šæ‰§è¡Œåˆ°`HandlerInterceptor`

çœ‹ä¸€ç‚¹ç‚¹æºç 

```java
// æ­£åºéå†HandlerInterceptorçš„æ•°æ®ï¼Œéå†è¿‡ç¨‹ä¸­æ‰§è¡ŒHandlerInterceptorçš„preHandleï¼Œå¦‚æœpreHandleæ–¹æ³•æ‰§è¡Œçš„è¿”å›å€¼ä¸ºfalseï¼Œä¿ç•™ä¸€ä¸ªæ ‡è®°interceptorIndexï¼Œä¸­æ–­æµç¨‹ä¹‹å‰æ‰§è¡Œäº†afterCompletionæ–¹æ³•çš„è°ƒç”¨
if (!mappedHandler.applyPreHandle(processedRequest, response)) {
    return;
}
// preHandleåœ¨å®ƒå‰é¢è°ƒç”¨çš„
// æ‰§è¡ŒHandleræ–¹æ³•
mv = ha.handle(processedRequest, response, mappedHandler.getHandler());
// postHandleåœ¨å®ƒåé¢è°ƒç”¨çš„
mappedHandler.applyPostHandle(processedRequest, response, mv);
```

 æ­£åºéå†`HandlerInterceptor`çš„æ•°æ®ï¼Œéå†è¿‡ç¨‹ä¸­æ‰§è¡Œ`HandlerInterceptor`çš„`preHandle`ï¼Œå¦‚æœ`preHandle`æ–¹æ³•æ‰§è¡Œçš„è¿”å›å€¼ä¸º`false`ï¼Œä¿ç•™ä¸€ä¸ªæ ‡è®°`interceptorIndex`ï¼Œä¸­æ–­æµç¨‹ä¹‹å‰æ‰§è¡Œäº†`afterCompletion`æ–¹æ³•çš„è°ƒç”¨

```java
boolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception {
    HandlerInterceptor[] interceptors = this.getInterceptors();
    if (!ObjectUtils.isEmpty(interceptors)) {
        for(int i = 0; i < interceptors.length; this.interceptorIndex = i++) {
            HandlerInterceptor interceptor = interceptors[i];
            if (!interceptor.preHandle(request, response, this.handler)) {
                this.triggerAfterCompletion(request, response, (Exception)null);
                return false;
            }
        }
    }

    return true;
}
```

æ‰§è¡Œ`preHandle` è¿”å›å€¼ä¸º `true` çš„éƒ¨åˆ†çš„`afterCompletion` ï¼›å¦‚æœæ‰€æœ‰çš„`preHandle`è¿”å›å€¼éƒ½ä¸º `true` ï¼Œ`interceptorIndex=interceptors.length-1 `,éå†çš„å°±æ˜¯å…¨éƒ¨çš„ `afterCompletion`

```java
void triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, @Nullable Exception ex) throws Exception {
    HandlerInterceptor[] interceptors = this.getInterceptors();
    if (!ObjectUtils.isEmpty(interceptors)) {
        for(int i = this.interceptorIndex; i >= 0; --i) {
            HandlerInterceptor interceptor = interceptors[i];

            try {
                interceptor.afterCompletion(request, response, this.handler, ex);
            } catch (Throwable var8) {
                logger.error("HandlerInterceptor.afterCompletion threw exception", var8);
            }
        }
    }

}
```

```java
void applyPostHandle(HttpServletRequest request, HttpServletResponse response, @Nullable ModelAndView mv) throws Exception {
    HandlerInterceptor[] interceptors = this.getInterceptors();
    if (!ObjectUtils.isEmpty(interceptors)) {
        for(int i = interceptors.length - 1; i >= 0; --i) {
            HandlerInterceptor interceptor = interceptors[i];
            interceptor.postHandle(request, response, this.handler, mv);
        }
    }

}
```

`HandlerInterceptor`ä½¿ç”¨è¿‡ç¨‹ä¸­å…³æ³¨çš„å‡ ä¸ªé—®é¢˜ï¼š

- `HandlerInterceptor`æ˜¯è°
- `HandlerInterceptor`çš„ä½œç”¨èŒƒå›´æ˜¯ä»€ä¹ˆ
- å¤šä¸ª`HandlerInterceptor`çš„é¡ºåºæ˜¯ä»€ä¹ˆ
- `preHandle`è¿”å›å€¼ä¸º`true`æˆ–`false`çš„æ‰§è¡Œæƒ…å†µ

ç™»å½•æ¡ˆä¾‹ â†’ `HandlerInterceptor`æ¥åš

- æä¾›ä¸¤ä¸ªHandleræ–¹æ³•ï¼Œ/login   å’Œ /hello
- å¦‚æœæ²¡æœ‰ç™»å½•çš„æƒ…å†µä¸‹è®¿é—®helloï¼Œè¾“å‡ºâ€œno loginâ€ï¼ˆå¹¶ä¸æ˜¯åœ¨helloæ–¹æ³•ä¸­è¾“å‡ºï¼‰
- å¦‚æœå·²ç»é€šè¿‡loginè¯·æ±‚æ‰§è¡Œç™»å½•çš„è¯ï¼Œè®¿é—®hello è¾“å‡º hello world
- é™å®šä¸€ä¸ªè¦æ±‚ï¼Œ`HandlerInterceptor` çš„ä½œç”¨èŒƒå›´æ˜¯`/** `(é‡‡ç”¨é»˜è®¤ä½œç”¨èŒƒå›´å°±è¡Œ)

# å¼‚å¸¸å¤„ç†

åœ¨Handlerä¸­åˆ¶é€ å¼‚å¸¸ï¼Œåˆ©ç”¨å¼‚å¸¸å¤„ç†å™¨å“åº”jsonæ•°æ®ã€‚

å¦‚æœä¸åšå¼‚å¸¸å¤„ç†ï¼šä¸å‹å¥½ã€æœ‰å¯èƒ½æ³„éœ²ä¿¡æ¯ã€‚

## `HandlerExceptionResolver`ï¼ˆäº†è§£ï¼‰

`HandlerExceptionResolver`ï¼šå…¨å±€å¼‚å¸¸å¤„ç†å™¨

å¤„ç†å…¨å±€çš„å…¨éƒ¨å¼‚å¸¸

è¿”å›å€¼ä¸º`ModelAndView`

```java
/**
 * ç”Ÿæ•ˆï¼šåªéœ€è¦æ³¨å†Œåˆ°å®¹å™¨ä¸­å°±ç”Ÿæ•ˆ
 */
@Component
public class CustomHandlerExceptionResolver implements HandlerExceptionResolver {
    /**
     *
     * @param handler æŠ›å‡ºå¼‚å¸¸çš„Handler
     * @param exception HandleræŠ›å‡ºçš„å¼‚å¸¸
     * @return
     */
    @Override
    public ModelAndView resolveException(HttpServletRequest httpServletRequest,
                                         HttpServletResponse httpServletResponse,
                                         Object handler, Exception exception) {
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("/exception.jsp");
        // å¦‚æœæƒ³è¦å“åº”å­—ç¬¦ä¸²æˆ–Jsonå­—ç¬¦ä¸²å¯ä»¥ä¸ï¼Ÿå¯ä»¥ â†’ åˆ©ç”¨response
        return modelAndView;
    }
}
```

## `@ExceptionHandler `(å»ºè®®)

ç²¾å‡†å¼‚å¸¸å¤„ç†ï¼Œå¤„ç†çš„ç‰¹å®šç±»å‹çš„å¼‚å¸¸ã€‚

è¿”å›å€¼å¯ä»¥ä¸º`ModelAndView`ï¼Œä¹Ÿå¯ä»¥ä¸º`String`æˆ–`Json`å­—ç¬¦ä¸²

### ModelAndViewï¼ˆäº†è§£ï¼‰

```java
@ControllerAdvice
public class CustomExceptionControllerAdvice {
    
    /*@ExceptionHandler(ArithmeticException.class)
    public ModelAndView resolveArithmeticException(){
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("/exception.jsp");
        return modelAndView;
    }*/
    @ExceptionHandler(ArithmeticException.class)
    public String resolveArithmeticException(){
        
        return "/exception.jsp";//è¿”å›å€¼ä½œä¸ºModelAndViewä¸­çš„è§†å›¾å
    }
}
```

### å­—ç¬¦ä¸² æˆ–Jsonå­—ç¬¦ä¸²

æ–¹æ³•ä¸Šæˆ–ç±»ä¸Šå¢åŠ æ³¨è§£`@ResponseBody`,`@ControllerAdvice`

```java
//@ControllerAdvice
//@ResponseBody
@RestControllerAdvice //ä¸Šé¢ä¸¤ä¸ªæ³¨è§£çš„å’Œï¼Œæ„å‘³ç€é‡Œé¢çš„å…¨éƒ¨æ–¹æ³•å“åº”çš„éƒ½æ˜¯å­—ç¬¦ä¸²æˆ–Jsonå­—ç¬¦ä¸²
public class CustomExceptionControllerAdvice {

    /*@ExceptionHandler(ArithmeticException.class)
    public ModelAndView resolveArithmeticException(){
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("/exception.jsp");
        return modelAndView;
    }*/
    /*@ExceptionHandler(ArithmeticException.class)
    public String resolveArithmeticException(){

        return "/exception.jsp";//è¿”å›å€¼ä½œä¸ºModelAndViewä¸­çš„è§†å›¾å
    }*/

    @ExceptionHandler(ArithmeticException.class)
    //@ResponseBody
    public BaseRespVo resolveArithmeticException(){
        return BaseRespVo.fail("ç®—æœ¯å¼‚å¸¸ï¼");
    }
}
```

`@ExceptionHandler`æ³¨è§£çš„`value`å±æ€§æ˜¯æ•°ç»„`Class[] `

```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface ExceptionHandler {
    Class<? extends Throwable>[] value() default {};
}
```

åœ¨æ–¹æ³•çš„å½¢å‚ä¸­å¯ä»¥ç›´æ¥å†™æŠ›å‡ºçš„å¼‚å¸¸

```java
@ExceptionHandler(ArithmeticException.class)
//@ResponseBody
public BaseRespVo resolveArithmeticException(ArithmeticException exception){
    String message = exception.getMessage();//by zero
    return BaseRespVo.fail("ç®—æœ¯å¼‚å¸¸ï¼" + message);
}
```

# æ€»ç»“

`Servlet`ä¸­åŒ…å«`ApplicationContext`ï¼šæŸ¥çœ‹SpringMVCæ¶æ„ã€‚

## å…¥é—¨æ¡ˆä¾‹AACDSI

é‡Œé¢æœ‰4ä¸ªæ–¹æ³•

+ onStartupæ–¹æ³•ï¼šé€šè¿‡ServletContextListeneråˆå§‹åŒ–å®¹å™¨ï¼Œå¹¶ä¸”å°†å®¹å™¨æ”¾åœ¨ServletContextä¸­ï¼Œæ³¨å†ŒDispatcherServletï¼Œåˆ›å»ºå®¹å™¨ï¼Œå¹¶ä¸”ä»ServletContextä¸­å–å‡ºå®¹å™¨

+ getXxx

## ä½¿ç”¨

å½’æ ¹ç»“åº•éƒ½æ˜¯å¯¹JavaEEçš„å°è£…

## æ ¸å¿ƒæµç¨‹

### åˆå§‹åŒ–

### è¯·æ±‚

è¯·æ±‚å¤„ç†æµç¨‹

service â†’ doGet/doPost â†’ processRequest â†’ doService â†’ doDispatch â†’ handlerAdapter.handle(request,response,handler) â†’ method.invoke(instance,args)
